---
title: "background points - is more better?"
author: "Samantha Andrews"
output: 
  html_notebook: 
editor_options: 
  chunk_output_type: inline
---

# Overview
quick test to see what happens to distribution of env. variables if add more background points (is 10k enough or do I need more)

A note to anyone who might happen to stumble across this... I am a beginner in R and have had no exposure to similar languages. I don't know what I'm doing. The code herein is unlikely to be elegant and there are probably more efficient ways of running the code.

Built with 'r getRversion()'.

# Package dependencies
You can load them using the following code which uses a function called [ipak](https://gist.github.com/stevenworthington/3178163). 
Note this function checks to see if the packages are installed first.
The "include=FALSE" supresses the package installation text appearing in the document...
```{r pre-install packages, include=FALSE}
packages <- c("ncdf4", "raster", "ggplot2") 
source("../src/ipak.R")
ipak(packages)
```

load one of the raw background.csv files to randomly extract points from (note that these files do not include presence cells, but will do for this test)

```{r}
testbglist <- read.csv("../output/bio/background/raw/2006.2.csv", header = TRUE)
head(testbglist)
```

Now create a bunch of dataframes with different no of random cells selected

SAM - A BETTER WAY WOULD HAVE BEEN TO RUN THE LOOP ON ALL THE POINTS, THEN RANDOMLY SELECT (QUICKER)

```{r}
testbk10000 <- testbglist[sample(nrow(testbglist), 10000), ]  #where 10000 = number of rows to sample (large sample as per maxent)
testbk20000 <- testbglist[sample(nrow(testbglist), 20000), ]  
testbk30000 <- testbglist[sample(nrow(testbglist), 30000), ]  
testbk50000 <- testbglist[sample(nrow(testbglist), 50000), ]  
testbk100000 <- testbglist[sample(nrow(testbglist), 100000), ]  
testbk190000 <- testbglist[sample(nrow(testbglist), 190000), ]  
```



# this test will use a shorter dataset and a smaller number of netcdfs
# the inefficent loop



This loop runs through the netcdf files and then looks for which rows in data_aea it should extract the value to point from, and at what depth (netcDF layer)

```{r}
strt <- Sys.time() #get the start time

xy <- testbk190000[ ,c("longitude_","latitude_m")] # This is to tell R where the coordinates are. Note that the column order needs to be longitude, latitude
testbk190000sp <- SpatialPointsDataFrame(coords = xy, data = testbk190000, proj4string = CRS("+proj=aea +lat_1=50 +lat_2=70 +lat_0=40 +lon_0=-60 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs")) # The CRS is used here is for the albers equal area projection.


netcdf_list <- list.files("../data/bktstncdf", pattern = '*.nc', full.names = TRUE) #true means the full path is included
no_netcdf <- length(netcdf_list) #for the loop - need to know how many files to cycle through
netcdf_name <- list.files("../data/bktstncdf", pattern = '*.nc', full.names = FALSE) #false means the path is not included
aea <- raster("../output/env/aea.tif") 
yr <- 2007  # a variable for the observation year
mth <- 10  # a variable for the observation month

for (i in 1:no_netcdf) {  
  print(netcdf_name[i]) #this just prints the name of the netCDF R is working one
  brkyr <- as.integer(sapply(strsplit(netcdf_name[i], "_"), "[[", 1)) # extracting the first part of the netcdf filename (which is the year)
  brkmth <- as.integer(sapply(strsplit(netcdf_name[i], "_"), "[[", 2)) # extracting the second part of the netcdf filename (which is the month)
  brkvar <- (sapply(strsplit(netcdf_name[i], "_"), "[[", 3)) # extracting the third part of the netcdf (inc.nc)
  temp_brick <- brick(netcdf_list[i], lvar = 4)
  temp_brick <- projectRaster(temp_brick, aea) 
    for (j in 1:nrow(testbk190000sp)) {  
      de <- testbk190000sp$depthlayerno[[j]]  # a variable for the observation depth layer
          if (brkyr == yr & brkmth == mth & brkvar == "temp.nc"){
              testbk190000sp$temp_surface[j] <- extract(x=temp_brick[[1]], y = testbk190000sp[j, ]) 
              if (is.na(de)){
                testbk190000sp$temp_depth[j] <- NA
              } else  
                testbk190000sp$temp_depth[j] <- extract(x=temp_brick[[de]], y = testbk190000sp[j, ])
          } else if (brkyr == yr & brkmth == mth & brkvar == "salinity.nc") {
              testbk190000sp$salinity_surface[j] <- extract(x=temp_brick[[1]], y = testbk190000sp[j, ]) 
              if (is.na(de)){
                testbk190000sp$salinity_depth[j] <- NA
              } else  
                testbk190000sp$salinity_depth[j] <- extract(x=temp_brick[[de]], y = testbk190000sp[j, ]) 
          } else if (brkyr == yr & brkmth == mth & brkvar == "chl.nc") {
              testbk190000sp$chl_surface[j] <- extract(x=temp_brick[[1]], y = testbk190000sp[j, ]) 
              if (is.na(de)){
                testbk190000sp$chl_depth[j] <- NA
              } else  
                testbk190000sp$chl_depth[j] <- extract(x=temp_brick[[de]], y = testbk190000sp[j, ]) 
          } else if (brkyr == yr & brkmth == mth & brkvar == "o2.nc") {
              testbk190000sp$o2_surface[j] <- extract(x=temp_brick[[1]], y = testbk190000sp[j, ]) 
              if (is.na(de)){
                testbk190000sp$o2_depth[j] <- NA
              } else  
                testbk190000sp$o2_depth[j] <- extract(x=temp_brick[[de]], y = testbk190000sp[j, ]) 
          } else if (brkyr == yr & brkmth == mth & brkvar == "mlp.nc") {
              testbk190000sp$mlp_surface[j] <- extract(x=temp_brick[[1]], y = testbk190000sp[j, ])
          } else if (brkyr == yr & brkmth == mth & brkvar == "ssh.nc") {
              testbk190000sp$ssh_surface[j] <- extract(x=temp_brick[[1]], y = testbk190000sp[j, ]) 
            
          }
     
    }
}
write.csv(testbk190000sp, "../data/testbk190000output.csv", row.names = FALSE)
#test_back_df <- as.data.frame(testbk100000sp)
#head(test_back_df)
print(Sys.time()-strt) #time it took to run
```


plot each variable against the different no of backgrounn points

```{r}
test10000 <- as.data.frame(testbk10000sp)
test20000 <- as.data.frame(testbk20000sp)
test50000 <- as.data.frame(testbk50000sp)
test100000 <- as.data.frame(testbk10000sp)

```

```{r}
ggplot(test10000, aes(x = ssh_surface)) + geom_density(na.rm = TRUE, colour = "red") + geom_density(data=test20000 , na.rm = TRUE, colour = "blue") + geom_density(data=test50000 , na.rm = TRUE, colour = "green") + geom_density(data=test100000 , na.rm = TRUE, colour = "orange")
dev.copy(png,"../data/ssh_back_no.png") # to automatically save the plot to a png AND show it inline
dev.off() # stops automatic saving of the plot to a png

ggplot(test10000, aes(x = mlp_surface)) + geom_density(na.rm = TRUE, colour = "red") + geom_density(data=test20000 , na.rm = TRUE, colour = "blue") + geom_density(data=test50000 , na.rm = TRUE, colour = "green") + geom_density(data=test100000 , na.rm = TRUE, colour = "orange")
dev.copy(png,"../data/mlp_back_no.png") # to automatically save the plot to a png AND show it inline
dev.off() # stops automatic saving of the plot to a png

ggplot(test10000, aes(x = temp_surface)) + geom_density(na.rm = TRUE, colour = "red") + geom_density(data=test20000 , na.rm = TRUE, colour = "blue") + geom_density(data=test50000 , na.rm = TRUE, colour = "green") + geom_density(data=test100000 , na.rm = TRUE, colour = "orange")
dev.copy(png,"../data/temp_surface_back_no.png") # to automatically save the plot to a png AND show it inline
dev.off() # stops automatic saving of the plot to a png

ggplot(test10000, aes(x = temp_depth)) + geom_density(na.rm = TRUE, colour = "red") + geom_density(data=test20000 , na.rm = TRUE, colour = "blue") + geom_density(data=test50000 , na.rm = TRUE, colour = "green") + geom_density(data=test100000 , na.rm = TRUE, colour = "orange")
dev.copy(png,"../data/temp_depth_back_no.png") # to automatically save the plot to a png AND show it inline
dev.off() # stops automatic saving of the plot to a png

ggplot(test10000, aes(x = salinity_surface)) + geom_density(na.rm = TRUE, colour = "red") + geom_density(data=test20000 , na.rm = TRUE, colour = "blue") + geom_density(data=test50000 , na.rm = TRUE, colour = "green") + geom_density(data=test100000 , na.rm = TRUE, colour = "orange")
dev.copy(png,"../data/salinity_surface_back_no.png") # to automatically save the plot to a png AND show it inline
dev.off() # stops automatic saving of the plot to a png

ggplot(test10000, aes(x = salinity_depth)) + geom_density(na.rm = TRUE, colour = "red") + geom_density(data=test20000 , na.rm = TRUE, colour = "blue") + geom_density(data=test50000 , na.rm = TRUE, colour = "green") + geom_density(data=test100000 , na.rm = TRUE, colour = "orange")
dev.copy(png,"../data/salinity_depth_back_no.png") # to automatically save the plot to a png AND show it inline
dev.off() # stops automatic saving of the plot to a png

ggplot(test10000, aes(x = chl_surface)) + geom_density(na.rm = TRUE, colour = "red") + geom_density(data=test20000 , na.rm = TRUE, colour = "blue") + geom_density(data=test50000 , na.rm = TRUE, colour = "green") + geom_density(data=test100000 , na.rm = TRUE, colour = "orange")
dev.copy(png,"../data/chl_surface_back_no.png") # to automatically save the plot to a png AND show it inline
dev.off() # stops automatic saving of the plot to a png

ggplot(test10000, aes(x = chl_depth)) + geom_density(na.rm = TRUE, colour = "red") + geom_density(data=test20000 , na.rm = TRUE, colour = "blue") + geom_density(data=test50000 , na.rm = TRUE, colour = "green") + geom_density(data=test100000 , na.rm = TRUE, colour = "orange")
dev.copy(png,"../data/chl_depth_back_no.png") # to automatically save the plot to a png AND show it inline
dev.off() # stops automatic saving of the plot to a png

ggplot(test10000, aes(x = o2_surface)) + geom_density(na.rm = TRUE, colour = "red") + geom_density(data=test20000 , na.rm = TRUE, colour = "blue") + geom_density(data=test50000 , na.rm = TRUE, colour = "green") + geom_density(data=test100000 , na.rm = TRUE, colour = "orange")
dev.copy(png,"../data/o2_surface_back_no.png") # to automatically save the plot to a png AND show it inline
dev.off() # stops automatic saving of the plot to a png

ggplot(test10000, aes(x = o2_depth)) + geom_density(na.rm = TRUE, colour = "red") + geom_density(data=test20000 , na.rm = TRUE, colour = "blue") + geom_density(data=test50000 , na.rm = TRUE, colour = "green") + geom_density(data=test100000 , na.rm = TRUE, colour = "orange")
dev.copy(png,"../data/o2_depth_back_no.png") # to automatically save the plot to a png AND show it inline
dev.off() # stops automatic saving of the plot to a png
```

