---
title: "plots for paper"
author: "Samantha Andrews"
output: html_notebook
---

# Overview
A note to anyone who might happen to stumble across this... I am a beginner in R and have had no exposure to similar languages. I don't know what I'm doing. The code herein is unlikely to be elegant and there area probably more efficient ways of running the code.

Built with 'r getRversion()'..

# Package dependencies
You can install and load them using the following code which uses a function called [ipak](https://gist.github.com/stevenworthington/3178163). Note this function checks to see if the packages are installed first before loading.


```{r pre-install & load packages, include=FALSE}
packages <- c("stringr", "reshape2", "ggplot2", "Hmisc", "viridis", "raster", "RColorBrewer", "cowplot")
source("../src/ipak.R")
ipak(packages)
```



# stacked permutation importance plot and jacknife plots

```{r create permutation & jack data}
maxr_lst <- list.files("../output/maxent/models/", pattern = "maxentresults.csv", full.names = TRUE)
maxr_lst <- maxr_lst[-4] #removing january because this month has slightly different variables than the others
perm <- data.frame(matrix(ncol = 10, nrow = length(maxr_lst)))
colnames(perm) <- c("Month", "amo_sample", "amo_winter", "chl_surface", "nao_prev", "nao_sample", "nao_winter", "o2_depth", "salinity_depth", "temp_depth")
jack <- data.frame(matrix(ncol = 10, nrow = length(maxr_lst)))
colnames(jack) <- c("Month", "amo_sample", "amo_winter", "chl_surface", "nao_prev", "nao_sample", "nao_winter", "o2_depth", "salinity_depth", "temp_depth")

for (m in 1:length(maxr_lst)){
  maxr <- read.csv(maxr_lst[m])
  mth <- str_sub(maxr_lst[m], start = 25, end = 27) #selects the month from the filename
  perm$Month[m] <- mth
  jack$Month[m] <- mth
  maxt <- tail(maxr, 1)
  perm$amo_sample[m] <- maxt$amo_sample.permutation.importance
  perm$amo_winter[m] <- maxt$amo_winter.permutation.importance
  perm$chl_surface[m] <- maxt$chl_surface.permutation.importance
  perm$nao_prev[m] <- maxt$nao_prev.permutation.importance
  perm$nao_sample[m] <- maxt$nao_sample.permutation.importance
  perm$nao_winter[m] <- maxt$nao_winter.permutation.importance
  perm$o2_depth[m] <- maxt$o2_depth.permutation.importance
  perm$salinity_depth[m] <- maxt$salinity_depth.permutation.importance
  perm$temp_depth[m] <- maxt$temp_depth.permutation.importance

  jack$amo_sample[m] <- maxt$Training.gain.without.amo_sample
  jack$amo_winter[m] <- maxt$Training.gain.without.amo_winter
  jack$chl_surface[m] <- maxt$Training.gain.without.chl_surface
  jack$nao_prev[m] <- maxt$Training.gain.without.nao_prev
  jack$nao_sample[m] <- maxt$Training.gain.without.nao_sample
  jack$nao_winter[m] <- maxt$Training.gain.without.nao_winter
  jack$o2_depth[m] <- maxt$Training.gain.without.o2_depth
  jack$salinity_depth[m] <- maxt$Training.gain.without.salinity_depth
  jack$temp_depth[m] <- maxt$Training.gain.without.temp_depth
}


mthord <- c("mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec") # a list of months to order by
permu <- perm[match(mthord, perm$Month), ] #reorder based on mthord
jackk <- jack[match(mthord, jack$Month), ] #reorder based on mthord

#rename the months so they are capitalised
permu$Month <- capitalize(permu$Month)
jackk$Month <- capitalize(jackk$Month)


#rename the col names so they are capitalised and shortened
colnames(permu)[colnames(permu)=="amo_sample"] <- "AMO_Sample"
colnames(permu)[colnames(permu)=="amo_winter"] <- "AMO_Winter"
colnames(permu)[colnames(permu)=="chl_surface"] <- "Chl_Surface"
colnames(permu)[colnames(permu)=="nao_prev"] <- "NAO_Prev"
colnames(permu)[colnames(permu)=="nao_sample"] <- "NAO_Sample"
colnames(permu)[colnames(permu)=="nao_winter"] <- "NAO_Winter"
colnames(permu)[colnames(permu)=="o2_depth"] <- "O2_Depth"
colnames(permu)[colnames(permu)=="salinity_depth"] <- "Salinity_Depth"
colnames(permu)[colnames(permu)=="temp_depth"] <- "Temp_Depth"

colnames(jackk)[colnames(jackk)=="amo_sample"] <- "AMO_Sample"
colnames(jackk)[colnames(jackk)=="amo_winter"] <- "AMO_Winter"
colnames(jackk)[colnames(jackk)=="chl_surface"] <- "Chl_Surface"
colnames(jackk)[colnames(jackk)=="nao_prev"] <- "NAO_Prev"
colnames(jackk)[colnames(jackk)=="nao_sample"] <- "NAO_Sample"
colnames(jackk)[colnames(jackk)=="nao_winter"] <- "NAO_Winter"
colnames(jackk)[colnames(jackk)=="o2_depth"] <- "O2_Depth"
colnames(jackk)[colnames(jackk)=="salinity_depth"] <- "Salinity_Depth"
colnames(jackk)[colnames(jackk)=="temp_depth"] <- "Temp_Depth"


write.csv(permu, "../output/maxent/models/permutation_avg.csv", row.names = FALSE)
write.csv(jackk, "../output/maxent/models/jack_avg.csv", row.names = FALSE)

```

```{r create jacknife plots}
maxr_lst <- list.files("../output/maxent/models/", pattern = "maxentresults.csv", full.names = TRUE)
maxr_lst <- maxr_lst[-4] #removing january because this month has slightly different variables than the others
jack_df <- list()


for (m in 1:length(maxr_lst)){
  res <- read.csv(maxr_lst[m], header = TRUE)
  mth <- str_sub(maxr_lst[m], start = 25, end = 27) #selects the month from the filename
  mth <- capitalize(mth)
  res_df <- tail(res, 1)
  var_df <- res_df[,c(grep("Training.gain.with*",names(res_df)))]
  var_df$id <- 1:nrow(var_df)
  var_df <- melt(var_df, id.vars=c("id"))
  jack_with <- var_df[grep("with.only",var_df$variable),]
  jack_with$Type_of_Run <- "With only the variable"
  jack_without <- var_df[grep("without",var_df$variable),]
  jack_without$Type_of_Run <- "Without the variable"
  gain_all <- res_df[c(grep("Regularized.",names(res_df)))]
  gain_all$id <- 1:nrow(gain_all)
  gain_all <- melt(gain_all, id.vars=c("id"))
  gain_all$Type_of_Run <- "With all variables"
  gain_all$variable <- "all_variables"
  jack_table <- rbind(jack_with,jack_without,gain_all)
  jack_table$state <- mth 
  

  jack_table$variable <- gsub(".*[.]","",jack_table$variable)
  jack_table$variable <- gsub("amo_sample", "AMO_Sample", jack_table$variable)
  jack_table$variable <- gsub("amo_winter", "AMO_Winter", jack_table$variable)
  jack_table$variable <- gsub("chl_surface", "Chl_Surface", jack_table$variable)
  jack_table$variable <- gsub("nao_prev", "NAO_prev", jack_table$variable)
  jack_table$variable <- gsub("nao_sample", "NAO_Sample", jack_table$variable)
  jack_table$variable <- gsub("nao_winter", "NAO_Winter", jack_table$variable)
  jack_table$variable <- gsub("o2_depth", "O2_Depth", jack_table$variable)
  jack_table$variable <- gsub("salinity_depth", "Salinity_Depth", jack_table$variable)
  jack_table$variable <- gsub("temp_depth", "Temp_Depth", jack_table$variable)

  jack_df[[m]] <- jack_table
  
}

var_jack <- do.call(rbind, jack_df)

var_jack$state <- factor(var_jack$state,levels=c("Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))
var_jack$Type_of_Run <- factor(var_jack$Type_of_Run,levels=c("With all variables", "Without the variable","With only the variable"))
a <- subset(var_jack, state == "Mar" | state == "Apr" |state == "May" | state == "Jun" | state == "Jul")
b <- subset(var_jack, state == "Aug" | state == "Sep" |state == "Oct" | state == "Nov" | state == "Dec")


plotlst <- list(a, b)

color_type_1 <- c("#081d58", "#999999","#1d91c0")
varpos <- c("Temp_Depth", "Salinity_Depth", "O2_Depth", "Chl_Surface", "NAO_Sample", "NAO_Prev", "NAO_Winter", "AMO_Sample", "AMO_Winter")

for (p in 1:length(plotlst)){
  pt <- p
  dev.new()
  jack <- ggplot(plotlst[[p]], aes(variable,value))+
  geom_bar(aes(fill=Type_of_Run),position="dodge",stat="identity")+ coord_flip()+ facet_grid(state~., scales="free", space = "free")+
  theme_bw(14)+
  scale_fill_manual(values=color_type_1,guide=guide_legend(reverse=FALSE))+
  theme(axis.text=element_text(size=8)) +
  theme(legend.title=element_blank())+
  theme(legend.position="top")+
  theme(strip.text=element_text(size=12))+
  theme(strip.text.y = element_text(angle = 0)) +
  labs(x="Variable",y="Jackknife of Regularized Training Gain")
  ggsave(filename = paste0("../output/maxent/paper_plots/jackknife_plot_", pt, ".png"), plot = jack, dpi = 900, height = 9, width = 7)
  dev.off()
}

```

```{r permulation plot}
permelt <- melt(permu, id = "Month") #need to melt the data into this format for ggplot
perpl <- ggplot(data = permelt, aes(x = Month, y = value, fill = variable)) + geom_bar(stat = "identity") +  scale_fill_viridis_d(direction = -1)
png("../output/maxent/paper_plots/permutation_plot.png")
print(perpl)
dev.off()
```

# plot median probability by depth


```{r get median probability for each depth}
mthord <- c("mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec") 

meddf <- data.frame(matrix(ncol = 3, nrow = 490))
colnames(meddf) <- c("layer", "month", "median")
r <- 1

for (m in 1:length(mthord)){
  mth <- mthord[m]
  mthlst <- list.files(paste0("../output/maxent/predictions/", mth), pattern = "^avg_cloglog.*.asc", full.names = TRUE)
  rstk <- stack(mthlst)
  rsum <- summary(rstk, na.rm = TRUE)
  rsum <- rsum["Median", ]
  for (l in 1:length(rsum)){
    meddf$median[r] <- rsum[l]
    meddf$month[r] <- mth
    meddf$layer[r] <- names(rstk[[l]])
    r <- r+1
  }
}

#rename the layers to be just the depth

meddf$layer <- gsub("avg_cloglog_", "", x = meddf$layer)
meddf <- meddf[order(meddf$layer), ]

write.csv(meddf, paste0("../output/maxent/paper_plots/med_data/median.csv"), row.names = FALSE)
```

```{r}
a <- ggplot(data = meddf) + geom_point(aes(y = layer, x = median, colour = month))
a

```

```{r get max probability for each depth}
mthord <- c("mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec") 

meddf <- data.frame(matrix(ncol = 3, nrow = 490))
colnames(meddf) <- c("layer", "month", "max")
r <- 1

for (m in 1:length(mthord)){
  mth <- mthord[m]
  mthlst <- list.files(paste0("../output/maxent/predictions/", mth), pattern = "^avg_cloglog.*.asc", full.names = TRUE)
  rstk <- stack(mthlst)
  rsum <- summary(rstk, na.rm = TRUE)
  rsum <- rsum["Max.", ]
  for (l in 1:length(rsum)){
    meddf$max[r] <- rsum[l]
    meddf$month[r] <- mth
    meddf$layer[r] <- names(rstk[[l]])
    r <- r+1
  }
}

#rename the layers to be just the depth

meddf$layer <- gsub("avg_cloglog_", "", x = meddf$layer)
meddf$layer <- as.numeric(meddf$layer)
meddf <- meddf[order(meddf$layer), ]

write.csv(meddf, paste0("../output/maxent/paper_plots/med_data/max.csv"), row.names = FALSE)
```

```{r}
a <- ggplot(data = meddf) + geom_point(aes(y = layer, x = max, colour = month))
a
```

#Histograms of probability by depth

count number of cells that are not NA in each raster layer that are inside the mcp

```{r}
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis

clogasc_list <- list.files(paste0("../output/maxent/predictions/dec"), pattern = "^avg_cloglog_.*.asc", full.names = TRUE) #just choose a random month to calculate cells
cumst <- data.frame(0, 0)
colnames(cumst) <- c("depth", "no_cells")
for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[6])
  ascname <- names(cumasc)
  cumst[cum, 1] <- str_sub(ascname, 13)
  cumasc2 <- raster::mask(cumasc, outsidemcp, inverse = TRUE)
  ccnt <- freq(cumasc2, useNA='no')
  ccnt <- sum(ccnt[ ,2])
  cumst[cum, 2] <- ccnt
}

cumst$depth <- as.numeric(cumst$depth)
cumst1 <- cumst[order(cumst$no_cells), ]

write.csv(cumst1, "../output/maxent/paper_plots/prob_by_depth/cellsperlayermar.csv", row.names = FALSE)

```

first bin the probabilities for cells inside the mcp

```{r bin probabilities}
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
mthord <- c("dec") #"mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", 

for (m in 1:length(mthord)){
  mth <- mthord[m]
  clogasc_list <- list.files(paste0("../output/maxent/predictions/", mth), pattern = "^avg_cloglog.*.asc", full.names = TRUE)
  
  binprob <- function(x){
    ifelse(x > 0 & x < 0.1, 0.1,
    ifelse(x <= 0, 0, NA))
  }
  
  for (cum in 1:length(clogasc_list)){
    cumasc <- raster(clogasc_list[cum])
    ascname <- names(cumasc)
    cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
    probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
    writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_1_avgprob_", ascname, ".asc"), overwrite = TRUE)
    plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_1_avgprob_", ascname, ".png")), overwrite = TRUE)
    dev.off() # stops automatic saving of the plot to a png
  }
  
  
  
  binprob <- function(x){
    ifelse(x >= 0.1 & x < 0.2, 0.2,
    ifelse(x <= 0, 0, NA))
  }
  
  for (cum in 1:length(clogasc_list)){
    cumasc <- raster(clogasc_list[cum])
    ascname <- names(cumasc)
    cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
    probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
    writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_2_avgprob_", ascname, ".asc"), overwrite = TRUE)
    plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_2_avgprob_", ascname, ".png")), overwrite = TRUE)
    dev.off() # stops automatic saving of the plot to a png
  }
  
  binprob <- function(x){
    ifelse(x >= 0.2 & x < 0.3, 0.3,
    ifelse(x <= 0, 0, NA))
  }
  
  for (cum in 1:length(clogasc_list)){
    cumasc <- raster(clogasc_list[cum])
    ascname <- names(cumasc)
    cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
    probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
    writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_3_avgprob_", ascname, ".asc"), overwrite = TRUE)
    plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_3_avgprob_", ascname, ".png")), overwrite = TRUE)
    dev.off() # stops automatic saving of the plot to a png
  }
  
  
  binprob <- function(x){
    ifelse(x >= 0.3 & x < 0.4, 0.4,
    ifelse(x <= 0, 0, NA))
  }
  
  for (cum in 1:length(clogasc_list)){
    cumasc <- raster(clogasc_list[cum])
    ascname <- names(cumasc)
    cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
    probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
    writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_4_avgprob_", ascname, ".asc"), overwrite = TRUE)
    plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_4_avgprob_", ascname, ".png")), overwrite = TRUE)
    dev.off() # stops automatic saving of the plot to a png
  }
  
  
  
  binprob <- function(x){
    ifelse(x >= 0.4 & x < 0.5, 0.5,
    ifelse(x <= 0, 0, NA))
  }
  
  for (cum in 1:length(clogasc_list)){
    cumasc <- raster(clogasc_list[cum])
    ascname <- names(cumasc)
    cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
    probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
    writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_5_avgprob_", ascname, ".asc"), overwrite = TRUE)
    plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_5_avgprob_", ascname, ".png")), overwrite = TRUE)
    dev.off() # stops automatic saving of the plot to a png
  }
   
  
  binprob <- function(x){
    ifelse(x >= 0.5 & x < 0.6, 0.6,
    ifelse(x <= 0, 0, NA))
  }
  
  for (cum in 1:length(clogasc_list)){
    cumasc <- raster(clogasc_list[cum])
    ascname <- names(cumasc)
    cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
    probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
    writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_6_avgprob_", ascname, ".asc"), overwrite = TRUE)
    plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_6_avgprob_", ascname, ".png")), overwrite = TRUE)
    dev.off() # stops automatic saving of the plot to a png
  } 
  
  
  
  binprob <- function(x){
    ifelse(x >= 0.6 & x < 0.7, 0.7,
    ifelse(x <= 0, 0, NA))
  }
  
  for (cum in 1:length(clogasc_list)){
    cumasc <- raster(clogasc_list[cum])
    ascname <- names(cumasc)
    cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
    probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
    writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_7_avgprob_", ascname, ".asc"), overwrite = TRUE)
    plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_7_avgprob_", ascname, ".png")), overwrite = TRUE)
    dev.off() # stops automatic saving of the plot to a png
  }
  
  
  binprob <- function(x){
    ifelse(x >= 0.7 & x < 0.8, 0.8,
    ifelse(x <= 0, 0, NA))
  }
  
  for (cum in 1:length(clogasc_list)){
    cumasc <- raster(clogasc_list[cum])
    ascname <- names(cumasc)
    cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
    probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
    writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_8_avgprob_", ascname, ".asc"), overwrite = TRUE)
    plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_8_avgprob_", ascname, ".png")), overwrite = TRUE)
    dev.off() # stops automatic saving of the plot to a png
  }
  
  
  binprob <- function(x){
    ifelse(x >= 0.8 & x < 0.9, 0.9,
    ifelse(x <= 0, 0, NA))
  }
  
  for (cum in 1:length(clogasc_list)){
    cumasc <- raster(clogasc_list[cum])
    ascname <- names(cumasc)
    cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
    probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
    writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_9_avgprob_", ascname, ".asc"), overwrite = TRUE)
    plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_9_avgprob_", ascname, ".png")), overwrite = TRUE)
    dev.off() # stops automatic saving of the plot to a png
  }
  
  
  binprob <- function(x){
    ifelse(x >= 0.9 & x <= 1, 1,
    ifelse(x <= 0, 0, NA))
  }
  
  for (cum in 1:length(clogasc_list)){
    cumasc <- raster(clogasc_list[cum])
    ascname <- names(cumasc)
    cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
    probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
    writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_10_avgprob_", ascname, ".asc"), overwrite = TRUE)
    plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_binned_10_avgprob_", ascname, ".png")), overwrite = TRUE)
    dev.off() # stops automatic saving of the plot to a png
  }
}
```


get data to plot probability by depth... 
```{r}
mthord <- c("mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")
binlst <- c(1:10)

binprob <- function(x){
  ifelse(x >0,  1,
  ifelse(x == -9999, 0, NA))
}


for (m in 1:length(mthord)){
  for (b in 1:length(binlst)){
    mth <- mthord[m]
    bin <- binlst[b]
    # mth <- "dec"
    # bin <- 1
  ascdepth <- list.files(paste0("../output/maxent/paper_plots/prob_by_depth"), pattern = paste0("^", mth, "_binned_", bin, "_avg.*asc"), full.names = TRUE)

  binaryavgstack <- stack(ascdepth)
  stackstathigh <- data.frame(matrix(ncol = 2, nrow = nlayers(binaryavgstack)))
  stackstathigh[ ,1] <- c(1:49)
  colnames(stackstathigh) <- c("asclayer", "prob_bin")
  
  for (lyr in 1:nlayers(binaryavgstack)){
    ascname <-  str_sub(ascdepth[lyr], 77, -5)
    dlay <- binaryavgstack[[lyr]]
    dlay <- calc(dlay, fun = binprob) #creates raster layer with cell values based on the binprob function
    lyrsum <- cellStats(dlay, sum)
    stackstathigh$prob_bin[lyr] <- lyrsum
    stackstathigh$asclayer[lyr] <- ascname
  
  }
  write.csv(stackstathigh, paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_probbin_", bin, "_cellcount_bydepth_avg.csv"), row.names = FALSE)
  }
}

```


```{r}
mthord <- c("mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")

for (m in 1:length(mthord)){
  mth <- mthord[m]
  probblst <- list.files(paste0("../output/maxent/paper_plots/prob_by_depth"), pattern = paste0("^", mth, "_probbin_.*.csv"), full.names = TRUE)
  a <- read.csv(probblst[1])
  b <- read.csv(probblst[2])
  c <- read.csv(probblst[3])
  d <- read.csv(probblst[4])
  e <- read.csv(probblst[5])
  f <- read.csv(probblst[6])
  g <- read.csv(probblst[7])
  h <- read.csv(probblst[8])
  i <- read.csv(probblst[9])
  j <- read.csv(probblst[10])
  
  stackstat <- cbind(a, b[ ,2], c[ ,2], d[ ,2], e[ , 2], f[ ,2], g[ ,2], h[ ,2], i[ ,2], j[ ,2])
  colnames(stackstat) <- c("depth", "0 - 0.09", "0.1 - 0.19", "0.2 - 0.29", "0.3 - 0.39", "0.4 - 0.49", "0.5 - 0.59", "0.6 - 0.69", "0.7 - 0.79", "0.8 - 0.89", ">0.9")
  stackstat <- melt(stackstat, id = "depth")
  stackstat <- stackstat[!(stackstat$depth == "1151.99"), ]
  stackstat <- stackstat[!(stackstat$depth == "1265.86"), ]
  stackstat <- stackstat[!(stackstat$depth == "1387.38"), ]
  
  colnames(stackstat) <- c("Depth", "Probability", "Cells")
  
  write.csv(stackstat, paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_allprobbin_cellcount_bydepth_avg.csv"), row.names = FALSE)
}

```

think about how to get proportions... 

```{r}
mthord <- c("mar",  "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")
cumst1 <- read.csv("../output/maxent/paper_plots/prob_by_depth/cellsperlayer.csv", header = TRUE)

for (m in 1:length(mthord)){
  mth <- mthord[m]
  a <- read.csv(paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_allprobbin_cellcount_bydepth_avg.csv"), header = TRUE, stringsAsFactors=FALSE)
  for (r in 1:nrow(a)){
    # a$Depth[r] <- gsub("b_avg_cloglog_", "", x = a$Depth[r])
    # d1 <- str_sub(a$Depth[r], end = 4)
    d1 <- a$Depth[r]
	  for (ro in 1:nrow(cumst1)){
      #d2 <- str_sub(cumst1$depth[ro], end = 4)
	    d2 <- cumst1$depth[ro]
      if (d1 == d2){
          a$total_cells[r] <- cumst1$no_cells[ro]
      }
	  }
    a$p_cells[r] <- (a$Cells[r]/a$total_cells[r])*100
  }
    a$Depth <- as.numeric(a$Depth)

  write.csv(a, paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_dis_prob_cells.csv"), row.names = FALSE)
}

```

histogram of probability by depth - by proportion

```{r}

bydepth <- ggplot(a, aes(Depth, p_cells, fill = Probability)) + geom_col() + scale_x_reverse() + coord_flip() #XXXXXcareful - the deeper layers aren't being displayed correctly here
plot(bydepth)
#png(paste0("../output/maxent/predictions/", mthna, "/depthplot_probavg_prop.png"))
#print(bydepth)
#dev.off()
```

ok lets try colour the probabilites to match the maps...

```{r}
probcol <- rev(brewer.pal(10,"RdYlGn"))
bydepth <- ggplot(a, aes(Depth, p_cells, fill = Probability)) + geom_col() + scale_x_reverse() + coord_flip() + scale_fill_manual(values = probcol) #XXXXXcareful - the deeper layers aren't being displayed correctly here
plot(bydepth)
```

ok now lets lump all the 0.39 and under together...


```{r}
mthord <- c("mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")
cumst1 <- read.csv("../output/maxent/paper_plots/prob_by_depth/cellsperlayer.csv", header = TRUE)
for (m in 1:length(mthord)){
  mth <- mthord[m]
  a <- read.csv(paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_dis_prob_cells.csv"), header = TRUE)
  head(a)
  d <- unique(cumst1$depth)
  x <- data.frame(matrix(nrow = length(d)))
  for (s in 1:length(d)){
    dep <- d[s]
    sd <- subset(a, Depth == dep)
    sd <- subset(sd, Probability == "0 - 0.09"| Probability == "0.1 - 0.19"| Probability == "0.2 - 0.29"| Probability == "0.3 - 0.39")
    c <- sum(sd$Cells)
    x$Depth[s] <- dep
    x$Probability[s] <- "0 - 0.39"
    x$Cells[s] <- c
    x$p_cells[s] <- 1
    x$total_cells[s] <- 1
  }
  x$Cells[is.na(x$Cells)] <- 0
   for (r in 1:nrow(x)){
     d1 <- str_sub(x$Depth[r], end = 4)
     for (ro in 1:nrow(cumst1)){
       d2 <- str_sub(cumst1$depth[ro], end = 4)
       if (d1 == d2){
           x$total_cells[r] <- cumst1$no_cells[ro]
       }
     }
   }
  for (r in 1:nrow(x)){
    x$p_cells[r] <- (x$Cells[r]/x$total_cells[r])*100
  }
x <- subset(x, select = -c(matrix.nrow...length.d..))
  write.csv(x, paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_u0.4plus_dis_prob_cells.csv"))
}
```

merge the u0.4 dataset with the original
```{r}
mthord <- c("mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")
for (m in 1:length(mthord)){
  mth <- mthord[m]
  a <- read.csv(paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_u0.4plus_dis_prob_cells.csv"), header = TRUE, stringsAsFactors=FALSE)
  a <- subset(a, select = -c(X))
  b <- read.csv(paste0("../output/maxent/paper_plots/prob_by_depth/", mth, "_dis_prob_cells.csv"), header = TRUE, stringsAsFactors=FALSE)
  c <- rbind(a, b)
  c <- c[!(c$Probability == "0 - 0.09"), ]
  c <- c[!(c$Probability == "0.1 - 0.19"), ]
  c <- c[!(c$Probability == "0.2 - 0.29"), ]
  c <- c[!(c$Probability == "0.3 - 0.39"), ]
  write.csv(c, paste0("../output//maxent/paper_plots/prob_by_depth/", mth, "_u0.4s_dis_prob_cells.csv"))
}
```



```{r}
probcol <- rev(brewer.pal(7,"RdYlGn"))
bydepth <- ggplot(c, aes(Depth, p_cells, fill = Probability)) + geom_col() + scale_x_reverse() + coord_flip() + scale_fill_manual(values = probcol) #XXXXXcareful - the deeper layers aren't being displayed correctly here
plot(bydepth)
```

ok dont forget the colours will need to match the maps so you may need to manually create your own list for whatever scheme you choose...

"1151.99"), ]
  stackstat <- stackstat[!(stackstat$depth == "1265.86"), ]
  stackstat <- stackstat[!(stackstat$depth == "1387.38"), ]
  


```{r}
mar <- read.csv("../output//maxent/paper_plots/prob_by_depth/mar_u0.4s_dis_prob_cells.csv", header = TRUE)
mar <- mar[!(mar$Depth =="1151.99" | mar$Depth =="1265.86" | mar$Depth =="1387.38"), ]
mar$Probability <- gsub(">0.9", "0.9 - 1", mar$Probability)
mar$Depth <- as.factor(mar$Depth)
flevelsm <- levels(mar$Depth)
flevelsm <- rev(flevelsm)

jun <- read.csv("../output//maxent/paper_plots/prob_by_depth/jun_u0.4s_dis_prob_cells.csv", header = TRUE)
jun <- jun[!(jun$Depth =="1151.99" | jun$Depth =="1265.86" | jun$Depth =="1387.38"), ]
jun$Probability <- gsub(">0.9", "0.9 - 1", jun$Probability)
jun$Depth <- as.factor(jun$Depth)
flevelsj <- levels(jun$Depth)
flevelsj <- rev(flevelsj)

sep <- read.csv("../output//maxent/paper_plots/prob_by_depth/sep_u0.4s_dis_prob_cells.csv", header = TRUE)
sep <- sep[!(sep$Depth =="1151.99" | sep$Depth =="1265.86" | sep$Depth =="1387.38"), ]
sep$Probability <- gsub(">0.9", "0.9 - 1", sep$Probability)
sep$Depth <- as.factor(sep$Depth)
flevelss <- levels(sep$Depth)
flevelss <- rev(flevelss)

dec <- read.csv("../output//maxent/paper_plots/prob_by_depth/dec_u0.4s_dis_prob_cells.csv", header = TRUE)
dec <- dec[!(dec$Depth =="1151.99" | dec$Depth =="1265.86" | dec$Depth =="1387.38"), ]
dec$Probability <- gsub(">0.9", "0.9 - 1", dec$Probability)
dec$Depth <- as.factor(dec$Depth)
flevelsd <- levels(dec$Depth)
flevelsd <- rev(flevelsd)

probcol <- rev(brewer.pal(7,"RdYlGn"))


pm <- ggplot(mar, aes(Depth, p_cells, fill = Probability)) + geom_col(width = 1) + coord_flip() + scale_fill_viridis(option="viridis", discrete = TRUE, direction = -1) + scale_x_discrete(limits = flevelsm, breaks=flevelsm[seq(1,length(flevelsm), by = 2)], ) + coord_flip() + labs(y = "% Ocean at Depth", title = "March") + theme_half_open(12) + theme(plot.margin = margin(6, 0, 6, 0)) 

pj <- ggplot(jun, aes(Depth, p_cells, fill = Probability)) + geom_col(width = 1) + coord_flip() +  scale_fill_manual(values = probcol) + scale_x_discrete(limits = flevelsj, breaks=flevelsj[seq(1,length(flevelsj), by = 2)]) + coord_flip() +labs(y = "% Ocean at Depth", title = "June") + theme_half_open(12) + theme(plot.margin = margin(6, 0, 6, 0))

ps <- ggplot(sep, aes(Depth, p_cells, fill = Probability)) + geom_col(width = 1) + coord_flip() +  scale_fill_manual(values = probcol) + scale_x_discrete(limits = flevelss, breaks=flevelss[seq(1,length(flevelss), by = 2)]) + coord_flip() +labs(y = "% Ocean at Depth", title = "September") + theme_half_open(12) + theme(plot.margin = margin(6, 0, 6, 0))

pd <- ggplot(dec, aes(Depth, p_cells, fill = Probability)) + geom_col(width = 1) + coord_flip() +  scale_fill_manual(values = probcol) + scale_x_discrete(limits = flevelsd, breaks=flevelsd[seq(1,length(flevelsd), by = 2)]) + coord_flip() +labs(y = "% Ocean at Depth", title = "December") + theme_half_open(12) + theme(plot.margin = margin(6, 0, 6, 0))


# # arrange the four plots in a single row
# prow <- plot_grid(
#   pm + theme(legend.position="none"),
#   pj + theme(legend.position="none"),
#  # ps + theme(legend.position="none"),
# #  pd + theme(legend.position="none"),
#   align = 'vh',
#   #labels = c("A", "B") #, "C", "D"),
#   hjust = -1,
#   nrow = 1
# )
# 
# legend <- get_legend(
#   # create some space to the left of the legend
#   pm + theme(legend.box.margin = margin(0, 0, 0, 12))
# )
# 
# # add the legend to the row we made earlier. Give it one-third of 
# # the width of one plot (via rel_widths).
# t <- plot_grid(prow, legend, rel_widths = c(3, .4))
# 
# t
pm


```



now MJ suggested to only show some depths (the most commonly predicted ones)


```{r}
probblst <- list.files("../output/maxent/paper_plots/prob_by_depth/", pattern = "_u0.4s_dis_prob_cells.csv", full.names = TRUE)
a <- read.csv(probblst[1])
b <- read.csv(probblst[2])
c <- read.csv(probblst[3])
d <- read.csv(probblst[4])
e <- read.csv(probblst[5])
f <- read.csv(probblst[6])
g <- read.csv(probblst[7])
h <- read.csv(probblst[8])
i <- read.csv(probblst[9])
j <- read.csv(probblst[10])
  
stackstat <- cbind(a, b[ ,4], c[ ,4], d[ ,4], e[ ,4], f[ ,4], g[ ,4], h[ ,4], i[ ,4], j[ ,4])

colnames(stackstat)

x <- subset(stackstat, select = -c(X, p_cells))
x <- x[ , c(1, 2, 4, 3, 5:13)]
for (r in 1:nrow(x)){
x$totalm[r] <- rowSums(x[r, 4:13])
x$totala[r] <- x$total_cells[r]*10
x$p_cells[r] <- (x$totalm[r]/x$totala[r])*100
}
y <- subset(x, select = c(Depth, Probability, p_cells))
y$Probability <- gsub(">0.9", "0.9 - 1", y$Probability)

probcol <- rev(brewer.pal(7,"RdYlGn"))
bydepth <- ggplot(y, aes(Depth, p_cells, fill = Probability)) + geom_col() + scale_x_reverse() + coord_flip() + scale_fill_manual(values = probcol) 
plot(bydepth)

z <- subset(y, Depth <510)

bydepth <- ggplot(z, aes(Depth, p_cells, fill = Probability)) + geom_bar(stat = "identity") + coord_flip() + scale_x_reverse() + scale_fill_manual(values = probcol) + theme_minimal() #still missing data...
plot(bydepth)

```

```{r}
z <- subset(y, Depth <510)
z <- z[order(z$Depth), ]

y$Depth <- as.factor(y$Depth)
flevels <- levels(y$Depth)
flevels <- rev(flevels)

ggplot(y, aes(Depth, p_cells, fill = Probability)) + geom_col() + coord_flip() +  scale_fill_manual(values = probcol) + scale_x_discrete(limits = flevels, breaks=flevels[seq(1,length(flevels), by = 2)]) + coord_flip()


```

#2d hotspot maps

first create layers that are 0.5 and above

```{r habitat classification on probability - >0.5}

binprob <- function(x){
  ifelse(x >= 0.5, 1,
  ifelse(x < 0.5, 0, NA)) 
}

mthord <- c("mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")

for (m in 1:length(mthord)){
  mthna <- mthord[m]
  clogasc_list <- list.files(paste0("../output/maxent/predictions/", mthna), pattern = "^avg_cloglog_.*asc", full.names = TRUE)
  for (cum in 1:length(clogasc_list)){
    cumasc <- raster(clogasc_list[cum])
    ascname <- names(cumasc)
    ascname <- gsub("avg_cloglog_", "", ascname)
    probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
    writeRaster(probbin, paste0("../output/maxent/paper_plots/hotspot_mapping/", mthna,  "_binary_0.5_", ascname, ".asc"), overwrite = TRUE)
     plot(probbin, png(paste0("../output/maxent/paper_plots/hotspot_mapping/", mthna, "_binary_0.5_", ascname, ".png")), overwrite = TRUE)
       dev.off() # stops automatic saving of the plot to a png
  }
}

```

then create an summary map....
```{r high probability map per year 2D representation}
mthord <- c("mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")

for (m in 1:length(mthord)){
  mthna <- mthord[m]
  binaryprob_list <- list.files(paste0("../output/maxent/paper_plots/hotspot_mapping/"), pattern = paste0(mthna, "*_binary_0.5_.*.asc$"), full.names = TRUE)
  binstack <- stack(binaryprob_list)
  stacksum <- sum(binstack, na.rm = TRUE)
  writeRaster(stacksum, paste0("../output/maxent/paper_plots/hotspot_mapping/", mthna, "_bin_0.5_2d.asc"), overwrite=TRUE)
  plot(stacksum, png(paste0("../output/maxent/paper_plots/hotspot_mapping/", mthna, "_bin_0.5_2d.png")))
  dev.off()
}

```

the maps need to be layered with the land etc, trimmed, and coloured to whatever is agreed

with rastervis



