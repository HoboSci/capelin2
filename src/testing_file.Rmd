---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
presback <- read.csv("../output/bio/presab_nafo_yr.csv", header = TRUE)
presences <- subset(presback, occurrence == "1") #splits the testing dataset into presences
un_mth <- unique(presences$month)
prrows <- length(presences)
presences$season <- 5


for (i in 1:nrow(presences)){
  if (presences$month[i] >= 1 & presences$month[i] <= 3){
    presences$season[i] <- 1
    } else if (presences$month[i] >= 4 & presences$month[i] <= 6){
    presences$season[i] <- 2
    } else if (presences$month[i] >= 7 & presences$month[i] <= 9){
    presences$season[i] <- 3
    } else if (presences$month[i] >= 10 & presences$month[i] <= 12){
    presences$season[i] <- 4
  }
}

write.csv(presences, "../output/bio/cluster_seasons_test.csv", row.names = FALSE)

names(presences)

pres <- subset(presences, select = c(year, month, temp_depth, salinity_depth, o2_depth, chl_surface, nao_sample, nao_prev, nao_winter, amo_sample, amo_winter, season))
pres <- na.omit(pres)
pres2 <- na.omit(presences)
pres <- scale(pres)
```

```{r}

library("cluster")
library("factoextra")
library("magrittr")
```

```{r}
distance <- get_dist(pres)
fviz_dist(distance, gradient = list(low = "#00AFBB", mid = "white", high = "#FC4E07"))
```


```{r}
fviz_nbclust(pres, kmeans, method = "gap_stat")
```

```{r}
set.seed(123)
km.res <- kmeans(pres, 6, nstart = 25)
km.res
# Visualize
library("factoextra")
fviz_cluster(km.res, data = pres,
             ellipse.type = "convex",
             palette = "jco",
             ggtheme = theme_minimal())
```

```{r}
library("cluster")
pam.res <- pam(pres, 6)
# Visualize
fviz_cluster(pam.res)
```




```{r}
library(rworldmap)
pres2wi <- subset(pres2, season == "1")
pres2sp <- subset(pres2, season == "2")
pres2su <- subset(pres2, season == "3")
pres2au <- subset(pres2, season == "4")
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "pres2wi", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(pres2wi$decimalLongitude, pres2wi$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
points(pres2sp$decimalLongitude, pres2sp$decimalLatitude, col = "blue") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
points(pres2su$decimalLongitude, pres2su$decimalLatitude, col = "green") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
points(pres2au$decimalLongitude, pres2au$decimalLatitude, col = "yellow") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
```

```{r}
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "winter", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(pres2wi$decimalLongitude, pres2wi$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
```


```{r}
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "spring", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(pres2sp$decimalLongitude, pres2sp$decimalLatitude, col = "blue") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")

```


```{r}
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "summer", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(pres2su$decimalLongitude, pres2su$decimalLatitude, col = "green") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
```



```{r}
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "autumn", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(pres2au$decimalLongitude, pres2au$decimalLatitude, col = "yellow") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
```

```{r}
p98 <- subset(pres2, year == "1998")
p99 <- subset(pres2, year == "1999")
p00 <- subset(pres2, year == "2000")
p01 <- subset(pres2, year == "2001")
p02 <- subset(pres2, year == "2002")
p03 <- subset(pres2, year == "2003")
p04 <- subset(pres2, year == "2004")
p05 <- subset(pres2, year == "2005")
p06 <- subset(pres2, year == "2006")
p07 <- subset(pres2, year == "2007")
p08 <- subset(pres2, year == "2009")
p09 <- subset(pres2, year == "2009")
p10 <- subset(pres2, year == "2010")
p11 <- subset(pres2, year == "2011")
p12 <- subset(pres2, year == "2012")
p13 <- subset(pres2, year == "2013")
p14 <- subset(pres2, year == "2014")
p15 <- subset(pres2, year == "2015")

```


```{r}
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "1998", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p98$decimalLongitude, p98$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_1998.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "1999", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p99$decimalLongitude, p99$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_1999.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2000", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p00$decimalLongitude, p00$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2000.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2001", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p01$decimalLongitude, p01$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2001.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2002", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p02$decimalLongitude, p02$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2002.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2003", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p03$decimalLongitude, p03$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2003.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2004", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p04$decimalLongitude, p04$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2004.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2005", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p05$decimalLongitude, p05$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2005.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2006", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p06$decimalLongitude, p06$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2006.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2007", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p07$decimalLongitude, p07$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2007.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2008", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p08$decimalLongitude, p08$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2008.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2009", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p09$decimalLongitude, p09$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2009.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2010", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p10$decimalLongitude, p10$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2010.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2011", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p11$decimalLongitude, p11$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2011.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2012", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p12$decimalLongitude, p12$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2012.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2013", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p13$decimalLongitude, p13$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2013.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2014", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p14$decimalLongitude, p14$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2014.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2015", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p15$decimalLongitude, p15$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2015.png") #this prints a png of the plot
dev.off() #this turns off the print command
```



# violin plots

```{r}
#load a test raster

ras <- raster("../output/maxent/predictions/apr/cloglog_st201004000120.asc")
plot(ras)
ras2 <- raster("../output/maxent/predictions/oct/cloglog_st201010000120.asc")
plot(ras2)
rasd <- as.data.frame(ras)
rasd$month <- "4"
rasd2 <- as.data.frame(ras2)
rasd2$month <- "10"
names(rasd)[names(rasd) == "cloglog_st201004000120"] <- "prob"
names(rasd2)[names(rasd2) == "cloglog_st201010000120"] <- "prob"
rasd$month <- as.factor(rasd$month)
rasd2$month <- as.factor(rasd2$month)
rd <- rbind(rasd, rasd2)
rd
p <- ggplot(rd, aes(x=month, y = prob)) + geom_violin(trim=FALSE)
plot(p)


mth <- c("jan", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")
for (m in 1:length(mth)){
  mon <- mth[m]
  vlst <- list.files(paste0("../output/maxent/predictions/", mon), pattern = "^avg_cloglog.*.asc", full.names = TRUE)
  for (v in 1:length(vlst)){
    ras <- raster(vlst[v])
    rasd <- as.data.frame(ras)
    if (mon == "jan"){
      rasd$month <- "1"
      rnm <- names(ras)
      names(rasd)[names(rasd) == rnm] <- "prob"
      rasd$month <- as.factor(rasd$month)
      rd1 <- rasd
      } else if(mon == "mar"){
        rasd$month <- "3"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd3 <- rasd
      } else if(mon == "apr"){
        rasd$month <- "4"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd4 <- rasd
      } else if(mon == "may"){
        rasd$month <- "5"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd5 <- rasd
      } else if(mon == "jun"){
        rasd$month <- "6"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd6 <- rasd
      } else if(mon == "jul"){
        rasd$month <- "7"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd7 <- rasd
      } else if(mon == "aug"){
        rasd$month <- "8"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd8 <- rasd
      } else if(mon == "sep"){
        rasd$month <- "9"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd9 <- rasd
      } else if(mon == "oct"){
        rasd$month <- "10"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd10 <- rasd
      } else if(mon == "nov"){
        rasd$month <- "11"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd11 <- rasd
      } else if(mon == "dec"){
        rasd$month <- "12"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd12 <- rasd
      }
   
     
  }


}
  #rd <- rbind(rd1, rd3, rd4, rd5, rd6, rd7, rd8, rd9, rd10, rd11, rd12)
  rd <- rbind(rd1, rd3, rd4)

    #rd <- as.data.frame(rd)
    #rd$month <- as.factor(rd$month)
p <- ggplot(rd, aes(x=month, y = prob)) + geom_violin(trim=FALSE)
plot(p)






```





. For key predictor variables, can you plot probability of occurrence (y-axis) vs predictor (x-axis). I would like to see raw data which will be 1 for presence and 0 for background and then overlay the model predicted relationships on top of the raw data for the two models (full year, month). Functiona "abline (model name)" plots the model prediction for many models in R - not sure this will work for MaxEnt. This will show how the predictions vary for the different variables - perhaps it is just one driving the differences. Does this make sense?


first need to add the same depth indicator as used in the file names

```{r}
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}

data_aea <- read.csv("../output/bio/presab_nafo_yr.csv", header = TRUE)
data_aea$depthlyr_mod <- NA
data_aea$predicted_alldata <- NA
data_aea <- completeFun(data_aea, "depth_layer")

avgasc_list <- list.files(paste0("../output/maxent/all_data/predictions/july/"), pattern = "^avg_.*.asc", full.names = TRUE) #true means the full path is included
depths <- list()
for (i in 1:length(avgasc_list)){
  ascname <-  str_sub(avgasc_list[i], 48, -5)
  depths[[paste0(i)]] <- ascname
}

for (j in 1:nrow(data_aea)){
  d <- data_aea$depth_layer[j]
  d3 <- str_sub(d, end = 3) #extract first 3 digits 
   for (k in 1:length(depths)){
    l <- depths[[k]]
    l3 <- str_sub(l, end = 3) #extract first 3 digits
    if (d3 == l3){
      data_aea$depthlyr_mod[j] <- l
    }
  }
}
data_aea <- completeFun(data_aea, "depthlyr_mod")


```


```{r}
#mth <- c("1", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12")
#mthn <- c("jan", "may", "apr", "may", "jun", "july", "aug", "sep", "oct", "nov","dec")
aea <- raster("../output/env/aea.tif") 



#for (m in 1:length(mth)){
#mont <- mth[m]
mont <- 11
data_aeaX <- subset(data_aea, month == mont)
xy <- data_aeaX[ ,c(19,20)] # This is to tell R where the coordinates are (in column 18 and 19). Note that the column order needs to be longitude, latitude
data_aea_sp <- SpatialPointsDataFrame(coords = xy, data = data_aeaX, proj4string = CRS("+proj=aea +lat_1=50 +lat_2=70 +lat_0=40 +lon_0=-60 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs")) # The CRS is used here is for the albers equal area projection.
avgasc_list <- list.files(paste0("../output/maxent/all_data/predictions/nov/"), pattern = "^avg_.*.asc", full.names = TRUE) #true means the full path is included
for (j in 1:nrow(data_aea_sp)) { 
for (i in 1:length(avgasc_list)) {  
 de <- data_aea_sp$depthlyr_mod[j]  # a variable for the observation depth layer
  mth <- (data_aea_sp$month[j])  # a variable for the observation month
  rasdep <- str_sub(avgasc_list[i], 47, -5)
       if (mth == mont & rasdep == de){
          temp_brick <- raster(avgasc_list[i])
        crs(temp_brick) <- aea@crs 
              data_aea_sp$predicted[j] <- extract(x=temp_brick, y = data_aea_sp[j, ]) 
              
              }
          }
}

#}
              data_aea1 <- as.data.frame(data_aea_sp)

write.csv(data_aea1, "../output/maxent/all_data/pred_file_nov.csv", row.names = FALSE)
 #}
  
 # data_aea1 <- as.data.frame(data_aea_sp)

```


```{r}

aea <- raster("../output/env/aea.tif") 



#for (m in 1:length(mth)){
#mont <- mth[m]
mont <- 11
data_aeaX <- read.csv("../output/maxent/all_data/pred_file_nov.csv", header = TRUE)
data_aeaX$mthpred <- NA
xy <- data_aeaX[ ,c(19,20)] # This is to tell R where the coordinates are (in column 18 and 19). Note that the column order needs to be longitude, latitude
data_aea_sp <- SpatialPointsDataFrame(coords = xy, data = data_aeaX, proj4string = CRS("+proj=aea +lat_1=50 +lat_2=70 +lat_0=40 +lon_0=-60 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs")) # The CRS is used here is for the albers equal area projection.
avgasc_list <- list.files(paste0("../output/maxent/predictions/nov/"), pattern = "^avg_.*.asc", full.names = TRUE) #true means the full path is included
for (j in 1:nrow(data_aea_sp)) { 
for (i in 1:length(avgasc_list)) {  
 de <- data_aea_sp$depthlyr_mod[j]  # a variable for the observation depth layer
  mth <- (data_aea_sp$month[j])  # a variable for the observation month
  rasdep <- str_sub(avgasc_list[i], 46, -5)
       if (mth == mont & rasdep == de){
          temp_brick <- raster(avgasc_list[i])
        crs(temp_brick) <- aea@crs 
              data_aea_sp$mthpred[j] <- extract(x=temp_brick, y = data_aea_sp[j, ]) 
              
              }
          }
}

#}
              data_aea1 <- as.data.frame(data_aea_sp)
              write.csv(data_aea1, "../output/maxent/all_data/pred_file_nov.csv", row.names = FALSE)


```


```{r}
predjan <- read.csv("../output/maxent/all_data/pred_file_jan.csv", header = TRUE)
predjanpr <- subset(predjan, occurrence == 1)
predjanbk <- subset(predjan, occurrence == 0)
png("janocc_temp_vs_prob.png")
plot(predjanpr$temp_depth, predjanpr$predicted_mthdata, xlab = "temperature", ylab = "probability")
dev.off()
png("janbk_temp_vs_prob.png")
plot(predjanbk$temp_depth, predjanbk$predicted_mthdata, xlab = "temperature", ylab = "probability")
dev.off()
```

```{r}
mod <- readRDS(file = "../output/maxent/all_data/maxmod.rds", refhook = NULL)
px <- response(mod@models[[4]])
```

#get all probabiltiy values for a period of time and find the upper 20%


for july with all data
```{r}
clogasc_list <- list.files(paste0("../output/maxent/all_data/predictions/july/"), pattern = "^avg_.*.asc", full.names = TRUE) # first list the files containing the data
a <- stack(clogasc_list) #stack the files
b <- getValues(a) # create a matrix of the values 
c <- as.vector(b) #make into vector
d <- na.omit(c) #remove all na values
d <- sort(d, decreasing = TRUE) # order from high to low
drow <- length(d) # how many values are there
dr20 <- (drow*20)/100  # calculate which value is the upper 20%
d20 <- d[dr20] # 0.149577....
dmaxv <- max(d) #0.998087
dm20 <- (dmaxv*80)/100 # calculate the 20% of 0.998097...  = 0.798477....


#binary threshold function d20
bind20 <- function(x){
  ifelse(x >= d20, 1,
  ifelse(x < d20, 0, NA)) 
}

#binary threshold function dm20
bindm20 <- function(x){
  ifelse(x >= dm20, 1,
  ifelse(x < dm20, 0, NA)) 
}

for (cum in 1:length(clogasc_list)){
  cumascdep <- str_sub(clogasc_list[cum], start = 47, end = -5) #selects the depth from the file name
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cum_d20 <- calc(cumasc, fun = bind20)
  cum_dm20 <- calc(cumasc, fun = bindm20)
  writeRaster(cum_d20, paste0("../output/maxent/slr_analysis/july_alldata/july_alldata_d20_", ascname, ".asc"), overwrite = TRUE)
  writeRaster(cum_dm20, paste0("../output/maxent/slr_analysis/july_alldata/july_alldata_dm20_", ascname, ".asc"), overwrite = TRUE)
  }



binaryclog_list <- list.files(paste0("../output/maxent/slr_analysis/july_alldata"), pattern = "^july_alldata_d20_.*.asc", full.names = TRUE)
binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, "../output/maxent/slr_analysis/july_alldata/d20_2d.asc", overwrite=TRUE)
plot(stacksum, png("../output/maxent/slr_analysis/july_alldata/d20_2d.png"))
dev.off()
binaryclog_list <- list.files(paste0("../output/maxent/slr_analysis/july_alldata"), pattern = "^july_alldata_dm20_.*.asc", full.names = TRUE)
binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, "../output/maxent/slr_analysis/july_alldata/dm20_2d.asc", overwrite=TRUE)
plot(stacksum, png("../output/maxent/slr_analysis/july_alldata/dm20_2d.png"))
dev.off()


#make map

aea <- raster("../output/env/aea.tif") #the correct CRS
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
apr <- aea@crs
#brk <- seq(0.1, 1, 0.1) #for legend
redtrans <- rgb(218, 215, 216, 90, maxColorValue=255) 
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
presback <- read.csv("../output/bio/presab_nafo_yr.csv", header = TRUE)
pronly <- subset(presback, occurrence == 1)
prjul <- subset(pronly, month == 7)
#prjan <- subset(pronly, month == 1)


  pras <- raster("../output/maxent/slr_analysis/july_alldata/d20_2d.asc")
  crs(pras) <- apr
  ascname <- names(pras)
  pras[pras >0] <- 1
  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prjul$longitude_meters, prjul$latitude_meters, add = TRUE, pch=19, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/slr_analysis/july_alldata/d20_2d.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
  
  pras <- raster("../output/maxent/slr_analysis/july_alldata/dm20_2d.asc")
  crs(pras) <- apr
  ascname <- names(pras)
  pras[pras >0] <- 1
  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prjul$longitude_meters, prjul$latitude_meters, add = TRUE, pch=19, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/slr_analysis/july_alldata/dm20_2d.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))

```






for july with just july data
```{r}
clogasc_list <- list.files(paste0("../output/maxent/predictions/jul/"), pattern = "^avg_cloglog_.*.asc", full.names = TRUE) # first list the files containing the data
a <- stack(clogasc_list) #stack the files
b <- getValues(a) # create a matrix of the values 
c <- as.vector(b) #make into vector
d <- na.omit(c) #remove all na values
d <- sort(d, decreasing = TRUE) # order from high to low
drow <- length(d) # how many values are there
dr20 <- (drow*20)/100  # calculate which value is the upper 20%
d20 <- d[dr20] # 0.083319....
dmaxv <- max(d) #0.885157....
dm20 <- (dmaxv*80)/100 # calculate the 20% of 0.885157....  = 0.70812....



#binary threshold function d20
bind20 <- function(x){
  ifelse(x >= d20, 1,
  ifelse(x < d20, 0, NA)) 
}

#binary threshold function dm20
bindm20 <- function(x){
  ifelse(x >= dm20, 1,
  ifelse(x < dm20, 0, NA)) 
}

for (cum in 1:length(clogasc_list)){
  cumascdep <- str_sub(clogasc_list[cum], start = 46, end = -5) #selects the depth from the file name
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cum_d20 <- calc(cumasc, fun = bind20)
  cum_dm20 <- calc(cumasc, fun = bindm20)
  writeRaster(cum_d20, paste0("../output/maxent/slr_analysis/july_alldata/july_monthdata_d20_", ascname, ".asc"), overwrite = TRUE)
  writeRaster(cum_dm20, paste0("../output/maxent/slr_analysis/july_alldata/july_monthdata_dm20_", ascname, ".asc"), overwrite = TRUE)
  }



binaryclog_list <- list.files(paste0("../output/maxent/slr_analysis/july_alldata"), pattern = "^july_monthdata_d20_.*.asc", full.names = TRUE)
binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, "../output/maxent/slr_analysis/july_alldata/d20_2d_month.asc", overwrite=TRUE)
plot(stacksum, png("../output/maxent/slr_analysis/july_alldata/d20_2d_month.png"))
dev.off()
binaryclog_list <- list.files(paste0("../output/maxent/slr_analysis/july_alldata"), pattern = "^july_monthdata_dm20_.*.asc", full.names = TRUE)
binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, "../output/maxent/slr_analysis/july_alldata/dm20_2d_month.asc", overwrite=TRUE)
plot(stacksum, png("../output/maxent/slr_analysis/july_alldata/dm20_2d_month.png"))
dev.off()


#make map

aea <- raster("../output/env/aea.tif") #the correct CRS
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
apr <- aea@crs
#brk <- seq(0.1, 1, 0.1) #for legend
redtrans <- rgb(218, 215, 216, 90, maxColorValue=255) 
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
presback <- read.csv("../output/bio/presab_nafo_yr.csv", header = TRUE)
pronly <- subset(presback, occurrence == 1)
prjul <- subset(pronly, month == 7)
#prjan <- subset(pronly, month == 1)


  pras <- raster("../output/maxent/slr_analysis/july_alldata/d20_2d_month.asc")
  crs(pras) <- apr
  ascname <- names(pras)
  pras[pras >0] <- 1
  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prjul$longitude_meters, prjul$latitude_meters, add = TRUE, pch=19, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/slr_analysis/july_alldata/d20_2d_month.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
  
  pras <- raster("../output/maxent/slr_analysis/july_alldata/dm20_2d_month.asc")
  crs(pras) <- apr
  ascname <- names(pras)
  pras[pras >0] <- 1
  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prjul$longitude_meters, prjul$latitude_meters, add = TRUE, pch=19, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/slr_analysis/july_alldata/dm20_2d_month.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
```

for jan with all data
```{r}
clogasc_list <- list.files(paste0("../output/maxent/all_data/predictions/jan/"), pattern = "^avg_.*.asc", full.names = TRUE) # first list the files containing the data
a <- stack(clogasc_list) #stack the files
b <- getValues(a) # create a matrix of the values 
c <- as.vector(b) #make into vector
d <- na.omit(c) #remove all na values
d <- sort(d, decreasing = TRUE) # order from high to low
drow <- length(d) # how many values are there
dr20 <- (drow*20)/100  # calculate which value is the upper 20%
d20 <- d[dr20] # 0.08307....
dmaxv <- max(d) #0.996738...
dm20 <- (dmaxv*80)/100 # calculate the 20% of 0.996738...  = 0.7973906....


#binary threshold function d20
bind20 <- function(x){
  ifelse(x >= d20, 1,
  ifelse(x < d20, 0, NA)) 
}

#binary threshold function dm20
bindm20 <- function(x){
  ifelse(x >= dm20, 1,
  ifelse(x < dm20, 0, NA)) 
}

for (cum in 1:length(clogasc_list)){
  cumascdep <- str_sub(clogasc_list[cum], start = 47, end = -5) #selects the depth from the file name
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cum_d20 <- calc(cumasc, fun = bind20)
  cum_dm20 <- calc(cumasc, fun = bindm20)
  writeRaster(cum_d20, paste0("../output/maxent/slr_analysis/jan_alldata/jan_alldata_d20_", ascname, ".asc"), overwrite = TRUE)
  writeRaster(cum_dm20, paste0("../output/maxent/slr_analysis/jan_alldata/jan_alldata_dm20_", ascname, ".asc"), overwrite = TRUE)
  }


binaryclog_list <- list.files(paste0("../output/maxent/slr_analysis/jan_alldata"), pattern = "^jan_alldata_d20_.*.asc", full.names = TRUE)
binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, "../output/maxent/slr_analysis/jan_alldata/d20_2d.asc", overwrite=TRUE)
plot(stacksum, png("../output/maxent/slr_analysis/jan_alldata/d20_2d.png"))
dev.off()
binaryclog_list <- list.files(paste0("../output/maxent/slr_analysis/jan_alldata"), pattern = "^jan_alldata_dm20_.*.asc", full.names = TRUE)
binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, "../output/maxent/slr_analysis/jan_alldata/dm20_2d.asc", overwrite=TRUE)
plot(stacksum, png("../output/maxent/slr_analysis/jan_alldata/dm20_2d.png"))
dev.off()


#make map

aea <- raster("../output/env/aea.tif") #the correct CRS
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
apr <- aea@crs
#brk <- seq(0.1, 1, 0.1) #for legend
redtrans <- rgb(218, 215, 216, 90, maxColorValue=255) 
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
presback <- read.csv("../output/bio/presab_nafo_yr.csv", header = TRUE)
pronly <- subset(presback, occurrence == 1)
#prjul <- subset(pronly, month == 7)
prjan <- subset(pronly, month == 1)


  pras <- raster("../output/maxent/slr_analysis/jan_alldata/d20_2d.asc")
  crs(pras) <- apr
  ascname <- names(pras)
  pras[pras >0] <- 1
  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prjan$longitude_meters, prjan$latitude_meters, add = TRUE, pch=19, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/slr_analysis/jan_alldata/d20_2d.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
  
  pras <- raster("../output/maxent/slr_analysis/jan_alldata/dm20_2d.asc")
  crs(pras) <- apr
  ascname <- names(pras)
  pras[pras >0] <- 1
  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prjan$longitude_meters, prjan$latitude_meters, add = TRUE, pch=19, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/slr_analysis/jan_alldata/dm20_2d.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))

```

for jan with just jan data
```{r}
clogasc_list <- list.files(paste0("../output/maxent/predictions/jan/"), pattern = "^avg_cloglog_.*.asc", full.names = TRUE) # first list the files containing the data
a <- stack(clogasc_list) #stack the files
b <- getValues(a) # create a matrix of the values 
c <- as.vector(b) #make into vector
d <- na.omit(c) #remove all na values
d <- sort(d, decreasing = TRUE) # order from high to low
drow <- length(d) # how many values are there
dr20 <- (drow*20)/100  # calculate which value is the upper 20%
d20 <- d[dr20] # 0.01165....
dmaxv <- max(d) #0.73946....
dm20 <- (dmaxv*80)/100 # calculate the 20% of 0.73946....  = 0.591569....


#binary threshold function d20
bind20 <- function(x){
  ifelse(x >= d20, 1,
  ifelse(x < d20, 0, NA)) 
}

#binary threshold function dm20
bindm20 <- function(x){
  ifelse(x >= dm20, 1,
  ifelse(x < dm20, 0, NA)) 
}

for (cum in 1:length(clogasc_list)){
  cumascdep <- str_sub(clogasc_list[cum], start = 46, end = -5) #selects the depth from the file name
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cum_d20 <- calc(cumasc, fun = bind20)
  cum_dm20 <- calc(cumasc, fun = bindm20)
  writeRaster(cum_d20, paste0("../output/maxent/slr_analysis/jan_alldata/jan_monthdata_d20_", ascname, ".asc"), overwrite = TRUE)
  writeRaster(cum_dm20, paste0("../output/maxent/slr_analysis/jan_alldata/jan_monthdata_dm20_", ascname, ".asc"), overwrite = TRUE)
  }



binaryclog_list <- list.files(paste0("../output/maxent/slr_analysis/jan_alldata"), pattern = "^jan_monthdata_d20_.*.asc", full.names = TRUE)
binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, "../output/maxent/slr_analysis/jan_alldata/d20_2d_month.asc", overwrite=TRUE)
plot(stacksum, png("../output/maxent/slr_analysis/jan_alldata/d20_2d_month.png"))
dev.off()
binaryclog_list <- list.files(paste0("../output/maxent/slr_analysis/jan_alldata"), pattern = "^jan_monthdata_dm20_.*.asc", full.names = TRUE)
binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, "../output/maxent/slr_analysis/jan_alldata/dm20_2d_month.asc", overwrite=TRUE)
plot(stacksum, png("../output/maxent/slr_analysis/jan_alldata/dm20_2d_month.png"))
dev.off()


#make map

aea <- raster("../output/env/aea.tif") #the correct CRS
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
apr <- aea@crs
#brk <- seq(0.1, 1, 0.1) #for legend
redtrans <- rgb(218, 215, 216, 90, maxColorValue=255) 
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
presback <- read.csv("../output/bio/presab_nafo_yr.csv", header = TRUE)
pronly <- subset(presback, occurrence == 1)
prjul <- subset(pronly, month == 7)
#prjan <- subset(pronly, month == 1)


  pras <- raster("../output/maxent/slr_analysis/jan_alldata/d20_2d_month.asc")
  crs(pras) <- apr
  ascname <- names(pras)
  pras[pras >0] <- 1
  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prjan$longitude_meters, prjan$latitude_meters, add = TRUE, pch=19, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/slr_analysis/jan_alldata/d20_2d_month.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
  
  pras <- raster("../output/maxent/slr_analysis/jan_alldata/dm20_2d_month.asc")
  crs(pras) <- apr
  ascname <- names(pras)
  pras[pras >0] <- 1
  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prjan$longitude_meters, prjan$latitude_meters, add = TRUE, pch=19, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/slr_analysis/jan_alldata/dm20_2d_month.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
```




```{r}

mont <- 
data_aeaX <- read.csv("../output/maxent/all_data/pred_file_nov.csv", header = TRUE)
data_aeaX$predicted_mthdata <- NA

xy <- data_aeaX[ ,c(19,20)] # This is to tell R where the coordinates are (in column 18 and 19). Note that the column order needs to be longitude, latitude
data_aea_sp <- SpatialPointsDataFrame(coords = xy, data = data_aeaX, proj4string = CRS("+proj=aea +lat_1=50 +lat_2=70 +lat_0=40 +lon_0=-60 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs")) # The CRS is used here is for the albers equal area projection.
avgasc_list <- list.files(paste0("../output/maxent/predictions/nov"), pattern = "^avg_.*.asc", full.names = TRUE) #true means the full path is included
for (j in 1:nrow(data_aea_sp)) { 
for (i in 1:length(avgasc_list)) {  
 de <- data_aea_sp$depthlyr_mod[j]  # a variable for the observation depth layer
  rasdep <- str_sub(avgasc_list[i], 46, -5)
       if (rasdep == de){
          temp_brick <- raster(avgasc_list[i])
        crs(temp_brick) <- aea@crs 
              data_aea_sp$predicted_mthdata[j] <- extract(x=temp_brick, y = data_aea_sp[j, ]) 
              
              }
          }
}

           data_aea1 <- as.data.frame(data_aea_sp)

write.csv(data_aea1, "../output/maxent/all_data/pred_file_nov2.csv", row.names = FALSE)
 #}
  
```



#code to create benthic layers

```{r}
aea <- raster("../output/env/aea.tif") #the correct CRS
benlst <- list.files("../data/env/ascii/benthic_layers/template", pattern = ".*.asc", full.names = TRUE)
apr <- aea@crs



for (pred in 1:length(benlst)){
  pras <- raster(benlst[pred])
  crs(pras) <- apr
  ascname <- names(pras)
  depth <-  (sapply(strsplit(ascname, "_"), "[[", 4)) # extracting the third part of the netcdf (inc.nc)
  pras[pras >0] <- 0
  pras[is.na(pras)] <- 1
  writeRaster(pras, paste0("../data/env/ascii/benthic_layers/done/benthic_", depth, ".asc"), overwrite = TRUE)

}

#just check it works
benlst <- list.files("../data/env/ascii/benthic_layers/done", pattern = ".*.asc", full.names = TRUE)


for (pred in 1:length(benlst)){
  pras <- raster(benlst[pred])
  plot(pras)
}


```

```{r}
predjan <- read.csv("../output/maxent/all_data/predictions_jan.csv", header = TRUE)
plot(predjan$occurrence, predjan$predicted_mthdata)
plot(predjan$occurrence, predjan$predicted_alldata)
```

```{r}
predjul <- read.csv("../output/maxent/all_data/pred_file_jul.csv", header = TRUE)
plot(predjul$occurrence, predjul$predicted_mthdata)
plot(predjul$occurrence, predjul$predicted_alldata, xlab = "occurrence", ylab = "probability", main = "probability for background (o) & occurrence (1) - all data model")
```


```{r}
predjan <- read.csv("../output/maxent/all_data/predictions_jan.csv", header = TRUE)

completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}


predjan <- completeFun(predjan, "predicted_mthdata")
predjanoc <- subset(predjan, occurrence == 1)
predjanbk <- subset(predjan, occurrence == 0)
noc <- nrow(predjanoc)
nbk <- nrow(predjanbk)
janmth5plusoc <- sum(predjanoc$predicted_mthdata > 0.5)
janmth5plusbk <- sum(predjanoc$predicted_mthdata > 0.5)
janmthpp <- (janmth5plusoc/noc)*100
janmthbkp <- (janmth5plusbk/nbk)*100

janall5plusoc <- sum(predjanoc$predicted_alldata > 0.5)
janall5plusbk <- sum(predjanoc$predicted_alldata > 0.5)
janallpp <- (janall5plusoc/noc)*100
janallbkp <- (janall5plusbk/nbk)*100
```

```{r}
hist(predjanoc$predicted_mthdata)
hist(predjanoc$predicted_alldata)
hist(predjanbk$predicted_mthdata)
hist(predjanbk$predicted_alldata)
```



```{r}
predjul <- read.csv("../output/maxent/all_data/predictions_jul.csv", header = TRUE)

completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}


predjul <- completeFun(predjul, "predicted_mthdata")
predjuloc <- subset(predjul, occurrence == 1)
predjulbk <- subset(predjul, occurrence == 0)
noc <- nrow(predjuloc)
nbk <- nrow(predjulbk)

julmth5plusoc <- sum(predjuloc$predicted_mthdata > 0.5)
julmth5plusbk <- sum(predjuloc$predicted_mthdata > 0.5)
julmthpp <- (julmth5plusoc/noc)*100
julmthbkp <- (julmth5plusbk/nbk)*100

julall5plusoc <- subset(predjuloc, predicted_alldata > 0.5)
julall5plusoc <- nrow(julall5plusoc)
julall5plusbk <- subset(predjulbk, predicted_alldata > 0.5)
julall5plusbk <- nrow(julall5plusbk)
julallpp <- (julall5plusoc/noc)*100
julallbkp <- (julall5plusbk/nbk)*100
```


```{r}
hist(predjuloc$predicted_mthdata)
hist(predjuloc$predicted_alldata)
hist(predjulbk$predicted_mthdata)
hist(predjulbk$predicted_alldata)
```


```{r}
predlst <- list.files(paste0("../output/maxent/all_data/"), pattern = "pred_file", full.names = TRUE)

completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}

for (a in 1:length(predlst)){
  pred <- read.csv(predlst[a])
  mth <- str_sub(predlst[a], 37, -5) 
  predc <- completeFun(pred, "predicted_mthdata")
  predoc <- subset(predc, occurrence == 1)
  predbk <- subset(predc, occurrence == 0)
  png(paste0("monthly_pred_occurrence_", mth, ".png"))
  hmthoc <- hist(predoc$predicted_mthdata, main = paste0("monthly predictions - ", mth, " occurrences"), xlab = "probability of occurrence")
  dev.off() # stops automatic saving of the plot to a png
  png(paste0("monthly_pred_background_", mth, ".png"))
  hmthbk <- hist(predbk$predicted_mthdata, main = paste0("monthly predictions - ", mth, " background"), xlab = "probability of occurrence")
  dev.off() # stops automatic saving of the plot to a png            
  png(paste0("alldata_pred_occurrence_", mth, ".png"))
  halloc <- hist(predoc$predicted_alldata, main = paste0("all data predictions - ", mth, " occurrences"), xlab = "probability of occurrence")
  dev.off() # stops automatic saving of the plot to a png
  png(paste0("alldata_pred_background_", mth, ".png"))
  hallbk <- hist(predbk$predicted_alldata, main = paste0("all data predictions - ", mth, " background"), xlab = "probability of occurrence")
  dev.off() # stops automatic saving of the plot to a png   

}


```


tss for all data model
```{r}
ev <- evaluate(p = predoc$predicted_alldata , a = predbk$predicted_alldata, model = mod)

tss <- max(ev@TPR + ev@TNR) - 1
tss
```

```{r}
janoc <- read.csv("../output/maxent/all_data/pred_file_jan.csv")
b <- subset(janoc, occurrence == 1)
c <- b$predicted_alldata
a <-max(c, na.rm = TRUE)
a
```


```{r habitat classification on probability - high only}


#binary threshold function
binprob <- function(x){
  ifelse(x >= 0.8, 1,
  ifelse(x < 0.8, 0, NA)) 
}

clogasc_list <- list.files(paste0("../output/maxent/all_data/predictions/july/"), pattern = "^avg_.*.asc", full.names = TRUE)

for (cum in 1:length(clogasc_list)){
  cumascdep <- str_sub(clogasc_list[cum], start = 47, end = -5) #selects the depth from the file name
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cum_mpathr <- calc(cumasc, fun = binprob)
  writeRaster(cum_mpathr, paste0("../output/maxent/all_data/predictions/july/binary_p80_", cumascdep, ".asc"), overwrite = TRUE)
  plot(cum_mpathr, png(paste0("../output/maxent/all_data/predictions/july/binary_p80_", cumascdep, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
  }

```



```{r binary map averaged 2D representation p80}

binaryclog_list <- list.files(paste0("../output/maxent/all_data/predictions/july/"), pattern = "^binary_p80.*.asc", full.names = TRUE)

binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, paste0("../output/maxent/all_data/predictions/july/bin_p80_2d.asc"), overwrite=TRUE)
plot(stacksum, png(paste0("../output/maxent/all_data/predictions/july/bin_avg_p80_2d.png")))
dev.off()

```


```{r}
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
redtrans <- rgb(218, 215, 216, 90, maxColorValue=255) 
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
prpoints <- read.csv("../output/maxent/all_data/pred_file_jul.csv", header = TRUE)
prpoints <- subset(prpoints, occurrence == 1)

completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
  }
  
prpoints <- completeFun(prpoints, "predicted_mthdata")




pras <- raster("../output/maxent/predictions/jul/bin_p80_2d.asc")
  crs(pras) <- aea@crs
  ascname <- names(pras)
  pras <- calc(pras, fun = binprob)

  pras[pras >0] <- 1

  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prpoints$longitude_meters, prpoints$latitude_meters, add = TRUE, pch=15, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/all_data/julmth_over0.8.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))



```

```{r habitat classification on probability - high onlyX}


#binary threshold function
binprob <- function(x){
  ifelse(x >= 0.8, 1,
  ifelse(x < 0.8, 0, NA)) 
}

clogasc_list <- list.files(paste0("../output/maxent/predictions/jul/"), pattern = "^avg_.*.asc", full.names = TRUE)

for (cum in 1:length(clogasc_list)){
  cumascdep <- str_sub(clogasc_list[cum], start = 47, end = -5) #selects the depth from the file name
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cum_mpathr <- calc(cumasc, fun = binprob)
  writeRaster(cum_mpathr, paste0("../output/maxent/predictions/jul/binary_p80_", cumascdep, ".asc"), overwrite = TRUE)
  plot(cum_mpathr, png(paste0("../output/maxent/predictions/jul/binary_p80_", cumascdep, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
  }

```



```{r binary map averaged 2D representation p80x}

binaryclog_list <- list.files(paste0("../output/maxent/predictions/jul/"), pattern = "^binary_p80.*.asc", full.names = TRUE)

binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, paste0("../output/maxent/predictions/jul/bin_p80_2d.asc"), overwrite=TRUE)
plot(stacksum, png(paste0("../output/maxent/predictions/jul/bin_avg_p80_2d.png")))
dev.off()

```



add land to plots with standard legend (working code) THIS WORK!!!
```{r}
aea <- raster("../output/env/aea.tif") #the correct CRS
#maplst <- list.files("../output/maxent/all_data/predictions/", pattern = "binary_avg_2d.*.asc", full.names = TRUE)
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
apr <- aea@crs
brk <- seq(0.1, 1, 0.1) #for legend
redtrans <- rgb(218, 215, 216, 90, maxColorValue=255) 
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis

#r <- raster(avg_77.6112.asc)
#plot(pras)

#for (pred in 1:length(maplst)){
  pras <- raster("../output/maxent/all_data/predictions/apr/avg_77.6112.asc")
  plot(pras)
  crs(pras) <- apr
  ascname <- names(pras)
  #pras[pras >0] <- 1
  lp <- plot(pras, breaks=brk, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = TRUE)
  lp <- plot(pras)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  print(lp)
  dev.copy(png, (paste0("../output/maxent/all_data/predictions/", ascname, pred, ".png")), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
#}

```


barcharts showing probability distribution at depth


first bin the probabilities for cells inside the mcp
```{r bin probabilities}
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
clogasc_list <- list.files(paste0("../output/maxent/predictions/nov/"), pattern = "^avg_cloglog_.*.asc", full.names = TRUE)



binprob <- function(x){
  ifelse(x > 0 & x < 0.1, 0.1,
  ifelse(x <= 0, 0, NA))
}

for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_1_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_1_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}



binprob <- function(x){
  ifelse(x >= 0.1 & x < 0.2, 0.2,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_2_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_2_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}

binprob <- function(x){
  ifelse(x >= 0.2 & x < 0.3, 0.3,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_3_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_3_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}


binprob <- function(x){
  ifelse(x >= 0.3 & x < 0.4, 0.4,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_4_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_4_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}



binprob <- function(x){
  ifelse(x >= 0.4 & x < 0.5, 0.5,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_5_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_5_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}
 

binprob <- function(x){
  ifelse(x >= 0.5 & x < 0.6, 0.6,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_6_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_6_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
} 



binprob <- function(x){
  ifelse(x >= 0.6 & x < 0.7, 0.7,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_7_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_7_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}


binprob <- function(x){
  ifelse(x >= 0.7 & x < 0.8, 0.8,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_8_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_8_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}


binprob <- function(x){
  ifelse(x >= 0.8 & x < 0.9, 0.9,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_9_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_9_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}



binprob <- function(x){
  ifelse(x >= 0.9 & x <= 1, 1,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_10_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_10_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}


```


get data to plot probability by depth... need to do manually 1-10
```{r}
ascdepth_list_high <- list.files(paste0("../output/maxent/predictions/nov/"), pattern = "^binned_1_avgprob_.*asc", full.names = TRUE)

binprob <- function(x){
  ifelse(x >0,  1,
  ifelse(x == -9999, 0, NA))
}

binaryavgstack <- stack(ascdepth_list_high)
stackstathigh <- data.frame(matrix(ncol = 2, nrow = nlayers(binaryavgstack)))
stackstathigh[ ,1] <- c(1:49)
colnames(stackstathigh) <- c("asclayer", "prob_bin")

for (lyr in 1:nlayers(binaryavgstack)){
  ascname <-  str_sub(ascdepth_list_high[lyr], 63, -5)
  dlay <- binaryavgstack[[lyr]]
  dlay <- calc(dlay, fun = binprob) #creates raster layer with cell values based on the binprob function
  lyrsum <- cellStats(dlay, sum)
  stackstathigh$prob_bin[lyr] <- lyrsum
  stackstathigh$asclayer[lyr] <- ascname

}
write.csv(stackstathigh, paste0("../output/maxent/predictions/nov/probbin_1_cellcount_bydepth_avg.csv"), row.names = FALSE)

```


```{r}

probblst <- list.files(paste0("../output/maxent/predictions/nov"), pattern = "^probbin_.*.csv", full.names = TRUE)
a <- read.csv(probblst[1])
b <- read.csv(probblst[2])
c <- read.csv(probblst[3])
d <- read.csv(probblst[4])
e <- read.csv(probblst[5])
f <- read.csv(probblst[6])
g <- read.csv(probblst[7])
h <- read.csv(probblst[8])
i <- read.csv(probblst[9])
j <- read.csv(probblst[10])

stackstat <- cbind(a, b[ ,2], c[ ,2], d[ ,2], e[ , 2], f[ ,2], g[ ,2], h[ ,2], i[ ,2], j[ ,2])
colnames(stackstat) <- c("depth", "0 - 0.09", "0.1 - 0.19", "0.2 - 0.29", "0.3 - 0.39", "0.4 - 0.49", "0.5 - 0.59", "0.6 - 0.69", "0.7 - 0.79", "0.8 - 0.89", ">0.9")
stackstat <- melt(stackstat, id = "depth")
stackstat <- stackstat[!(stackstat$depth == "1151.99"), ]
stackstat <- stackstat[!(stackstat$depth == "1265.86"), ]
stackstat <- stackstat[!(stackstat$depth == "1387.38"), ]

colnames(stackstat) <- c("Depth", "Probability", "Cells")

write.csv(stackstat, paste0("../output/maxent/predictions/nov/allprobbin_cellcount_bydepth_avg.csv"), row.names = FALSE)


```




count number of cells that are not NA in each raster layer that are inside the mcp

```{r}
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
clogasc_list <- list.files(paste0("../output/maxent/predictions/nov/"), pattern = "^avg_cloglog_.*.asc", full.names = TRUE)
cumst <- data.frame(0, 0)
colnames(cumst) <- c("depth", "no_cells")

for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumst[cum, 1] <- str_sub(ascname, 13)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  ccnt <- freq(cumasc, useNA='no')
  ccnt <- sum(ccnt[ ,2])
  cumst[cum, 2] <- ccnt
}

cumst$depth <- as.numeric(cumst$depth)
cumst1 <- cumst[order(cumst$no_cells), ]

write.csv(cumst1, "../output/maxent/predictions/nov/cellsperlayer.csv", row.names = FALSE)

```



think about how to get proportions... 

```{r}
pr <- read.csv("../output/maxent/predictions/nov/allprobbin_cellcount_bydepth_avg.csv", header = TRUE)
cumst1 <- read.csv("../output/maxent/predictions/nov/cellsperlayer.csv", header = TRUE)

#order both filed from high to low depth
pr <- pr[order(pr$Depth), ]
cumst1 <- cumst[order(cumst$depth), ]

#so there are some differences in the depth numbers... use partial matching to get the number of cells on each layer

a <- pr
for (r in 1:nrow(pr)){
  d1 <- str_sub(pr$Depth[r], end = 4)
  for (ro in 1:nrow(cumst1)){
    d2 <- str_sub(cumst1$depth[ro], end = 4)
    if (d1 == d2){
        a$total_cells[r] <- cumst1$no_cells[ro]
    }
  }
}

# now work out percentage of cells for each probability

for (r in 1:nrow(a)){
  a$p_cells[r] <- (a$Cells[r]/a$total_cells[r])*100
}

write.csv(a, "../output/maxent/predictions/nov/dis_prob_cells.csv", row.names = FALSE)

```


histogram of probability by depth (straight count)

```{r}
mthna = "nov"
bydepth <- ggplot(data = a, aes(x = Depth, y = Cells, fill = Probability)) + geom_bar(stat = "identity") +   scale_x_reverse() + coord_flip()
png(paste0("../output/maxent/predictions/", mthna, "/depthplot_probavg.png"))
print(bydepth)
dev.off()
```

histogram of probability by depth - by proportion

```{r}

bydepth <- ggplot(a, aes(Depth, p_cells, fill = Probability)) + geom_col() + scale_x_reverse() + coord_flip() #XXXXXcareful - the deeper layers aren't being displayed correctly here
plot(bydepth)
png(paste0("../output/maxent/predictions/", mthna, "/depthplot_probavg_prop.png"))
print(bydepth)
dev.off()
```


ok lets try get an probability for the whole month

```{r}
a <- read.csv("../output/maxent/predictions/jul/dis_prob_cells.csv", header = TRUE)

#subset the probability ranges
p1 <- subset(a, Probability == "0 - 0.09")
p2 <- subset(a, Probability == "0.1 - 0.19")
p3 <- subset(a, Probability == "0.2 - 0.29")
p4 <- subset(a, Probability == "0.3 - 0.39")
p5 <- subset(a, Probability == "0.4 - 0.49")
p6 <- subset(a, Probability == "0.5 - 0.59")
p7 <- subset(a, Probability == "0.6 - 0.69")
p8 <- subset(a, Probability == "0.7 - 0.79")
p9 <- subset(a, Probability == "0.8 - 0.89")
p10 <- subset(a, Probability == ">0.9")

#count the number of cells per probability. 


cp1 <- sum(p1$Cells)
cp2 <- sum(p2$Cells)
cp3 <- sum(p3$Cells)
cp4 <- sum(p4$Cells)
cp5 <- sum(p5$Cells)
cp6 <- sum(p6$Cells)
cp7 <- sum(p7$Cells)
cp8 <- sum(p8$Cells)
cp9 <- sum(p9$Cells)
cp10 <- sum(p10$Cells)

tc2 <- sum(cp1, cp2, cp3, cp4, cp5, cp6, cp7, cp8, cp9, cp10) #how many cells in total for novy have a value
tcell <- sum(p1$total_cells) # how many cells are available to have a value...
#tc2 and tcell should match

#create datbase of total cells per probability bin for the month

b <- unique(a$Probability) #get the unique probability bins
c <- as.data.frame(rbind(cp1, cp2,  cp3, cp4, cp5, cp6, cp7, cp8, cp9, cp10))
c$probability <- b
colnames(c) <- c("cells", "prob_bin")
rownames(c) <- c()
c$month <- "jul"
```

make plot of probability over the month
```{r}
pmth <- ggplot(d, aes(month, cells, fill = prob_bin)) + geom_bar(stat='identity') 
plot(pmth)
png(paste0("../output/maxent/predictions/", mthna, "/prob_avg_mth.png"))
print(pmth)
dev.off()
```

merge two months of data together into one file then plot

```{r}
f <- rbind(c, d)
pmth <- ggplot(f, aes(month, cells, fill = prob_bin)) + geom_bar(stat='identity') 
plot(pmth)
png(paste0("../output/maxent/predictions/prob_avg_mth_test.png"))
print(pmth)
dev.off()
```


boxplot of test auc scores test

```{r}
dec <- read.csv("../output/maxent/models/decavgAIC.csv", header = TRUE)
mar <- read.csv("../output/maxent/models/maravgAIC.csv", header = TRUE)
apr <- read.csv("../output/maxent/models/apravgAIC.csv", header = TRUE)
may <- read.csv("../output/maxent/models/mayavgAIC.csv", header = TRUE)
jun <- read.csv("../output/maxent/models/junavgAIC.csv", header = TRUE)
jul <- read.csv("../output/maxent/models/julavgAIC.csv", header = TRUE)
aug <- read.csv("../output/maxent/models/augavgAIC.csv", header = TRUE)
sep <- read.csv("../output/maxent/models/sepavgAIC.csv", header = TRUE)
oct <- read.csv("../output/maxent/models/octavgAIC.csv", header = TRUE)
nov <- read.csv("../output/maxent/models/novavgAIC.csv", header = TRUE)

mar <- mar$test_AUC
mar <- head(mar, -1)
apr <- apr$test_AUC
apr <- head(apr, -1)
may <- may$test_AUC
may <- head(may, -1)
jun <- jun$test_AUC
jun <- head(jun, -1)
jul <- jul$test_AUC
jul <- head(jul, -1)
aug <- aug$test_AUC
aug <- head(aug, -1)
sep <- sep$test_AUC
sep <- head(sep, -1)
oct <- oct$test_AUC
oct <- head(oct, -1)
nov <- nov$test_AUC
nov <- head(nov, -1)
dec <- dec$test_AUC
dec <- head(dec, -1)

n <- max(length(mar), length(apr), length(may), length(jun), length(jul), length(aug), length(sep), length(oct), length(nov), length(dec))
length(mar) <- n                      
length(apr) <- n
length(may) <- n
length(jun) <- n
length(jul) <- n
length(aug) <- n
length(sep) <- n
length(oct) <- n
length(nov) <- n
length(dec) <- n

testauc <- cbind(mar, apr, may, jun, jul, aug, sep, oct, nov, dec)
colnames(c) <-c("Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")


```


boxplot of train auc scores test

```{r}
dec <- read.csv("../output/maxent/models/decavgAIC.csv", header = TRUE)
mar <- read.csv("../output/maxent/models/maravgAIC.csv", header = TRUE)
apr <- read.csv("../output/maxent/models/apravgAIC.csv", header = TRUE)
may <- read.csv("../output/maxent/models/mayavgAIC.csv", header = TRUE)
jun <- read.csv("../output/maxent/models/junavgAIC.csv", header = TRUE)
jul <- read.csv("../output/maxent/models/julavgAIC.csv", header = TRUE)
aug <- read.csv("../output/maxent/models/augavgAIC.csv", header = TRUE)
sep <- read.csv("../output/maxent/models/sepavgAIC.csv", header = TRUE)
oct <- read.csv("../output/maxent/models/octavgAIC.csv", header = TRUE)
nov <- read.csv("../output/maxent/models/novavgAIC.csv", header = TRUE)

mar <- mar$train_AUC
mar <- head(mar, -1)
apr <- apr$train_AUC
apr <- head(apr, -1)
may <- may$train_AUC
may <- head(may, -1)
jun <- jun$train_AUC
jun <- head(jun, -1)
jul <- jul$train_AUC
jul <- head(jul, -1)
aug <- aug$train_AUC
aug <- head(aug, -1)
sep <- sep$train_AUC
sep <- head(sep, -1)
oct <- oct$train_AUC
oct <- head(oct, -1)
nov <- nov$train_AUC
nov <- head(nov, -1)
dec <- dec$train_AUC
dec <- head(dec, -1)

n <- max(length(mar), length(apr), length(may), length(jun), length(jul), length(aug), length(sep), length(oct), length(nov), length(dec))
length(mar) <- n                      
length(apr) <- n
length(may) <- n
length(jun) <- n
length(jul) <- n
length(aug) <- n
length(sep) <- n
length(oct) <- n
length(nov) <- n
length(dec) <- n

trainauc <- cbind(mar, apr, may, jun, jul, aug, sep, oct, nov, dec)
colnames(c) <-c("Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
```

boxplot of cbi

```{r}
dec <- read.csv("../output/maxent/models/decavgAIC.csv", header = TRUE)
mar <- read.csv("../output/maxent/models/maravgAIC.csv", header = TRUE)
apr <- read.csv("../output/maxent/models/apravgAIC.csv", header = TRUE)
may <- read.csv("../output/maxent/models/mayavgAIC.csv", header = TRUE)
jun <- read.csv("../output/maxent/models/junavgAIC.csv", header = TRUE)
jul <- read.csv("../output/maxent/models/julavgAIC.csv", header = TRUE)
aug <- read.csv("../output/maxent/models/augavgAIC.csv", header = TRUE)
sep <- read.csv("../output/maxent/models/sepavgAIC.csv", header = TRUE)
oct <- read.csv("../output/maxent/models/octavgAIC.csv", header = TRUE)
nov <- read.csv("../output/maxent/models/novavgAIC.csv", header = TRUE)

mar <- mar$cbi
mar <- head(mar, -1)
apr <- apr$cbi
apr <- head(apr, -1)
may <- may$cbi
may <- head(may, -1)
jun <- jun$cbi
jun <- head(jun, -1)
jul <- jul$cbi
jul <- head(jul, -1)
aug <- aug$cbi
aug <- head(aug, -1)
sep <- sep$cbi
sep <- head(sep, -1)
oct <- oct$cbi
oct <- head(oct, -1)
nov <- nov$cbi
nov <- head(nov, -1)
dec <- dec$cbi
dec <- head(dec, -1)

n <- max(length(mar), length(apr), length(may), length(jun), length(jul), length(aug), length(sep), length(oct), length(nov), length(dec))
length(mar) <- n                      
length(apr) <- n
length(may) <- n
length(jun) <- n
length(jul) <- n
length(aug) <- n
length(sep) <- n
length(oct) <- n
length(nov) <- n
length(dec) <- n

cbi <- cbind(mar, apr, may, jun, jul, aug, sep, oct, nov, dec)
colnames(c) <-c("Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
```

boxplots of tss scores
```{r}
dec <- read.csv("../output/maxent/models/decavgAIC.csv", header = TRUE)
mar <- read.csv("../output/maxent/models/maravgAIC.csv", header = TRUE)
apr <- read.csv("../output/maxent/models/apravgAIC.csv", header = TRUE)
may <- read.csv("../output/maxent/models/mayavgAIC.csv", header = TRUE)
jun <- read.csv("../output/maxent/models/junavgAIC.csv", header = TRUE)
jul <- read.csv("../output/maxent/models/julavgAIC.csv", header = TRUE)
aug <- read.csv("../output/maxent/models/augavgAIC.csv", header = TRUE)
sep <- read.csv("../output/maxent/models/sepavgAIC.csv", header = TRUE)
oct <- read.csv("../output/maxent/models/octavgAIC.csv", header = TRUE)
nov <- read.csv("../output/maxent/models/novavgAIC.csv", header = TRUE)

mar <- mar$tss
mar <- head(mar, -1)
apr <- apr$tss
apr <- head(apr, -1)
may <- may$tss
may <- head(may, -1)
jun <- jun$tss
jun <- head(jun, -1)
jul <- jul$tss
jul <- head(jul, -1)
aug <- aug$tss
aug <- head(aug, -1)
sep <- sep$tss
sep <- head(sep, -1)
oct <- oct$tss
oct <- head(oct, -1)
nov <- nov$tss
nov <- head(nov, -1)
dec <- dec$tss
dec <- head(dec, -1)

n <- max(length(mar), length(apr), length(may), length(jun), length(jul), length(aug), length(sep), length(oct), length(nov), length(dec))
length(mar) <- n                      
length(apr) <- n
length(may) <- n
length(jun) <- n
length(jul) <- n
length(aug) <- n
length(sep) <- n
length(oct) <- n
length(nov) <- n
length(dec) <- n

tss <- cbind(mar, apr, may, jun, jul, aug, sep, oct, nov, dec)
colnames(c) <-c("Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
```


```{r}
par(mfrow=c(2,2))

boxplot(testauc, xlab = "Month", ylab = "Test AUC Score")
boxplot(trainauc, xlab = "Month", ylab = "Training AUC Score")
boxplot(cbi, xlab = "Month", ylab = "CBI Score")
boxplot(tss, xlab = "Month", ylab = "TSS Score")



```






something went wrong with July aug and sep when averaging the rasters.... redo (error due to layer 120 and coconfusion with the year 2012)

      

```{r avg asc layers cloglog}

tlst <- c("sep1998", "sep1999", "sep2000", "sep2001", "sep2002", "sep2003", "sep2004", "sep2005", "sep2006", "sep2007", "sep2008", "sep2009", "sep2010", "sep2011", "sep2012", "sep2013", "sep2014", "sep2015")



mthna <- "sep"

for(a in length(tlst)){
clogasc_list <- list.files(paste0("../output/maxent/predictions/", mthna), pattern = "^cloglog_.*.asc", full.names = TRUE)
timeslice <- tlst[1]
stdep <- list.files(paste0("../output/maxent/models/", timeslice),  pattern = "^stackdepthlist.*.csv", full.names = TRUE)
stdep <- read.csv(stdep)
depthlayers <- data.frame(cbind(unique(stdep$ascdepths)))
names(depthlayers)[names(depthlayers) == "cbind.unique.stdep.ascdepths.."] <- "depth"
depthlayers$depth <- as.character(depthlayers$depth)

colno <- 1


for (d in 1:nrow(depthlayers)){
  dep <- depthlayers$depth[d]
  for (a in 1:length(clogasc_list)){
    asc <- clogasc_list[a]
    ascd <- str_sub(asc, 50, -5)
    if (grepl(dep, ascd)){
      depthlayers[d , paste0("a", colno)] <- asc
       colno <- colno+1
    }
  }
}
write.csv(depthlayers, (paste0("../output/maxent/predictions/", mthna, "/cloglog_asclayerbydepth.csv")), row.names = TRUE)

}

for (x in 1:nrow(depthlayers)){
  asclay <- depthlayers[x, ]
  asclay <- asclay[!is.na(asclay)]
  asclay <- as.data.frame(rbind(asclay))
  asclay$V1 <- as.character(asclay$V1) #v1 corresponds to depth
  asclay$V2 <- as.character(asclay$V2) #v2 to end corresponds to year
  asclay$V3 <- as.character(asclay$V3)
  asclay$V4 <- as.character(asclay$V4)
  asclay$V5 <- as.character(asclay$V5)
  asclay$V6 <- as.character(asclay$V6)
  asclay$V7 <- as.character(asclay$V7)
  asclay$V8 <- as.character(asclay$V8)
  asclay$V9 <- as.character(asclay$V9)
  asclay$V10 <- as.character(asclay$V10)
  asclay$V11 <- as.character(asclay$V11)
  asclay$V12 <- as.character(asclay$V12)
  asclay$V13 <- as.character(asclay$V13)
  asclay$V14 <- as.character(asclay$V14)
  asclay$V15 <- as.character(asclay$V15)  
  asclay$V16 <- as.character(asclay$V16)  
  asclay$V17 <- as.character(asclay$V17) 
  asclay$V18 <- as.character(asclay$V18)  
  asclay$V19 <- as.character(asclay$V19)  


  
  asclaydep <- asclay$V1
  
  asc1998 <- raster(asclay$V2)
  asc1999 <- raster(asclay$V3)
  asc2000 <- raster(asclay$V4)
  asc2001 <- raster(asclay$V5)
  asc2002 <- raster(asclay$V6)
  asc2003 <- raster(asclay$V7)
  asc2004 <- raster(asclay$V8)
  asc2005 <- raster(asclay$V9)
  asc2006 <- raster(asclay$V10)
  asc2007 <- raster(asclay$V11)
  asc2008 <- raster(asclay$V12)
  asc2009 <- raster(asclay$V13)
  asc2010 <- raster(asclay$V14)
  asc2011 <- raster(asclay$V15)
  asc2012 <- raster(asclay$V16)
  asc2013 <- raster(asclay$V17)
  asc2014 <- raster(asclay$V18)
  asc2015 <- raster(asclay$V19)



  stkasc <- stack(asc1998, asc1999, asc2000, asc2001, asc2002, asc2003, asc2004, asc2005, asc2006, asc2007, asc2008, asc2009, asc2010, asc2011, asc2012, asc2013, asc2014, asc2015)

  avg <- mean(stkasc, na.rm = TRUE)
  
  writeRaster(avg, paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_", asclaydep, ".asc"), overwrite=TRUE)
  avgplot <- plot(avg, png(paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_", asclaydep, ".png"))) 
  dev.off()

}

```

     
#Threshold tables
```{r}
thlst1 <- list.files(paste0("../output/maxent/models"), pattern = ".*avgAIC.csv", full.names = TRUE)
thlst2 <- list.files(paste0("../output/maxent/models"), pattern = ".*avgmaxentresults.csv", full.names = TRUE) 

for (m in 1:length(thlst1)){
    mth <- thlst1[m]
    mth <- str_sub(mth, 25, -11) #extract first 3 digit
    t1 <- read.csv(thlst1[m], header = TRUE)
    t1 <- t1[-nrow(t1), -1 ]
    t2 <- read.csv(thlst2[m], header = TRUE)
    t2 <- t2[-nrow(t2), -1]
    a <- subset(t1, select = c("test_maxsumsenspec", "test_equal_sens_spec", "mpa_0.9_clog"))
    b <- subset(t2, select = c("Minimum.training.presence.Cloglog.threshold", "X10.percentile.training.presence.Cloglog.threshold"))
    c <- cbind(a, b)
    colnames(c) <- c("MaxSS", "ESS", "MPA", "MTP", "P10TP")
    d <- summary(c)
    write.csv(t(as.matrix(d)), file= paste0("../output/maxent/models/summary_test_", mth, ".csv")) 
}


thlst <- list()
for (m in 1:length(thlst1)){
    mth <- thlst1[m]
    mth <- str_sub(mth, 25, -11) #extract first 3 digit
    t1 <- read.csv(thlst1[m], header = TRUE)
    t1 <- t1[-nrow(t1), -1 ]
    t2 <- read.csv(thlst2[m], header = TRUE)
    t2 <- t2[-nrow(t2), -1]
    a <- subset(t1, select = c("test_maxsumsenspec", "test_equal_sens_spec", "mpa_0.9_clog"))
    b <- subset(t2, select = c("Minimum.training.presence.Cloglog.threshold", "X10.percentile.training.presence.Cloglog.threshold"))
    ca <- cbind(a, b)
    colnames(ca) <- c("MaxSS", "ESS", "MPA", "MTP", "P10")
    ca$month <- mth

    thlst[[m]] <- ca
  }

stdep <- do.call(rbind, thlst)
stdep <- stdep[!(stdep$month == "jan"), ] #removes jan because you're not doing jan


p10p <- ggplot(data=stdep, aes(x=month, y=P10, fill=month)) + geom_boxplot() + stat_summary(fun.y=mean, colour="darkred", geom="point", shape=18, size=3) + theme(legend.position = "none")
mtpp <- ggplot(data=stdep, aes(x=month, y=MTP, fill=month)) + geom_boxplot() + stat_summary(fun.y=mean, colour="darkred", geom="point", shape=18, size=3) + theme(legend.position = "none")
plot(l)
mpap <- ggplot(data=stdep, aes(x=month, y=MPA, fill=month)) + geom_boxplot() + stat_summary(fun.y=mean, colour="darkred", geom="point", shape=18, size=3) + theme(legend.position = "none")
essp <- ggplot(data=stdep, aes(x=month, y=ESS, fill=month)) + geom_boxplot() + stat_summary(fun.y=mean, colour="darkred", geom="point", shape=18, size=3) + theme(legend.position = "none")
maxss <- ggplot(data=stdep, aes(x=month, y=MaxSS, fill=month)) + geom_boxplot() + stat_summary(fun.y=mean, colour="darkred", geom="point", shape=18, size=3) + theme(legend.position = "none")

plot_grid(p10p, mtpp, mpap, essp, maxss, labels = "AUTO")



library(reshape2)
k <- melt(stdep, id.var = c('month'), variable.name = 'threshold')
n <- subset(k, month == "aug")
o <- subset(k, month == "mar")

library(cowplot)
p <-ggplot(data=n, aes(x=threshold, y=value, fill=threshold)) + geom_boxplot() + stat_summary(fun.y=mean, colour="darkred", geom="point", shape=18, size=3) + theme(legend.position = "none")
q <-ggplot(data=o, aes(x=threshold, y=value, fill=threshold)) + geom_boxplot() + stat_summary(fun.y=mean, colour="darkred", geom="point", shape=18, size=3) + theme(legend.position = "none")
plot_grid(p, q, labels = "AUTO")




tsum <- stdep %>% # Start by defining the original dataframe, AND THEN...
                group_by(month) %>% # Define the grouping variable, AND THEN...
                summarise( # Now you define your summary variables with a name and a function...
                          maxss.mean = mean(MaxSS), mtp.mean = mean(MTP), ess.mean = mean(ESS), mpa.mean = mean(MPA), mean.p10 = mean(P10))

tsum
```

stacked maps
https://urbandemographics.blogspot.com/2016/04/creating-tilted-and-stacked-maps-in-r.html


```{r}
# load libraries
  library(rgeos)
  library(UScensus2000tract)
  library(ggplot2)
  library(dplyr)
  library(RColorBrewer)

# load data
  data("oregon.tract")

# plot Census Tract map
  plot(oregon.tract)
  
oregon.tract$id=as.character(1:nrow(oregon.tract))



clogasc_list <- list.files(paste0("../output/maxent/all_data/predictions/july"), pattern = "^avg_.*.asc", full.names = TRUE) # first list the files containing the data
a <- stack(clogasc_list) #stack the files

```
ok scrap tilt just do standard

need to add seabed

```{r seabed files}
slst <- list.files("../data/env/ascii/ascii2010", pattern = "temp", full.names = TRUE)
sr <- raster(slst[1])
plot(sr)
```



```{r}
aea <- raster("../output/env/aea.tif") #the correct CRS
maplst <- list.files("../output/maxent/predictions/may", pattern = "^avg_clog.*.asc", full.names = TRUE)
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
apr <- aea@crs
brk <- seq(0, 1, 0.1) #for legend
lgc <- sequential_hcl(10, palette = "YlOrRd") #colour scheme from colorspace package
redtrans <- rgb(218, 215, 216, 120, maxColorValue=255) #mcp
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis



  pras6 <- raster(maplst[37])
  pras180 <- raster(maplst[14])
  pras370 <- raster(maplst[28])
  pras697 <- raster(maplst[41])
  crs(pras6) <- apr
  crs(pras180) <- apr
  crs(pras370) <- apr
  crs(pras697) <- apr
  ascname6 <- names(pras6)
  ascname180 <- names(pras180)
  ascname370 <- names(pras370)
  ascname697 <- names(pras697)
  
  
par(mfrow=c(1,4))


  lp6 <- plot(pras6, breaks=brk,  col=rev(lgc), axes = FALSE, box = FALSE, legend = FALSE)
  lp6 <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp6 <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  
  lp180 <- plot(pras180, breaks=brk,  col=rev(lgc), axes = FALSE, box = FALSE, legend = FALSE)
  lp180 <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp180 <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  
  lp370 <- plot(pras370, breaks=brk,  col=rev(lgc), axes = FALSE, box = FALSE, legend = FALSE)
  lp370 <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp370 <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  
  lp697 <- plot(pras697, breaks=brk,  col=rev(lgc), axes = FALSE, box = FALSE, legend = TRUE)
  lp697 <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp697 <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  
  print(lp6)
  dev.copy(png, (paste0("../output/maxent/all_data/predictions/testplots/", ascname6, ".png")), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
#}
  
  
  print(lp5)
  dev.copy(png, (paste0("../output/maxent/all_data/predictions/", ascname5, ".png")), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
#}
  

  
```

as above but with rcolorbrewer
```{r}
lp6 <- plot(pras6, breaks=brk, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = TRUE)
  lp6 <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp6 <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  
  lp180 <- plot(pras180, breaks=brk, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = TRUE)
  lp180 <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp180 <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  
  lp370 <- plot(pras370, breaks=brk, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = TRUE)
  lp370 <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp370 <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  
  lp697 <- plot(pras697, breaks=brk, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = TRUE)
  lp697 <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp697 <- plot(s, col = "#474646", border = "#474646", add = TRUE)
```


with rastervis

```{r}
library(raster)
library(rgdal)
library(rasterVis)
library(colorspace)

aea <- raster("../output/env/aea.tif") #the correct CRS
maplst <- list.files("../output/maxent/predictions/may", pattern = "^avg_clog.*.asc", full.names = TRUE)
maplst2 <- list.files("../output/maxent/predictions/sep", pattern = "^avg_clog.*.asc", full.names = TRUE)
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
apr <- aea@crs
brk <- seq(0, 1, 0.1) #for legend
lgc <- sequential_hcl(10, palette = "YlOrRd") #colour scheme from colorspace package
redtrans <- rgb(218, 215, 216, 120, maxColorValue=255) #mcp
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis

pras6 <- raster(maplst[37])
pras180 <- raster(maplst[14])
pras370 <- raster(maplst[28])
pras697 <- raster(maplst[41])
p2ras6 <- raster(maplst2[37])
p2ras180 <- raster(maplst2[14])
p2ras370 <- raster(maplst2[28])
p2ras697 <- raster(maplst2[41])
crs(pras6) <- apr
crs(pras180) <- apr
crs(pras370) <- apr
crs(pras697) <- apr
crs(p2ras6) <- apr
crs(p2ras180) <- apr
crs(p2ras370) <- apr
crs(p2ras697) <- apr
ascname6 <- names(pras6)
ascname180 <- names(pras180)
ascname370 <- names(pras370)
ascname697 <- names(pras697)
a2scname6 <- names(p2ras6)
a2scname180 <- names(p2ras180)
a2scname370 <- names(p2ras370)
a2scname697 <- names(p2ras697)

# pstack <- stack(pras6, pras180, pras370, pras697) #stack the layers
# 
# pras1 <- raster(maplst[1])
# pras2 <- raster(maplst[2])
# pras3 <- raster(maplst[3])
# pras4 <- raster(maplst[4])
# crs(pras1) <- apr
# crs(pras2) <- apr
# crs(pras3) <- apr
# crs(pras4) <- apr

pstack <- stack(pras6, pras180, pras370, pras697, p2ras6, p2ras180, p2ras370, p2ras697) #stack the layers

cls <- c("6m", "180m", "370m", "697m")
rws <- c("May", "Sep")
mapTheme <- rasterTheme(region = rev(brewer.pal(10,"RdYlGn")))
my.at <- seq(0, 1, by = 0.1)


p <- levelplot(pstack, ylab = NULL, xlab = NULL, scales=list(draw=FALSE), colorkey=list(space="bottom", at = my.at), par.settings = mapTheme, layout = c(4, 2), names.attr = c("6m", "180m", "370m", "697m", "", "", "", ""), margin = FALSE)
p + layer(sp.polygons(s, fill = "black")) + layer (sp.polygons(outsidemcp, fill = redtrans, col = NA))


#dev.copy(png, (paste0("../output/maxent/predictions/testplots/rasterVis.png")), width = 1920,height = 1080)
#dev.off() # stops automatic saving of the plot to a png))



```

```{r}
histogram(pstack)
densityplot(pstack)
bwplot(pstack)
```


try hovmoller plotting for depth time

```{r}
#think i need to create a 4d raster with depth and time...
library(ncdf4)

writeRaster(pstack, "../output/maxent/predictions/testplots/pstack.nc", overwrite = TRUE, format = "CDF", varname = "prob", varunit = "p", longname = "dummy netcdf for hovmollers", xname= "X", yname = "Y", zname = "date", zunit = "date")

```



```{r}
pras6 <- raster::setZ(pras6, as.Date("0000-1-1"), name = "time")
pras180 <- raster::setZ(pras180, as.Date("0000-1-1"), name = "time")
pras370 <- raster::setZ(pras370, as.Date("0000-1-1"), name = "time")
pras697 <- raster::setZ(pras697, as.Date("0000-1-1"), name = "time")
pras1 <- raster::setZ(pras1, as.Date("0000-2-1"), name = "time")
pras2 <- raster::setZ(pras2, as.Date("0000-2-1"), name = "time")
pras3 <- raster::setZ(pras3, as.Date("0000-2-1"), name = "time")
pras4 <- raster::setZ(pras4, as.Date("0000-2-1"), name = "time")
```




```{r}
library(zoo)

old <- setwd(tempdir())
download.file('https://raw.github.com/oscarperpinan/spacetime-vis/master/data/SISmm2008_CMSAF.zip',
'SISmm2008_CMSAF.zip', method='wget')
unzip('SISmm2008_CMSAF.zip')
listFich <- dir(pattern='\\.nc')
stackSIS <- stack(listFich)
stackSIS <- stackSIS*24 ##from irradiance (W/m2) to irradiation Wh/m2



pbrick <- brick(pras6, pras180, pras370, pras697, pras1, pras2, pras3, pras4) #stack the layers

```

ok new play - try creating an individual netcdf for a month...
```{r}
plst <- list.files("../output/maxent/predictions/testplots/testrasters", full.names = TRUE)
aea <- raster("../output/env/aea.tif") #the correct CRS
apr <- aea@crs

i = 1

thlst <- list()
anlst <- list()
for (i in 1:length(plst)){
  r <- raster(plst[i])
  aname <- names(r)
  aname <-  str_sub(aname, 13)
  r <- setZ(r, as.numeric(aname), name = "depth")
  crs(r) <- apr
  thlst[[i]] <- r
  anlst[i] <- aname
}

nstk <- stack(thlst)
nstk <- setZ(nstk, anlst, name = "depth")

writeRaster(r, "../output/maxent/predictions/testplots/lstk2.nc", overwrite = TRUE, format = "CDF", varname = "prob", varunit = "p", longname = "dummy netcdf for hovmollers", xname= "X", yname = "Y", zname = "depth", zunit = "m")



dirXY <- xyLayer(r, sqrt(x^2 + y^2))
library(zoo)


hovmoller(nstk,
          at = seq(0, 1, .1),
                    interpolate = FALSE,
          par.settings = BuRdTheme)

hovmoller(nstk, ylab ="depth", interpolate = FALSE)

```


try create empty netcdf



```{r}
data.time <- 3:12 #months

#get depths
dep <- read.csv("../output/maxent/models/apr1998/stackdepthlist_1998.csv", header = TRUE)
dep <- dep$ascdepths

lon <- seq( -999722.7, 1525277, by = 25000)
lat <- seq ( 3538427, -211573.1, by = -25000)

data.distance <- seq(-65,920, by=5)
## Add dimensions and variables which accompany the dimensions (avoided by create_dimvar = FALSE)
dimDepth <- ncdim_def(name='depth', units='m', longname='depth layer', vals=data.distance )
dimTime <- ncdim_def('time', units='month', longname='measurement month', calendar="standard", vals=data.time)


varLat <- ncvar_def(name='lat', units='meters_north', dim=list(lat), missval=NA, longname='lat_m', prec='double')
varLon <- ncvar_def(name='lon', units='meters_east', dim=list(lon), missval=NA, longname='lon_m', prec='double')

varAlt <- ncvar_def(name='depth', units='m', dim=list(dimDepth, dimTime), missval=-9999, longname='depth layer')

vars <- list(varLat, varLon, varAlt)

outputfile <- 'transect.nc'
con <- nc_create(outputfile, vars)

```


#argh
```{r}
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis

clogasc_list <- list.files(paste0("../output/maxent/predictions/dec"), pattern = "^avg_cloglog_.*.asc", full.names = TRUE) #just choose a random month to calculate cells
cumst <- data.frame(0, 0)
colnames(cumst) <- c("depth", "no_cells")
for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[6])
  ascname <- names(cumasc)
  cumst[cum, 1] <- str_sub(ascname, 13)
  cumasc2 <- raster::mask(cumasc, outsidemcp, inverse = TRUE)
  ccnt <- freq(cumasc2, useNA='no')
  ccnt <- sum(ccnt[ ,2])
  cumst[cum, 2] <- ccnt
}


clogasc_listm <- list.files(paste0("../output/maxent/predictions/mar"), pattern = "^avg_cloglog_.*.asc", full.names = TRUE) #just choose a random month to calculate cells
cumstm <- data.frame(0, 0)
colnames(cumstm) <- c("depth", "no_cells")
for (cum in 1:length(clogasc_listm)){
  cumascm <- raster(clogasc_listm[6])
  ascnamem <- names(cumascm)
  cumstm[cum, 1] <- str_sub(ascnamem, 13)
  cumasc2m <- raster::mask(cumascm, outsidemcp, inverse = TRUE)
  ccntm <- freq(cumasc2, useNA='no')
  ccntm <- sum(ccntm[ ,2])
  cumstm[cum, 2] <- ccntm
}





cumst$depth <- as.numeric(cumst$depth)
cumst1 <- cumst[order(cumst$no_cells), ]

write.csv(cumst1, "../output/maxent/paper_plots/prob_by_depth/cellsperlayermar.csv", row.names = FALSE)

```




```{r avg asc layers cloglog xx}
#p <- read.csv("../output/bio/presab_nafo_yr.csv", header= TRUE)
mthna <- "nov"
mthno <- "11"
prback <- subset(p, month == mthno)
modelmonth <- cbind(paste0(mthna, unique(prback$year)))
timeslice <- modelmonth[1]

clogasc_list <- list.files(paste0("../output/maxent/predictions/", mthna), pattern = "^cloglog_.*.asc", full.names = TRUE)
stlst <- list.files(paste0("../output/maxent/models/", timeslice), pattern = "stackdepth.*.csv", full.names = TRUE)
stdep <- read.csv(stlst[1])
stdep$ascdepths <- str_sub(stdep$stackname, 9)
depthlayers <- data.frame(cbind(unique(stdep$ascdepths)))
names(depthlayers)[names(depthlayers) == "cbind.unique.stdep.ascdepths.."] <- "depth"
depthlayers$depth <- as.character(depthlayers$depth)

colno <- 1


for (d in 1:nrow(depthlayers)){
  dep <- depthlayers$depth[d]
  for (a in 1:length(clogasc_list)){
    asc <- clogasc_list[a]
    ascd <- str_sub(asc, 50, -5)
    if (grepl(dep, ascd)){
      depthlayers[d , paste0("a", colno)] <- asc
       colno <- colno+1
    }
  }
}
write.csv(depthlayers, (paste0("../output/maxent/predictions/", mthna, "/cloglog_asclayerbydepth.csv")), row.names = TRUE)



for (x in 1:nrow(depthlayers)){
  asclay <- depthlayers[x, ]
  asclay <- asclay[!is.na(asclay)]
  asclay <- as.data.frame(rbind(asclay))
  asclay$V1 <- as.character(asclay$V1) #v1 corresponds to depth
  asclay$V2 <- as.character(asclay$V2) #v2 to end corresponds to year
  asclay$V3 <- as.character(asclay$V3)
  asclay$V4 <- as.character(asclay$V4)
  asclay$V5 <- as.character(asclay$V5)
  asclay$V6 <- as.character(asclay$V6)
  asclay$V7 <- as.character(asclay$V7)
  asclay$V8 <- as.character(asclay$V8)
  asclay$V9 <- as.character(asclay$V9)
  asclay$V10 <- as.character(asclay$V10)
  asclay$V11 <- as.character(asclay$V11)
  asclay$V12 <- as.character(asclay$V12)
  asclay$V13 <- as.character(asclay$V13)
  asclay$V14 <- as.character(asclay$V14)
  asclay$V15 <- as.character(asclay$V15)
  asclay$V16 <- as.character(asclay$V16)
  asclay$V17<- as.character(asclay$V17)
  # asclay$V18 <- as.character(asclay$V18)
  # asclay$V19<- as.character(asclay$V19)

  
  asclaydep <- asclay$V1
  
  asc1998 <- raster(asclay$V2)
  asc1999 <- raster(asclay$V3)
  asc2000 <- raster(asclay$V4)
  asc2001 <- raster(asclay$V5)
  asc2002 <- raster(asclay$V6)
  asc2003 <- raster(asclay$V7)
  asc2004 <- raster(asclay$V8)
  asc2005 <- raster(asclay$V9)
  asc2006 <- raster(asclay$V10)
  asc2007 <- raster(asclay$V11)
  asc2008 <- raster(asclay$V12)
  asc2009 <- raster(asclay$V13)
  asc2010 <- raster(asclay$V14)
  asc2011 <- raster(asclay$V15)
  asc2012 <- raster(asclay$V16)
  asc2013 <- raster(asclay$V17)
  # asc2014 <- raster(asclay$V18)
  # asc2015 <- raster(asclay$V19)


  stkasc <- stack(asc1998, asc1999, asc2000, asc2001, asc2002, asc2003, asc2004, asc2005, asc2006, asc2007, asc2008, asc2009, asc2010, asc2011, asc2012, asc2013) #, asc2014, asc2015)

  avg <- mean(stkasc, na.rm = TRUE)
  
  writeRaster(avg, paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_", asclaydep, ".asc"), overwrite=TRUE)
  avgplot <- plot(avg, png(paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_", asclaydep, ".png"))) 
  dev.off()
  
file.rename(paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_000120.asc"), paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_120.asc"))
file.rename(paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_000120.png"), paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_120.png"))
file.rename(paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_041.18.asc"), paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_41.18.asc"))
file.rename(paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_041.18.png"), paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_41.18.png"))
}

```



#2d hotspot maps

first create layers that are 0.5 and above

```{r habitat classification on probability - >0.5}

binprob <- function(x){
  ifelse(x >= 0.5, 1,
  ifelse(x < 0.5, 0, NA)) 
}

mthord <- c("mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")

for (m in 1:length(mthord)){
  mthna <- mthord[m]
  clogasc_list <- list.files(paste0("../output/maxent/predictions/", mthna), pattern = "^avg_cloglog_.*asc", full.names = TRUE)
  for (cum in 1:length(clogasc_list)){
    cumasc <- raster(clogasc_list[cum])
    ascname <- names(cumasc)
    ascname <- gsub("avg_cloglog_", "", ascname)
    probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
    writeRaster(probbin, paste0("../output/maxent/paper_plots/hotspot_mapping/", mthna,  "_binary_0.5_", ascname, ".asc"), overwrite = TRUE)
     plot(probbin, png(paste0("../output/maxent/paper_plots/hotspot_mapping/", mthna, "_binary_0.5_", ascname, ".png")), overwrite = TRUE)
       dev.off() # stops automatic saving of the plot to a png
  }
}

```

then create an summary map....
```{r high probability map per year 2D representation}
mthord <- c("mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")

for (m in 1:length(mthord)){
  mthna <- mthord[m]
  binaryprob_list <- list.files(paste0("../output/maxent/paper_plots/hotspot_mapping/"), pattern = paste0(mthna, "*_binary_0.5_.*.asc$"), full.names = TRUE)
  binstack <- stack(binaryprob_list)
  stacksum <- sum(binstack, na.rm = TRUE)
  writeRaster(stacksum, paste0("../output/maxent/paper_plots/hotspot_mapping/", mthna, "_bin_0.5_2d.asc"), overwrite=TRUE)
  plot(stacksum, png(paste0("../output/maxent/paper_plots/hotspot_mapping/", mthna, "_bin_0.5_2d.png")))
  dev.off()
}

```

#trimming maps to mcp


```{r}
library(viridis)
library(rasterVis)

aea <- raster("../output/env/aea.tif") #the correct CRS
maplst <- list.files("../output/maxent/paper_plots/hotspot_mapping/", pattern = "_bin_0.5_2d.*.asc", full.names = TRUE)
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
apr <- aea@crs
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
mcp <- shapefile("../output/bio/minimum_convex_poly/mcp_capelin_100_poly.shp")

cumasc <- raster(maplst[1])
cumasc2 <- raster(maplst[2])
cumasc <- raster::mask(cumasc, mcp)
cumasc2 <- raster::mask(cumasc2, mcp)
ss <- raster::intersect(s, mcp) 


pstack <- stack(cumasc, cumasc2)

my.at <- seq(0, 1, by = 0.1)
mapTheme <- viridisTheme(region = viridis(10), direction = -1)



p <- levelplot(pstack, ylab = NULL, xlab = NULL, scales=list(draw=FALSE), colorkey=list(space="bottom", at = my.at), par.settings = mapTheme, layout = c(2, 1), names.attr = c("6m", "180m"), margin = FALSE) + layer(sp.polygons(ss, fill = "red")) 
plot(p)


pm <- ggplot(mar, aes(Depth, p_cells, fill = Probability)) + geom_col(width = 1) + coord_flip() + scale_fill_viridis(option="viridis", discrete = TRUE, direction = -1) + scale_x_discrete(limits = flevelsm, breaks=flevelsm[seq(1,length(flevelsm), by = 2)], ) + coord_flip() + labs(y = "% Ocean at Depth", title = "March") + theme_half_open(12) + theme(plot.margin = margin(6, 0, 6, 0)) 


```