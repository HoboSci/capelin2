---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
presback <- read.csv("../output/bio/presab_nafo_yr.csv", header = TRUE)
presences <- subset(presback, occurrence == "1") #splits the testing dataset into presences
un_mth <- unique(presences$month)
prrows <- length(presences)
presences$season <- 5


for (i in 1:nrow(presences)){
  if (presences$month[i] >= 1 & presences$month[i] <= 3){
    presences$season[i] <- 1
    } else if (presences$month[i] >= 4 & presences$month[i] <= 6){
    presences$season[i] <- 2
    } else if (presences$month[i] >= 7 & presences$month[i] <= 9){
    presences$season[i] <- 3
    } else if (presences$month[i] >= 10 & presences$month[i] <= 12){
    presences$season[i] <- 4
  }
}

write.csv(presences, "../output/bio/cluster_seasons_test.csv", row.names = FALSE)

names(presences)

pres <- subset(presences, select = c(year, month, temp_depth, salinity_depth, o2_depth, chl_surface, nao_sample, nao_prev, nao_winter, amo_sample, amo_winter, season))
pres <- na.omit(pres)
pres2 <- na.omit(presences)
pres <- scale(pres)
```

```{r}

library("cluster")
library("factoextra")
library("magrittr")
```

```{r}
distance <- get_dist(pres)
fviz_dist(distance, gradient = list(low = "#00AFBB", mid = "white", high = "#FC4E07"))
```


```{r}
fviz_nbclust(pres, kmeans, method = "gap_stat")
```

```{r}
set.seed(123)
km.res <- kmeans(pres, 6, nstart = 25)
km.res
# Visualize
library("factoextra")
fviz_cluster(km.res, data = pres,
             ellipse.type = "convex",
             palette = "jco",
             ggtheme = theme_minimal())
```

```{r}
library("cluster")
pam.res <- pam(pres, 6)
# Visualize
fviz_cluster(pam.res)
```




```{r}
library(rworldmap)
pres2wi <- subset(pres2, season == "1")
pres2sp <- subset(pres2, season == "2")
pres2su <- subset(pres2, season == "3")
pres2au <- subset(pres2, season == "4")
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "pres2wi", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(pres2wi$decimalLongitude, pres2wi$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
points(pres2sp$decimalLongitude, pres2sp$decimalLatitude, col = "blue") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
points(pres2su$decimalLongitude, pres2su$decimalLatitude, col = "green") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
points(pres2au$decimalLongitude, pres2au$decimalLatitude, col = "yellow") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
```

```{r}
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "winter", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(pres2wi$decimalLongitude, pres2wi$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
```


```{r}
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "spring", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(pres2sp$decimalLongitude, pres2sp$decimalLatitude, col = "blue") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")

```


```{r}
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "summer", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(pres2su$decimalLongitude, pres2su$decimalLatitude, col = "green") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
```



```{r}
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "autumn", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(pres2au$decimalLongitude, pres2au$decimalLatitude, col = "yellow") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
```

```{r}
p98 <- subset(pres2, year == "1998")
p99 <- subset(pres2, year == "1999")
p00 <- subset(pres2, year == "2000")
p01 <- subset(pres2, year == "2001")
p02 <- subset(pres2, year == "2002")
p03 <- subset(pres2, year == "2003")
p04 <- subset(pres2, year == "2004")
p05 <- subset(pres2, year == "2005")
p06 <- subset(pres2, year == "2006")
p07 <- subset(pres2, year == "2007")
p08 <- subset(pres2, year == "2009")
p09 <- subset(pres2, year == "2009")
p10 <- subset(pres2, year == "2010")
p11 <- subset(pres2, year == "2011")
p12 <- subset(pres2, year == "2012")
p13 <- subset(pres2, year == "2013")
p14 <- subset(pres2, year == "2014")
p15 <- subset(pres2, year == "2015")

```


```{r}
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "1998", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p98$decimalLongitude, p98$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_1998.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "1999", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p99$decimalLongitude, p99$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_1999.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2000", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p00$decimalLongitude, p00$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2000.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2001", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p01$decimalLongitude, p01$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2001.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2002", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p02$decimalLongitude, p02$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2002.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2003", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p03$decimalLongitude, p03$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2003.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2004", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p04$decimalLongitude, p04$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2004.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2005", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p05$decimalLongitude, p05$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2005.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2006", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p06$decimalLongitude, p06$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2006.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2007", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p07$decimalLongitude, p07$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2007.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2008", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p08$decimalLongitude, p08$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2008.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2009", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p09$decimalLongitude, p09$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2009.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2010", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p10$decimalLongitude, p10$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2010.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2011", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p11$decimalLongitude, p11$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2011.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2012", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p12$decimalLongitude, p12$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2012.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2013", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p13$decimalLongitude, p13$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2013.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2014", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p14$decimalLongitude, p14$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2014.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2015", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p15$decimalLongitude, p15$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2015.png") #this prints a png of the plot
dev.off() #this turns off the print command
```



```{r}
df <- iris
df <- na.omit(df)
df <- scale(df[ ,-5])


# Dissimilarity matrix
d <- dist(df, method = "euclidean")

# Hierarchical clustering using Complete Linkage
hc1 <- hclust(d, method = "complete" )

# Plot the obtained dendrogram
plot(hc1, cex = 0.6, hang = -1)
```

```{r}
iris2 <- pres[ ,-12]
species_labels <- pres[ ,12]
library(colorspace) # get nice colors
species_col <- rev(rainbow_hcl(4))[as.numeric(species_labels)]

# Plot a SPLOM:
pairs(iris2, col = species_col,
      lower.panel = NULL,
       cex.labels=2, pch=19, cex = 1.2)

# Add a legend
par(xpd = TRUE)
legend(x = 0.05, y = 0.4, cex = 2,
   legend = as.character(levels(species_labels)),
    fill = unique(species_col))
par(xpd = NA)
```

```{r}
par(las = 1, mar = c(4.5, 3, 3, 2) + 0.1, cex = .8)
MASS::parcoord(iris2, col = species_col, var.label = TRUE, lwd = 2)

# Add Title
title("Parallel coordinates plot of the Iris data")
# Add a legend
par(xpd = TRUE)
legend(x = 1.75, y = -.25, cex = 1,
   legend = as.character(levels(species_labels)),
    fill = unique(species_col), horiz = TRUE)
```


```{r}
d_iris <- dist(iris2) # method="man" # is a bit better
hc_iris <- hclust(d_iris, method = "complete")
iris_species <- rev(levels(pres[,12]))

library(dendextend)
dend <- as.dendrogram(hc_iris)
# order it the closest we can to the order of the observations:
dend <- rotate(dend, 1:6361)

# Color the branches based on the clusters:
dend <- color_branches(dend, k=4) #, groupLabels=iris_species)

# Manually match the labels, as much as possible, to the real classification of the flowers:
labels_colors(dend) <-
   rainbow_hcl(3)[sort_levels_values(
      as.numeric(pres[,12])[order.dendrogram(dend)]
   )]

# We shall add the flower type to the labels:
labels(dend) <- paste(as.character(iris[,5])[order.dendrogram(dend)],
                           "(",labels(dend),")", 
                           sep = "")
# We hang the dendrogram a bit:
dend <- hang.dendrogram(dend,hang_height=0.1)
# reduce the size of the labels:
# dend <- assign_values_to_leaves_nodePar(dend, 0.5, "lab.cex")
dend <- set(dend, "labels_cex", 0.5)
# And plot:
par(mar = c(3,3,3,7))
plot(dend, 
     main = "Clustered Iris data set
     (the labels give the true flower species)", 
     horiz =  TRUE,  nodePar = list(cex = .007))
legend("topleft", legend = iris_species, fill = rainbow_hcl(3))
```

```{r}
library(circlize)
par(mar = rep(0,4))
circlize_dendrogram(dend)
```


```{r}
iris3 <- pres[ ,-2]
species_labels <- pres[ ,2]
library(colorspace) # get nice colors
species_col <- rev(rainbow_hcl(12))[as.numeric(species_labels)]

# Plot a SPLOM:
pairs(iris3, col = species_col,
      lower.panel = NULL,
       cex.labels=2, pch=19, cex = 1.2)

# Add a legend
par(xpd = TRUE)
legend(x = 0.05, y = 0.4, cex = 2,
   legend = as.character(levels(species_labels)),
    fill = unique(species_col))
par(xpd = NA)
```

```{r}
d_iris2 <- dist(pres) # method="man" # is a bit better
hc_iris2 <- hclust(d_iris2, method = "complete")
iris_species2 <- rev(levels(pres[,12]))

library(dendextend)
dend2 <- as.dendrogram(hc_iris2)
# order it the closest we can to the order of the observations:
dend2 <- rotate(dend2, 1:6361)

# Color the branches based on the clusters:
dend2 <- color_branches(dend2, k=4) #, groupLabels=iris_species)

# Manually match the labels, as much as possible, to the real classification of the flowers:
labels_colors(dend2) <-
   rainbow_hcl(3)[sort_levels_values(
      as.numeric(pres[,12])[order.dendrogram(dend2)]
   )]

# We shall add the flower type to the labels:
labels(dend2) <- paste(as.character(iris[,5])[order.dendrogram(dend2)],
                           "(",labels(dend2),")", 
                           sep = "")
# We hang the dendrogram a bit:
dend2 <- hang.dendrogram(dend2,hang_height=0.1)
# reduce the size of the labels:
# dend <- assign_values_to_leaves_nodePar(dend, 0.5, "lab.cex")
dend22 <- set(dend2, "labels_cex", 0.5)
# And plot:
par(mar = c(3,3,3,7))
plot(dend2, 
     main = "Clustered Iris data set
     (the labels give the true flower species)", 
     horiz =  TRUE,  nodePar = list(cex = .007))
legend("topleft", legend = species_labels, fill = rainbow_hcl(3))
```


```{r}
library(circlize)
par(mar = rep(0,4))
circlize_dendrogram(dend2)
```


# violin plots

```{r}
#load a test raster

ras <- raster("../output/maxent/predictions/apr/cloglog_st201004000120.asc")
plot(ras)
ras2 <- raster("../output/maxent/predictions/oct/cloglog_st201010000120.asc")
plot(ras2)
rasd <- as.data.frame(ras)
rasd$month <- "4"
rasd2 <- as.data.frame(ras2)
rasd2$month <- "10"
names(rasd)[names(rasd) == "cloglog_st201004000120"] <- "prob"
names(rasd2)[names(rasd2) == "cloglog_st201010000120"] <- "prob"
rasd$month <- as.factor(rasd$month)
rasd2$month <- as.factor(rasd2$month)
rd <- rbind(rasd, rasd2)
rd
p <- ggplot(rd, aes(x=month, y = prob)) + geom_violin(trim=FALSE)
plot(p)


mth <- c("jan", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")
for (m in 1:length(mth)){
  mon <- mth[m]
  vlst <- list.files(paste0("../output/maxent/predictions/", mon), pattern = "^avg_cloglog.*.asc", full.names = TRUE)
  for (v in 1:length(vlst)){
    ras <- raster(vlst[v])
    rasd <- as.data.frame(ras)
    if (mon == "jan"){
      rasd$month <- "1"
      rnm <- names(ras)
      names(rasd)[names(rasd) == rnm] <- "prob"
      rasd$month <- as.factor(rasd$month)
      rd1 <- rasd
      } else if(mon == "mar"){
        rasd$month <- "3"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd3 <- rasd
      } else if(mon == "apr"){
        rasd$month <- "4"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd4 <- rasd
      } else if(mon == "may"){
        rasd$month <- "5"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd5 <- rasd
      } else if(mon == "jun"){
        rasd$month <- "6"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd6 <- rasd
      } else if(mon == "jul"){
        rasd$month <- "7"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd7 <- rasd
      } else if(mon == "aug"){
        rasd$month <- "8"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd8 <- rasd
      } else if(mon == "sep"){
        rasd$month <- "9"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd9 <- rasd
      } else if(mon == "oct"){
        rasd$month <- "10"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd10 <- rasd
      } else if(mon == "nov"){
        rasd$month <- "11"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd11 <- rasd
      } else if(mon == "dec"){
        rasd$month <- "12"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd12 <- rasd
      }
   
      rd <- cbind(rd1, rd3, rd4, rd5, rd6, rd7, rd8, rd9, rd10, rd11, rd12)
    #rd <- as.data.frame(rd)
    #rd$month <- as.factor(rd$month)
  }
 
p <- ggplot(rd2, aes(x=month, y = prob)) + geom_violin(trim=FALSE)
plot(p)

}






```

