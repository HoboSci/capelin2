---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
presback <- read.csv("../output/bio/presab_nafo_yr.csv", header = TRUE)
presences <- subset(presback, occurrence == "1") #splits the testing dataset into presences
un_mth <- unique(presences$month)
prrows <- length(presences)
presences$season <- 5


for (i in 1:nrow(presences)){
  if (presences$month[i] >= 1 & presences$month[i] <= 3){
    presences$season[i] <- 1
    } else if (presences$month[i] >= 4 & presences$month[i] <= 6){
    presences$season[i] <- 2
    } else if (presences$month[i] >= 7 & presences$month[i] <= 9){
    presences$season[i] <- 3
    } else if (presences$month[i] >= 10 & presences$month[i] <= 12){
    presences$season[i] <- 4
  }
}

write.csv(presences, "../output/bio/cluster_seasons_test.csv", row.names = FALSE)

names(presences)

pres <- subset(presences, select = c(year, month, temp_depth, salinity_depth, o2_depth, chl_surface, nao_sample, nao_prev, nao_winter, amo_sample, amo_winter, season))
pres <- na.omit(pres)
pres2 <- na.omit(presences)
pres <- scale(pres)
```

```{r}

library("cluster")
library("factoextra")
library("magrittr")
```

```{r}
distance <- get_dist(pres)
fviz_dist(distance, gradient = list(low = "#00AFBB", mid = "white", high = "#FC4E07"))
```


```{r}
fviz_nbclust(pres, kmeans, method = "gap_stat")
```

```{r}
set.seed(123)
km.res <- kmeans(pres, 6, nstart = 25)
km.res
# Visualize
library("factoextra")
fviz_cluster(km.res, data = pres,
             ellipse.type = "convex",
             palette = "jco",
             ggtheme = theme_minimal())
```

```{r}
library("cluster")
pam.res <- pam(pres, 6)
# Visualize
fviz_cluster(pam.res)
```




```{r}
library(rworldmap)
pres2wi <- subset(pres2, season == "1")
pres2sp <- subset(pres2, season == "2")
pres2su <- subset(pres2, season == "3")
pres2au <- subset(pres2, season == "4")
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "pres2wi", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(pres2wi$decimalLongitude, pres2wi$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
points(pres2sp$decimalLongitude, pres2sp$decimalLatitude, col = "blue") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
points(pres2su$decimalLongitude, pres2su$decimalLatitude, col = "green") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
points(pres2au$decimalLongitude, pres2au$decimalLatitude, col = "yellow") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
```

```{r}
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "winter", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(pres2wi$decimalLongitude, pres2wi$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
```


```{r}
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "spring", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(pres2sp$decimalLongitude, pres2sp$decimalLatitude, col = "blue") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")

```


```{r}
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "summer", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(pres2su$decimalLongitude, pres2su$decimalLatitude, col = "green") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
```



```{r}
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "autumn", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(pres2au$decimalLongitude, pres2au$decimalLatitude, col = "yellow") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
```

```{r}
p98 <- subset(pres2, year == "1998")
p99 <- subset(pres2, year == "1999")
p00 <- subset(pres2, year == "2000")
p01 <- subset(pres2, year == "2001")
p02 <- subset(pres2, year == "2002")
p03 <- subset(pres2, year == "2003")
p04 <- subset(pres2, year == "2004")
p05 <- subset(pres2, year == "2005")
p06 <- subset(pres2, year == "2006")
p07 <- subset(pres2, year == "2007")
p08 <- subset(pres2, year == "2009")
p09 <- subset(pres2, year == "2009")
p10 <- subset(pres2, year == "2010")
p11 <- subset(pres2, year == "2011")
p12 <- subset(pres2, year == "2012")
p13 <- subset(pres2, year == "2013")
p14 <- subset(pres2, year == "2014")
p15 <- subset(pres2, year == "2015")

```


```{r}
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "1998", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p98$decimalLongitude, p98$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_1998.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "1999", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p99$decimalLongitude, p99$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_1999.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2000", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p00$decimalLongitude, p00$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2000.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2001", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p01$decimalLongitude, p01$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2001.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2002", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p02$decimalLongitude, p02$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2002.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2003", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p03$decimalLongitude, p03$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2003.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2004", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p04$decimalLongitude, p04$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2004.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2005", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p05$decimalLongitude, p05$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2005.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2006", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p06$decimalLongitude, p06$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2006.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2007", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p07$decimalLongitude, p07$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2007.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2008", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p08$decimalLongitude, p08$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2008.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2009", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p09$decimalLongitude, p09$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2009.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2010", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p10$decimalLongitude, p10$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2010.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2011", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p11$decimalLongitude, p11$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2011.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2012", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p12$decimalLongitude, p12$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2012.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2013", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p13$decimalLongitude, p13$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2013.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2014", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p14$decimalLongitude, p14$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2014.png") #this prints a png of the plot
dev.off() #this turns off the print command

plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "2015", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(p15$decimalLongitude, p15$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../data/bio/occurrence_map/p_2015.png") #this prints a png of the plot
dev.off() #this turns off the print command
```



# violin plots

```{r}
#load a test raster

ras <- raster("../output/maxent/predictions/apr/cloglog_st201004000120.asc")
plot(ras)
ras2 <- raster("../output/maxent/predictions/oct/cloglog_st201010000120.asc")
plot(ras2)
rasd <- as.data.frame(ras)
rasd$month <- "4"
rasd2 <- as.data.frame(ras2)
rasd2$month <- "10"
names(rasd)[names(rasd) == "cloglog_st201004000120"] <- "prob"
names(rasd2)[names(rasd2) == "cloglog_st201010000120"] <- "prob"
rasd$month <- as.factor(rasd$month)
rasd2$month <- as.factor(rasd2$month)
rd <- rbind(rasd, rasd2)
rd
p <- ggplot(rd, aes(x=month, y = prob)) + geom_violin(trim=FALSE)
plot(p)


mth <- c("jan", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")
for (m in 1:length(mth)){
  mon <- mth[m]
  vlst <- list.files(paste0("../output/maxent/predictions/", mon), pattern = "^avg_cloglog.*.asc", full.names = TRUE)
  for (v in 1:length(vlst)){
    ras <- raster(vlst[v])
    rasd <- as.data.frame(ras)
    if (mon == "jan"){
      rasd$month <- "1"
      rnm <- names(ras)
      names(rasd)[names(rasd) == rnm] <- "prob"
      rasd$month <- as.factor(rasd$month)
      rd1 <- rasd
      } else if(mon == "mar"){
        rasd$month <- "3"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd3 <- rasd
      } else if(mon == "apr"){
        rasd$month <- "4"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd4 <- rasd
      } else if(mon == "may"){
        rasd$month <- "5"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd5 <- rasd
      } else if(mon == "jun"){
        rasd$month <- "6"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd6 <- rasd
      } else if(mon == "jul"){
        rasd$month <- "7"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd7 <- rasd
      } else if(mon == "aug"){
        rasd$month <- "8"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd8 <- rasd
      } else if(mon == "sep"){
        rasd$month <- "9"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd9 <- rasd
      } else if(mon == "oct"){
        rasd$month <- "10"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd10 <- rasd
      } else if(mon == "nov"){
        rasd$month <- "11"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd11 <- rasd
      } else if(mon == "dec"){
        rasd$month <- "12"
        rnm <- names(ras)
        names(rasd)[names(rasd) == rnm] <- "prob"
        rasd$month <- as.factor(rasd$month)
        rd12 <- rasd
      }
   
     
  }


}
  #rd <- rbind(rd1, rd3, rd4, rd5, rd6, rd7, rd8, rd9, rd10, rd11, rd12)
  rd <- rbind(rd1, rd3, rd4)

    #rd <- as.data.frame(rd)
    #rd$month <- as.factor(rd$month)
p <- ggplot(rd, aes(x=month, y = prob)) + geom_violin(trim=FALSE)
plot(p)






```





. For key predictor variables, can you plot probability of occurrence (y-axis) vs predictor (x-axis). I would like to see raw data which will be 1 for presence and 0 for background and then overlay the model predicted relationships on top of the raw data for the two models (full year, month). Functiona "abline (model name)" plots the model prediction for many models in R - not sure this will work for MaxEnt. This will show how the predictions vary for the different variables - perhaps it is just one driving the differences. Does this make sense?


first need to add the same depth indicator as used in the file names

```{r}
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}

data_aea <- read.csv("../output/bio/presab_nafo_yr.csv", header = TRUE)
data_aea$depthlyr_mod <- NA
data_aea$predicted_alldata <- NA
data_aea <- completeFun(data_aea, "depth_layer")

avgasc_list <- list.files(paste0("../output/maxent/all_data/predictions/july/"), pattern = "^avg_.*.asc", full.names = TRUE) #true means the full path is included
depths <- list()
for (i in 1:length(avgasc_list)){
  ascname <-  str_sub(avgasc_list[i], 48, -5)
  depths[[paste0(i)]] <- ascname
}

for (j in 1:nrow(data_aea)){
  d <- data_aea$depth_layer[j]
  d3 <- str_sub(d, end = 3) #extract first 3 digits 
   for (k in 1:length(depths)){
    l <- depths[[k]]
    l3 <- str_sub(l, end = 3) #extract first 3 digits
    if (d3 == l3){
      data_aea$depthlyr_mod[j] <- l
    }
  }
}
data_aea <- completeFun(data_aea, "depthlyr_mod")


```


```{r}
#mth <- c("1", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12")
#mthn <- c("jan", "may", "apr", "may", "jun", "july", "aug", "sep", "oct", "nov","dec")
aea <- raster("../output/env/aea.tif") 



#for (m in 1:length(mth)){
#mont <- mth[m]
mont <- 11
data_aeaX <- subset(data_aea, month == mont)
xy <- data_aeaX[ ,c(19,20)] # This is to tell R where the coordinates are (in column 18 and 19). Note that the column order needs to be longitude, latitude
data_aea_sp <- SpatialPointsDataFrame(coords = xy, data = data_aeaX, proj4string = CRS("+proj=aea +lat_1=50 +lat_2=70 +lat_0=40 +lon_0=-60 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs")) # The CRS is used here is for the albers equal area projection.
avgasc_list <- list.files(paste0("../output/maxent/all_data/predictions/nov/"), pattern = "^avg_.*.asc", full.names = TRUE) #true means the full path is included
for (j in 1:nrow(data_aea_sp)) { 
for (i in 1:length(avgasc_list)) {  
 de <- data_aea_sp$depthlyr_mod[j]  # a variable for the observation depth layer
  mth <- (data_aea_sp$month[j])  # a variable for the observation month
  rasdep <- str_sub(avgasc_list[i], 47, -5)
       if (mth == mont & rasdep == de){
          temp_brick <- raster(avgasc_list[i])
        crs(temp_brick) <- aea@crs 
              data_aea_sp$predicted[j] <- extract(x=temp_brick, y = data_aea_sp[j, ]) 
              
              }
          }
}

#}
              data_aea1 <- as.data.frame(data_aea_sp)

write.csv(data_aea1, "../output/maxent/all_data/pred_file_nov.csv", row.names = FALSE)
 #}
  
 # data_aea1 <- as.data.frame(data_aea_sp)

```


```{r}

aea <- raster("../output/env/aea.tif") 



#for (m in 1:length(mth)){
#mont <- mth[m]
mont <- 11
data_aeaX <- read.csv("../output/maxent/all_data/pred_file_nov.csv", header = TRUE)
data_aeaX$mthpred <- NA
xy <- data_aeaX[ ,c(19,20)] # This is to tell R where the coordinates are (in column 18 and 19). Note that the column order needs to be longitude, latitude
data_aea_sp <- SpatialPointsDataFrame(coords = xy, data = data_aeaX, proj4string = CRS("+proj=aea +lat_1=50 +lat_2=70 +lat_0=40 +lon_0=-60 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs")) # The CRS is used here is for the albers equal area projection.
avgasc_list <- list.files(paste0("../output/maxent/predictions/nov/"), pattern = "^avg_.*.asc", full.names = TRUE) #true means the full path is included
for (j in 1:nrow(data_aea_sp)) { 
for (i in 1:length(avgasc_list)) {  
 de <- data_aea_sp$depthlyr_mod[j]  # a variable for the observation depth layer
  mth <- (data_aea_sp$month[j])  # a variable for the observation month
  rasdep <- str_sub(avgasc_list[i], 46, -5)
       if (mth == mont & rasdep == de){
          temp_brick <- raster(avgasc_list[i])
        crs(temp_brick) <- aea@crs 
              data_aea_sp$mthpred[j] <- extract(x=temp_brick, y = data_aea_sp[j, ]) 
              
              }
          }
}

#}
              data_aea1 <- as.data.frame(data_aea_sp)
              write.csv(data_aea1, "../output/maxent/all_data/pred_file_nov.csv", row.names = FALSE)


```


```{r}
predjan <- read.csv("../output/maxent/all_data/pred_file_jan.csv", header = TRUE)
predjanpr <- subset(predjan, occurrence == 1)
predjanbk <- subset(predjan, occurrence == 0)
png("janocc_temp_vs_prob.png")
plot(predjanpr$temp_depth, predjanpr$predicted_mthdata, xlab = "temperature", ylab = "probability")
dev.off()
png("janbk_temp_vs_prob.png")
plot(predjanbk$temp_depth, predjanbk$predicted_mthdata, xlab = "temperature", ylab = "probability")
dev.off()
```

```{r}
mod <- readRDS(file = "../output/maxent/all_data/maxmod.rds", refhook = NULL)
px <- response(mod@models[[4]])
```

#get all probabiltiy values for a period of time and find the upper 20%


for july with all data
```{r}
clogasc_list <- list.files(paste0("../output/maxent/all_data/predictions/july/"), pattern = "^avg_.*.asc", full.names = TRUE) # first list the files containing the data
a <- stack(clogasc_list) #stack the files
b <- getValues(a) # create a matrix of the values 
c <- as.vector(b) #make into vector
d <- na.omit(c) #remove all na values
d <- sort(d, decreasing = TRUE) # order from high to low
drow <- length(d) # how many values are there
dr20 <- (drow*20)/100  # calculate which value is the upper 20%
d20 <- d[dr20] # 0.149577....
dmaxv <- max(d) #0.998087
dm20 <- (dmaxv*80)/100 # calculate the 20% of 0.998097...  = 0.798477....


#binary threshold function d20
bind20 <- function(x){
  ifelse(x >= d20, 1,
  ifelse(x < d20, 0, NA)) 
}

#binary threshold function dm20
bindm20 <- function(x){
  ifelse(x >= dm20, 1,
  ifelse(x < dm20, 0, NA)) 
}

for (cum in 1:length(clogasc_list)){
  cumascdep <- str_sub(clogasc_list[cum], start = 47, end = -5) #selects the depth from the file name
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cum_d20 <- calc(cumasc, fun = bind20)
  cum_dm20 <- calc(cumasc, fun = bindm20)
  writeRaster(cum_d20, paste0("../output/maxent/slr_analysis/july_alldata/july_alldata_d20_", ascname, ".asc"), overwrite = TRUE)
  writeRaster(cum_dm20, paste0("../output/maxent/slr_analysis/july_alldata/july_alldata_dm20_", ascname, ".asc"), overwrite = TRUE)
  }



binaryclog_list <- list.files(paste0("../output/maxent/slr_analysis/july_alldata"), pattern = "^july_alldata_d20_.*.asc", full.names = TRUE)
binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, "../output/maxent/slr_analysis/july_alldata/d20_2d.asc", overwrite=TRUE)
plot(stacksum, png("../output/maxent/slr_analysis/july_alldata/d20_2d.png"))
dev.off()
binaryclog_list <- list.files(paste0("../output/maxent/slr_analysis/july_alldata"), pattern = "^july_alldata_dm20_.*.asc", full.names = TRUE)
binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, "../output/maxent/slr_analysis/july_alldata/dm20_2d.asc", overwrite=TRUE)
plot(stacksum, png("../output/maxent/slr_analysis/july_alldata/dm20_2d.png"))
dev.off()


#make map

aea <- raster("../output/env/aea.tif") #the correct CRS
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
apr <- aea@crs
#brk <- seq(0.1, 1, 0.1) #for legend
redtrans <- rgb(218, 215, 216, 90, maxColorValue=255) 
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
presback <- read.csv("../output/bio/presab_nafo_yr.csv", header = TRUE)
pronly <- subset(presback, occurrence == 1)
prjul <- subset(pronly, month == 7)
#prjan <- subset(pronly, month == 1)


  pras <- raster("../output/maxent/slr_analysis/july_alldata/d20_2d.asc")
  crs(pras) <- apr
  ascname <- names(pras)
  pras[pras >0] <- 1
  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prjul$longitude_meters, prjul$latitude_meters, add = TRUE, pch=19, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/slr_analysis/july_alldata/d20_2d.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
  
  pras <- raster("../output/maxent/slr_analysis/july_alldata/dm20_2d.asc")
  crs(pras) <- apr
  ascname <- names(pras)
  pras[pras >0] <- 1
  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prjul$longitude_meters, prjul$latitude_meters, add = TRUE, pch=19, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/slr_analysis/july_alldata/dm20_2d.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))

```






for july with just july data
```{r}
clogasc_list <- list.files(paste0("../output/maxent/predictions/jul/"), pattern = "^avg_cloglog_.*.asc", full.names = TRUE) # first list the files containing the data
a <- stack(clogasc_list) #stack the files
b <- getValues(a) # create a matrix of the values 
c <- as.vector(b) #make into vector
d <- na.omit(c) #remove all na values
d <- sort(d, decreasing = TRUE) # order from high to low
drow <- length(d) # how many values are there
dr20 <- (drow*20)/100  # calculate which value is the upper 20%
d20 <- d[dr20] # 0.083319....
dmaxv <- max(d) #0.885157....
dm20 <- (dmaxv*80)/100 # calculate the 20% of 0.885157....  = 0.70812....



#binary threshold function d20
bind20 <- function(x){
  ifelse(x >= d20, 1,
  ifelse(x < d20, 0, NA)) 
}

#binary threshold function dm20
bindm20 <- function(x){
  ifelse(x >= dm20, 1,
  ifelse(x < dm20, 0, NA)) 
}

for (cum in 1:length(clogasc_list)){
  cumascdep <- str_sub(clogasc_list[cum], start = 46, end = -5) #selects the depth from the file name
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cum_d20 <- calc(cumasc, fun = bind20)
  cum_dm20 <- calc(cumasc, fun = bindm20)
  writeRaster(cum_d20, paste0("../output/maxent/slr_analysis/july_alldata/july_monthdata_d20_", ascname, ".asc"), overwrite = TRUE)
  writeRaster(cum_dm20, paste0("../output/maxent/slr_analysis/july_alldata/july_monthdata_dm20_", ascname, ".asc"), overwrite = TRUE)
  }



binaryclog_list <- list.files(paste0("../output/maxent/slr_analysis/july_alldata"), pattern = "^july_monthdata_d20_.*.asc", full.names = TRUE)
binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, "../output/maxent/slr_analysis/july_alldata/d20_2d_month.asc", overwrite=TRUE)
plot(stacksum, png("../output/maxent/slr_analysis/july_alldata/d20_2d_month.png"))
dev.off()
binaryclog_list <- list.files(paste0("../output/maxent/slr_analysis/july_alldata"), pattern = "^july_monthdata_dm20_.*.asc", full.names = TRUE)
binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, "../output/maxent/slr_analysis/july_alldata/dm20_2d_month.asc", overwrite=TRUE)
plot(stacksum, png("../output/maxent/slr_analysis/july_alldata/dm20_2d_month.png"))
dev.off()


#make map

aea <- raster("../output/env/aea.tif") #the correct CRS
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
apr <- aea@crs
#brk <- seq(0.1, 1, 0.1) #for legend
redtrans <- rgb(218, 215, 216, 90, maxColorValue=255) 
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
presback <- read.csv("../output/bio/presab_nafo_yr.csv", header = TRUE)
pronly <- subset(presback, occurrence == 1)
prjul <- subset(pronly, month == 7)
#prjan <- subset(pronly, month == 1)


  pras <- raster("../output/maxent/slr_analysis/july_alldata/d20_2d_month.asc")
  crs(pras) <- apr
  ascname <- names(pras)
  pras[pras >0] <- 1
  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prjul$longitude_meters, prjul$latitude_meters, add = TRUE, pch=19, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/slr_analysis/july_alldata/d20_2d_month.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
  
  pras <- raster("../output/maxent/slr_analysis/july_alldata/dm20_2d_month.asc")
  crs(pras) <- apr
  ascname <- names(pras)
  pras[pras >0] <- 1
  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prjul$longitude_meters, prjul$latitude_meters, add = TRUE, pch=19, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/slr_analysis/july_alldata/dm20_2d_month.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
```

for jan with all data
```{r}
clogasc_list <- list.files(paste0("../output/maxent/all_data/predictions/jan/"), pattern = "^avg_.*.asc", full.names = TRUE) # first list the files containing the data
a <- stack(clogasc_list) #stack the files
b <- getValues(a) # create a matrix of the values 
c <- as.vector(b) #make into vector
d <- na.omit(c) #remove all na values
d <- sort(d, decreasing = TRUE) # order from high to low
drow <- length(d) # how many values are there
dr20 <- (drow*20)/100  # calculate which value is the upper 20%
d20 <- d[dr20] # 0.08307....
dmaxv <- max(d) #0.996738...
dm20 <- (dmaxv*80)/100 # calculate the 20% of 0.996738...  = 0.7973906....


#binary threshold function d20
bind20 <- function(x){
  ifelse(x >= d20, 1,
  ifelse(x < d20, 0, NA)) 
}

#binary threshold function dm20
bindm20 <- function(x){
  ifelse(x >= dm20, 1,
  ifelse(x < dm20, 0, NA)) 
}

for (cum in 1:length(clogasc_list)){
  cumascdep <- str_sub(clogasc_list[cum], start = 47, end = -5) #selects the depth from the file name
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cum_d20 <- calc(cumasc, fun = bind20)
  cum_dm20 <- calc(cumasc, fun = bindm20)
  writeRaster(cum_d20, paste0("../output/maxent/slr_analysis/jan_alldata/jan_alldata_d20_", ascname, ".asc"), overwrite = TRUE)
  writeRaster(cum_dm20, paste0("../output/maxent/slr_analysis/jan_alldata/jan_alldata_dm20_", ascname, ".asc"), overwrite = TRUE)
  }


binaryclog_list <- list.files(paste0("../output/maxent/slr_analysis/jan_alldata"), pattern = "^jan_alldata_d20_.*.asc", full.names = TRUE)
binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, "../output/maxent/slr_analysis/jan_alldata/d20_2d.asc", overwrite=TRUE)
plot(stacksum, png("../output/maxent/slr_analysis/jan_alldata/d20_2d.png"))
dev.off()
binaryclog_list <- list.files(paste0("../output/maxent/slr_analysis/jan_alldata"), pattern = "^jan_alldata_dm20_.*.asc", full.names = TRUE)
binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, "../output/maxent/slr_analysis/jan_alldata/dm20_2d.asc", overwrite=TRUE)
plot(stacksum, png("../output/maxent/slr_analysis/jan_alldata/dm20_2d.png"))
dev.off()


#make map

aea <- raster("../output/env/aea.tif") #the correct CRS
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
apr <- aea@crs
#brk <- seq(0.1, 1, 0.1) #for legend
redtrans <- rgb(218, 215, 216, 90, maxColorValue=255) 
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
presback <- read.csv("../output/bio/presab_nafo_yr.csv", header = TRUE)
pronly <- subset(presback, occurrence == 1)
#prjul <- subset(pronly, month == 7)
prjan <- subset(pronly, month == 1)


  pras <- raster("../output/maxent/slr_analysis/jan_alldata/d20_2d.asc")
  crs(pras) <- apr
  ascname <- names(pras)
  pras[pras >0] <- 1
  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prjan$longitude_meters, prjan$latitude_meters, add = TRUE, pch=19, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/slr_analysis/jan_alldata/d20_2d.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
  
  pras <- raster("../output/maxent/slr_analysis/jan_alldata/dm20_2d.asc")
  crs(pras) <- apr
  ascname <- names(pras)
  pras[pras >0] <- 1
  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prjan$longitude_meters, prjan$latitude_meters, add = TRUE, pch=19, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/slr_analysis/jan_alldata/dm20_2d.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))

```

for jan with just jan data
```{r}
clogasc_list <- list.files(paste0("../output/maxent/predictions/jan/"), pattern = "^avg_cloglog_.*.asc", full.names = TRUE) # first list the files containing the data
a <- stack(clogasc_list) #stack the files
b <- getValues(a) # create a matrix of the values 
c <- as.vector(b) #make into vector
d <- na.omit(c) #remove all na values
d <- sort(d, decreasing = TRUE) # order from high to low
drow <- length(d) # how many values are there
dr20 <- (drow*20)/100  # calculate which value is the upper 20%
d20 <- d[dr20] # 0.01165....
dmaxv <- max(d) #0.73946....
dm20 <- (dmaxv*80)/100 # calculate the 20% of 0.73946....  = 0.591569....


#binary threshold function d20
bind20 <- function(x){
  ifelse(x >= d20, 1,
  ifelse(x < d20, 0, NA)) 
}

#binary threshold function dm20
bindm20 <- function(x){
  ifelse(x >= dm20, 1,
  ifelse(x < dm20, 0, NA)) 
}

for (cum in 1:length(clogasc_list)){
  cumascdep <- str_sub(clogasc_list[cum], start = 46, end = -5) #selects the depth from the file name
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cum_d20 <- calc(cumasc, fun = bind20)
  cum_dm20 <- calc(cumasc, fun = bindm20)
  writeRaster(cum_d20, paste0("../output/maxent/slr_analysis/jan_alldata/jan_monthdata_d20_", ascname, ".asc"), overwrite = TRUE)
  writeRaster(cum_dm20, paste0("../output/maxent/slr_analysis/jan_alldata/jan_monthdata_dm20_", ascname, ".asc"), overwrite = TRUE)
  }



binaryclog_list <- list.files(paste0("../output/maxent/slr_analysis/jan_alldata"), pattern = "^jan_monthdata_d20_.*.asc", full.names = TRUE)
binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, "../output/maxent/slr_analysis/jan_alldata/d20_2d_month.asc", overwrite=TRUE)
plot(stacksum, png("../output/maxent/slr_analysis/jan_alldata/d20_2d_month.png"))
dev.off()
binaryclog_list <- list.files(paste0("../output/maxent/slr_analysis/jan_alldata"), pattern = "^jan_monthdata_dm20_.*.asc", full.names = TRUE)
binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, "../output/maxent/slr_analysis/jan_alldata/dm20_2d_month.asc", overwrite=TRUE)
plot(stacksum, png("../output/maxent/slr_analysis/jan_alldata/dm20_2d_month.png"))
dev.off()


#make map

aea <- raster("../output/env/aea.tif") #the correct CRS
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
apr <- aea@crs
#brk <- seq(0.1, 1, 0.1) #for legend
redtrans <- rgb(218, 215, 216, 90, maxColorValue=255) 
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
presback <- read.csv("../output/bio/presab_nafo_yr.csv", header = TRUE)
pronly <- subset(presback, occurrence == 1)
prjul <- subset(pronly, month == 7)
#prjan <- subset(pronly, month == 1)


  pras <- raster("../output/maxent/slr_analysis/jan_alldata/d20_2d_month.asc")
  crs(pras) <- apr
  ascname <- names(pras)
  pras[pras >0] <- 1
  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prjan$longitude_meters, prjan$latitude_meters, add = TRUE, pch=19, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/slr_analysis/jan_alldata/d20_2d_month.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
  
  pras <- raster("../output/maxent/slr_analysis/jan_alldata/dm20_2d_month.asc")
  crs(pras) <- apr
  ascname <- names(pras)
  pras[pras >0] <- 1
  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prjan$longitude_meters, prjan$latitude_meters, add = TRUE, pch=19, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/slr_analysis/jan_alldata/dm20_2d_month.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
```




```{r}

mont <- 
data_aeaX <- read.csv("../output/maxent/all_data/pred_file_nov.csv", header = TRUE)
data_aeaX$predicted_mthdata <- NA

xy <- data_aeaX[ ,c(19,20)] # This is to tell R where the coordinates are (in column 18 and 19). Note that the column order needs to be longitude, latitude
data_aea_sp <- SpatialPointsDataFrame(coords = xy, data = data_aeaX, proj4string = CRS("+proj=aea +lat_1=50 +lat_2=70 +lat_0=40 +lon_0=-60 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs")) # The CRS is used here is for the albers equal area projection.
avgasc_list <- list.files(paste0("../output/maxent/predictions/nov"), pattern = "^avg_.*.asc", full.names = TRUE) #true means the full path is included
for (j in 1:nrow(data_aea_sp)) { 
for (i in 1:length(avgasc_list)) {  
 de <- data_aea_sp$depthlyr_mod[j]  # a variable for the observation depth layer
  rasdep <- str_sub(avgasc_list[i], 46, -5)
       if (rasdep == de){
          temp_brick <- raster(avgasc_list[i])
        crs(temp_brick) <- aea@crs 
              data_aea_sp$predicted_mthdata[j] <- extract(x=temp_brick, y = data_aea_sp[j, ]) 
              
              }
          }
}

           data_aea1 <- as.data.frame(data_aea_sp)

write.csv(data_aea1, "../output/maxent/all_data/pred_file_nov2.csv", row.names = FALSE)
 #}
  
```



#code to create benthic layers

```{r}
aea <- raster("../output/env/aea.tif") #the correct CRS
benlst <- list.files("../data/env/ascii/benthic_layers/template", pattern = ".*.asc", full.names = TRUE)
apr <- aea@crs



for (pred in 1:length(benlst)){
  pras <- raster(benlst[pred])
  crs(pras) <- apr
  ascname <- names(pras)
  depth <-  (sapply(strsplit(ascname, "_"), "[[", 4)) # extracting the third part of the netcdf (inc.nc)
  pras[pras >0] <- 0
  pras[is.na(pras)] <- 1
  writeRaster(pras, paste0("../data/env/ascii/benthic_layers/done/benthic_", depth, ".asc"), overwrite = TRUE)

}

#just check it works
benlst <- list.files("../data/env/ascii/benthic_layers/done", pattern = ".*.asc", full.names = TRUE)


for (pred in 1:length(benlst)){
  pras <- raster(benlst[pred])
  plot(pras)
}


```

```{r}
predjan <- read.csv("../output/maxent/all_data/predictions_jan.csv", header = TRUE)
plot(predjan$occurrence, predjan$predicted_mthdata)
plot(predjan$occurrence, predjan$predicted_alldata)
```

```{r}
predjul <- read.csv("../output/maxent/all_data/pred_file_jul.csv", header = TRUE)
plot(predjul$occurrence, predjul$predicted_mthdata)
plot(predjul$occurrence, predjul$predicted_alldata, xlab = "occurrence", ylab = "probability", main = "probability for background (o) & occurrence (1) - all data model")
```


```{r}
predjan <- read.csv("../output/maxent/all_data/predictions_jan.csv", header = TRUE)

completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}


predjan <- completeFun(predjan, "predicted_mthdata")
predjanoc <- subset(predjan, occurrence == 1)
predjanbk <- subset(predjan, occurrence == 0)
noc <- nrow(predjanoc)
nbk <- nrow(predjanbk)
janmth5plusoc <- sum(predjanoc$predicted_mthdata > 0.5)
janmth5plusbk <- sum(predjanoc$predicted_mthdata > 0.5)
janmthpp <- (janmth5plusoc/noc)*100
janmthbkp <- (janmth5plusbk/nbk)*100

janall5plusoc <- sum(predjanoc$predicted_alldata > 0.5)
janall5plusbk <- sum(predjanoc$predicted_alldata > 0.5)
janallpp <- (janall5plusoc/noc)*100
janallbkp <- (janall5plusbk/nbk)*100
```

```{r}
hist(predjanoc$predicted_mthdata)
hist(predjanoc$predicted_alldata)
hist(predjanbk$predicted_mthdata)
hist(predjanbk$predicted_alldata)
```



```{r}
predjul <- read.csv("../output/maxent/all_data/predictions_jul.csv", header = TRUE)

completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}


predjul <- completeFun(predjul, "predicted_mthdata")
predjuloc <- subset(predjul, occurrence == 1)
predjulbk <- subset(predjul, occurrence == 0)
noc <- nrow(predjuloc)
nbk <- nrow(predjulbk)

julmth5plusoc <- sum(predjuloc$predicted_mthdata > 0.5)
julmth5plusbk <- sum(predjuloc$predicted_mthdata > 0.5)
julmthpp <- (julmth5plusoc/noc)*100
julmthbkp <- (julmth5plusbk/nbk)*100

julall5plusoc <- subset(predjuloc, predicted_alldata > 0.5)
julall5plusoc <- nrow(julall5plusoc)
julall5plusbk <- subset(predjulbk, predicted_alldata > 0.5)
julall5plusbk <- nrow(julall5plusbk)
julallpp <- (julall5plusoc/noc)*100
julallbkp <- (julall5plusbk/nbk)*100
```


```{r}
hist(predjuloc$predicted_mthdata)
hist(predjuloc$predicted_alldata)
hist(predjulbk$predicted_mthdata)
hist(predjulbk$predicted_alldata)
```


```{r}
predlst <- list.files(paste0("../output/maxent/all_data/"), pattern = "pred_file", full.names = TRUE)

completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}

for (a in 1:length(predlst)){
  pred <- read.csv(predlst[a])
  mth <- str_sub(predlst[a], 37, -5) 
  predc <- completeFun(pred, "predicted_mthdata")
  predoc <- subset(predc, occurrence == 1)
  predbk <- subset(predc, occurrence == 0)
  png(paste0("monthly_pred_occurrence_", mth, ".png"))
  hmthoc <- hist(predoc$predicted_mthdata, main = paste0("monthly predictions - ", mth, " occurrences"), xlab = "probability of occurrence")
  dev.off() # stops automatic saving of the plot to a png
  png(paste0("monthly_pred_background_", mth, ".png"))
  hmthbk <- hist(predbk$predicted_mthdata, main = paste0("monthly predictions - ", mth, " background"), xlab = "probability of occurrence")
  dev.off() # stops automatic saving of the plot to a png            
  png(paste0("alldata_pred_occurrence_", mth, ".png"))
  halloc <- hist(predoc$predicted_alldata, main = paste0("all data predictions - ", mth, " occurrences"), xlab = "probability of occurrence")
  dev.off() # stops automatic saving of the plot to a png
  png(paste0("alldata_pred_background_", mth, ".png"))
  hallbk <- hist(predbk$predicted_alldata, main = paste0("all data predictions - ", mth, " background"), xlab = "probability of occurrence")
  dev.off() # stops automatic saving of the plot to a png   

}


```


tss for all data model
```{r}
ev <- evaluate(p = predoc$predicted_alldata , a = predbk$predicted_alldata, model = mod)

tss <- max(ev@TPR + ev@TNR) - 1
tss
```

```{r}
janoc <- read.csv("../output/maxent/all_data/pred_file_jan.csv")
b <- subset(janoc, occurrence == 1)
c <- b$predicted_alldata
a <-max(c, na.rm = TRUE)
a
```


```{r habitat classification on probability - high only}


#binary threshold function
binprob <- function(x){
  ifelse(x >= 0.8, 1,
  ifelse(x < 0.8, 0, NA)) 
}

clogasc_list <- list.files(paste0("../output/maxent/all_data/predictions/july/"), pattern = "^avg_.*.asc", full.names = TRUE)

for (cum in 1:length(clogasc_list)){
  cumascdep <- str_sub(clogasc_list[cum], start = 47, end = -5) #selects the depth from the file name
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cum_mpathr <- calc(cumasc, fun = binprob)
  writeRaster(cum_mpathr, paste0("../output/maxent/all_data/predictions/july/binary_p80_", cumascdep, ".asc"), overwrite = TRUE)
  plot(cum_mpathr, png(paste0("../output/maxent/all_data/predictions/july/binary_p80_", cumascdep, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
  }

```



```{r binary map averaged 2D representation p80}

binaryclog_list <- list.files(paste0("../output/maxent/all_data/predictions/july/"), pattern = "^binary_p80.*.asc", full.names = TRUE)

binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, paste0("../output/maxent/all_data/predictions/july/bin_p80_2d.asc"), overwrite=TRUE)
plot(stacksum, png(paste0("../output/maxent/all_data/predictions/july/bin_avg_p80_2d.png")))
dev.off()

```


```{r}
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
redtrans <- rgb(218, 215, 216, 90, maxColorValue=255) 
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
prpoints <- read.csv("../output/maxent/all_data/pred_file_jul.csv", header = TRUE)
prpoints <- subset(prpoints, occurrence == 1)

completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
  }
  
prpoints <- completeFun(prpoints, "predicted_mthdata")




pras <- raster("../output/maxent/predictions/jul/bin_p80_2d.asc")
  crs(pras) <- aea@crs
  ascname <- names(pras)
  pras <- calc(pras, fun = binprob)

  pras[pras >0] <- 1

  #lp <- plot(pras, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(pras, axes = FALSE, box = FALSE, legend = FALSE)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  lp <- points(prpoints$longitude_meters, prpoints$latitude_meters, add = TRUE, pch=15, cex = 0.5, col = "red")
  print(lp)
  dev.copy(png, ("../output/maxent/all_data/julmth_over0.8.png"), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))



```

```{r habitat classification on probability - high onlyX}


#binary threshold function
binprob <- function(x){
  ifelse(x >= 0.8, 1,
  ifelse(x < 0.8, 0, NA)) 
}

clogasc_list <- list.files(paste0("../output/maxent/predictions/jul/"), pattern = "^avg_.*.asc", full.names = TRUE)

for (cum in 1:length(clogasc_list)){
  cumascdep <- str_sub(clogasc_list[cum], start = 47, end = -5) #selects the depth from the file name
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cum_mpathr <- calc(cumasc, fun = binprob)
  writeRaster(cum_mpathr, paste0("../output/maxent/predictions/jul/binary_p80_", cumascdep, ".asc"), overwrite = TRUE)
  plot(cum_mpathr, png(paste0("../output/maxent/predictions/jul/binary_p80_", cumascdep, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
  }

```



```{r binary map averaged 2D representation p80x}

binaryclog_list <- list.files(paste0("../output/maxent/predictions/jul/"), pattern = "^binary_p80.*.asc", full.names = TRUE)

binstack <- stack(binaryclog_list)
stacksum <- sum(binstack, na.rm = TRUE)
writeRaster(stacksum, paste0("../output/maxent/predictions/jul/bin_p80_2d.asc"), overwrite=TRUE)
plot(stacksum, png(paste0("../output/maxent/predictions/jul/bin_avg_p80_2d.png")))
dev.off()

```



add land to plots with standard legend (working code) THIS WORK!!!
```{r}
aea <- raster("../output/env/aea.tif") #the correct CRS
#maplst <- list.files("../output/maxent/all_data/predictions/", pattern = "binary_avg_2d.*.asc", full.names = TRUE)
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
apr <- aea@crs
brk <- seq(0.1, 1, 0.1) #for legend
redtrans <- rgb(218, 215, 216, 90, maxColorValue=255) 
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis

#r <- raster(avg_77.6112.asc)
#plot(pras)

#for (pred in 1:length(maplst)){
  pras <- raster("../output/maxent/all_data/predictions/apr/avg_77.6112.asc")
  plot(pras)
  crs(pras) <- apr
  ascname <- names(pras)
  #pras[pras >0] <- 1
  lp <- plot(pras, breaks=brk, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = TRUE)
  lp <- plot(pras)
  lp <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  print(lp)
  dev.copy(png, (paste0("../output/maxent/all_data/predictions/", ascname, pred, ".png")), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
#}

```


barcharts showing probability distribution at depth


first bin the probabilities for cells inside the mcp
```{r bin probabilities}
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
clogasc_list <- list.files(paste0("../output/maxent/predictions/nov/"), pattern = "^avg_cloglog_.*.asc", full.names = TRUE)



binprob <- function(x){
  ifelse(x > 0 & x < 0.1, 0.1,
  ifelse(x <= 0, 0, NA))
}

for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_1_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_1_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}



binprob <- function(x){
  ifelse(x >= 0.1 & x < 0.2, 0.2,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_2_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_2_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}

binprob <- function(x){
  ifelse(x >= 0.2 & x < 0.3, 0.3,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_3_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_3_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}


binprob <- function(x){
  ifelse(x >= 0.3 & x < 0.4, 0.4,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_4_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_4_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}



binprob <- function(x){
  ifelse(x >= 0.4 & x < 0.5, 0.5,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_5_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_5_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}
 

binprob <- function(x){
  ifelse(x >= 0.5 & x < 0.6, 0.6,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_6_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_6_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
} 



binprob <- function(x){
  ifelse(x >= 0.6 & x < 0.7, 0.7,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_7_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_7_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}


binprob <- function(x){
  ifelse(x >= 0.7 & x < 0.8, 0.8,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_8_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_8_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}


binprob <- function(x){
  ifelse(x >= 0.8 & x < 0.9, 0.9,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_9_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_9_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}



binprob <- function(x){
  ifelse(x >= 0.9 & x <= 1, 1,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/predictions/nov/binned_10_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/predictions/nov/binned_10_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}


```


get data to plot probability by depth... need to do manually 1-10
```{r}
ascdepth_list_high <- list.files(paste0("../output/maxent/predictions/nov/"), pattern = "^binned_1_avgprob_.*asc", full.names = TRUE)

binprob <- function(x){
  ifelse(x >0,  1,
  ifelse(x == -9999, 0, NA))
}

binaryavgstack <- stack(ascdepth_list_high)
stackstathigh <- data.frame(matrix(ncol = 2, nrow = nlayers(binaryavgstack)))
stackstathigh[ ,1] <- c(1:49)
colnames(stackstathigh) <- c("asclayer", "prob_bin")

for (lyr in 1:nlayers(binaryavgstack)){
  ascname <-  str_sub(ascdepth_list_high[lyr], 63, -5)
  dlay <- binaryavgstack[[lyr]]
  dlay <- calc(dlay, fun = binprob) #creates raster layer with cell values based on the binprob function
  lyrsum <- cellStats(dlay, sum)
  stackstathigh$prob_bin[lyr] <- lyrsum
  stackstathigh$asclayer[lyr] <- ascname

}
write.csv(stackstathigh, paste0("../output/maxent/predictions/nov/probbin_1_cellcount_bydepth_avg.csv"), row.names = FALSE)

```


```{r}

probblst <- list.files(paste0("../output/maxent/predictions/nov"), pattern = "^probbin_.*.csv", full.names = TRUE)
a <- read.csv(probblst[1])
b <- read.csv(probblst[2])
c <- read.csv(probblst[3])
d <- read.csv(probblst[4])
e <- read.csv(probblst[5])
f <- read.csv(probblst[6])
g <- read.csv(probblst[7])
h <- read.csv(probblst[8])
i <- read.csv(probblst[9])
j <- read.csv(probblst[10])

stackstat <- cbind(a, b[ ,2], c[ ,2], d[ ,2], e[ , 2], f[ ,2], g[ ,2], h[ ,2], i[ ,2], j[ ,2])
colnames(stackstat) <- c("depth", "0 - 0.09", "0.1 - 0.19", "0.2 - 0.29", "0.3 - 0.39", "0.4 - 0.49", "0.5 - 0.59", "0.6 - 0.69", "0.7 - 0.79", "0.8 - 0.89", ">0.9")
stackstat <- melt(stackstat, id = "depth")
stackstat <- stackstat[!(stackstat$depth == "1151.99"), ]
stackstat <- stackstat[!(stackstat$depth == "1265.86"), ]
stackstat <- stackstat[!(stackstat$depth == "1387.38"), ]

colnames(stackstat) <- c("Depth", "Probability", "Cells")

write.csv(stackstat, paste0("../output/maxent/predictions/nov/allprobbin_cellcount_bydepth_avg.csv"), row.names = FALSE)


```




count number of cells that are not NA in each raster layer that are inside the mcp

```{r}
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
clogasc_list <- list.files(paste0("../output/maxent/predictions/nov/"), pattern = "^avg_cloglog_.*.asc", full.names = TRUE)
cumst <- data.frame(0, 0)
colnames(cumst) <- c("depth", "no_cells")

for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumst[cum, 1] <- str_sub(ascname, 13)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  ccnt <- freq(cumasc, useNA='no')
  ccnt <- sum(ccnt[ ,2])
  cumst[cum, 2] <- ccnt
}

cumst$depth <- as.numeric(cumst$depth)
cumst1 <- cumst[order(cumst$no_cells), ]

write.csv(cumst1, "../output/maxent/predictions/nov/cellsperlayer.csv", row.names = FALSE)

```



think about how to get proportions... 

```{r}
pr <- read.csv("../output/maxent/predictions/nov/allprobbin_cellcount_bydepth_avg.csv", header = TRUE)
cumst1 <- read.csv("../output/maxent/predictions/nov/cellsperlayer.csv", header = TRUE)

#order both filed from high to low depth
pr <- pr[order(pr$Depth), ]
cumst1 <- cumst[order(cumst$depth), ]

#so there are some differences in the depth numbers... use partial matching to get the number of cells on each layer

a <- pr
for (r in 1:nrow(pr)){
  d1 <- str_sub(pr$Depth[r], end = 4)
  for (ro in 1:nrow(cumst1)){
    d2 <- str_sub(cumst1$depth[ro], end = 4)
    if (d1 == d2){
        a$total_cells[r] <- cumst1$no_cells[ro]
    }
  }
}

# now work out percentage of cells for each probability

for (r in 1:nrow(a)){
  a$p_cells[r] <- (a$Cells[r]/a$total_cells[r])*100
}

write.csv(a, "../output/maxent/predictions/nov/dis_prob_cells.csv", row.names = FALSE)

```


histogram of probability by depth (straight count)

```{r}
mthna = "nov"
bydepth <- ggplot(data = a, aes(x = Depth, y = Cells, fill = Probability)) + geom_bar(stat = "identity") +   scale_x_reverse() + coord_flip()
png(paste0("../output/maxent/predictions/", mthna, "/depthplot_probavg.png"))
print(bydepth)
dev.off()
```

histogram of probability by depth - by proportion

```{r}

bydepth <- ggplot(a, aes(Depth, p_cells, fill = Probability)) + geom_col() + scale_x_reverse() + coord_flip() #XXXXXcareful - the deeper layers aren't being displayed correctly here
plot(bydepth)
png(paste0("../output/maxent/predictions/", mthna, "/depthplot_probavg_prop.png"))
print(bydepth)
dev.off()
```


ok lets try get an probability for the whole month

```{r}
a <- read.csv("../output/maxent/predictions/jul/dis_prob_cells.csv", header = TRUE)

#subset the probability ranges
p1 <- subset(a, Probability == "0 - 0.09")
p2 <- subset(a, Probability == "0.1 - 0.19")
p3 <- subset(a, Probability == "0.2 - 0.29")
p4 <- subset(a, Probability == "0.3 - 0.39")
p5 <- subset(a, Probability == "0.4 - 0.49")
p6 <- subset(a, Probability == "0.5 - 0.59")
p7 <- subset(a, Probability == "0.6 - 0.69")
p8 <- subset(a, Probability == "0.7 - 0.79")
p9 <- subset(a, Probability == "0.8 - 0.89")
p10 <- subset(a, Probability == ">0.9")

#count the number of cells per probability. 


cp1 <- sum(p1$Cells)
cp2 <- sum(p2$Cells)
cp3 <- sum(p3$Cells)
cp4 <- sum(p4$Cells)
cp5 <- sum(p5$Cells)
cp6 <- sum(p6$Cells)
cp7 <- sum(p7$Cells)
cp8 <- sum(p8$Cells)
cp9 <- sum(p9$Cells)
cp10 <- sum(p10$Cells)

tc2 <- sum(cp1, cp2, cp3, cp4, cp5, cp6, cp7, cp8, cp9, cp10) #how many cells in total for novy have a value
tcell <- sum(p1$total_cells) # how many cells are available to have a value...
#tc2 and tcell should match

#create datbase of total cells per probability bin for the month

b <- unique(a$Probability) #get the unique probability bins
c <- as.data.frame(rbind(cp1, cp2,  cp3, cp4, cp5, cp6, cp7, cp8, cp9, cp10))
c$probability <- b
colnames(c) <- c("cells", "prob_bin")
rownames(c) <- c()
c$month <- "jul"
```

make plot of probability over the month
```{r}
pmth <- ggplot(d, aes(month, cells, fill = prob_bin)) + geom_bar(stat='identity') 
plot(pmth)
png(paste0("../output/maxent/predictions/", mthna, "/prob_avg_mth.png"))
print(pmth)
dev.off()
```

merge two months of data together into one file then plot

```{r}
f <- rbind(c, d)
pmth <- ggplot(f, aes(month, cells, fill = prob_bin)) + geom_bar(stat='identity') 
plot(pmth)
png(paste0("../output/maxent/predictions/prob_avg_mth_test.png"))
print(pmth)
dev.off()
```


#boxplot of test auc scores test

```{r}
dec <- read.csv("../output/maxent/models/decavgAIC.csv", header = TRUE)
mar <- read.csv("../output/maxent/models/maravgAIC.csv", header = TRUE)
apr <- read.csv("../output/maxent/models/apravgAIC.csv", header = TRUE)
may <- read.csv("../output/maxent/models/mayavgAIC.csv", header = TRUE)
jun <- read.csv("../output/maxent/models/junavgAIC.csv", header = TRUE)
jul <- read.csv("../output/maxent/models/julavgAIC.csv", header = TRUE)
aug <- read.csv("../output/maxent/models/augavgAIC.csv", header = TRUE)
sep <- read.csv("../output/maxent/models/sepavgAIC.csv", header = TRUE)
oct <- read.csv("../output/maxent/models/octavgAIC.csv", header = TRUE)
nov <- read.csv("../output/maxent/models/novavgAIC.csv", header = TRUE)

mar <- mar$test_AUC
mar <- head(mar, -1)
apr <- apr$test_AUC
apr <- head(apr, -1)
may <- may$test_AUC
may <- head(may, -1)
jun <- jun$test_AUC
jun <- head(jun, -1)
jul <- jul$test_AUC
jul <- head(jul, -1)
aug <- aug$test_AUC
aug <- head(aug, -1)
sep <- sep$test_AUC
sep <- head(sep, -1)
oct <- oct$test_AUC
oct <- head(oct, -1)
nov <- nov$test_AUC
nov <- head(nov, -1)
dec <- dec$test_AUC
dec <- head(dec, -1)

n <- max(length(mar), length(apr), length(may), length(jun), length(jul), length(aug), length(sep), length(oct), length(nov), length(dec))
length(mar) <- n                      
length(apr) <- n
length(may) <- n
length(jun) <- n
length(jul) <- n
length(aug) <- n
length(sep) <- n
length(oct) <- n
length(nov) <- n
length(dec) <- n

testauc <- cbind(mar, apr, may, jun, jul, aug, sep, oct, nov, dec)
colnames(c) <-c("Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")


```


#boxplot of train auc scores test

```{r}
dec <- read.csv("../output/maxent/models/decavgAIC.csv", header = TRUE)
mar <- read.csv("../output/maxent/models/maravgAIC.csv", header = TRUE)
apr <- read.csv("../output/maxent/models/apravgAIC.csv", header = TRUE)
may <- read.csv("../output/maxent/models/mayavgAIC.csv", header = TRUE)
jun <- read.csv("../output/maxent/models/junavgAIC.csv", header = TRUE)
jul <- read.csv("../output/maxent/models/julavgAIC.csv", header = TRUE)
aug <- read.csv("../output/maxent/models/augavgAIC.csv", header = TRUE)
sep <- read.csv("../output/maxent/models/sepavgAIC.csv", header = TRUE)
oct <- read.csv("../output/maxent/models/octavgAIC.csv", header = TRUE)
nov <- read.csv("../output/maxent/models/novavgAIC.csv", header = TRUE)

mar <- mar$train_AUC
mar <- head(mar, -1)
apr <- apr$train_AUC
apr <- head(apr, -1)
may <- may$train_AUC
may <- head(may, -1)
jun <- jun$train_AUC
jun <- head(jun, -1)
jul <- jul$train_AUC
jul <- head(jul, -1)
aug <- aug$train_AUC
aug <- head(aug, -1)
sep <- sep$train_AUC
sep <- head(sep, -1)
oct <- oct$train_AUC
oct <- head(oct, -1)
nov <- nov$train_AUC
nov <- head(nov, -1)
dec <- dec$train_AUC
dec <- head(dec, -1)

n <- max(length(mar), length(apr), length(may), length(jun), length(jul), length(aug), length(sep), length(oct), length(nov), length(dec))
length(mar) <- n                      
length(apr) <- n
length(may) <- n
length(jun) <- n
length(jul) <- n
length(aug) <- n
length(sep) <- n
length(oct) <- n
length(nov) <- n
length(dec) <- n

trainauc <- cbind(mar, apr, may, jun, jul, aug, sep, oct, nov, dec)
colnames(c) <-c("Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
```

#boxplot of cbi

```{r}
dec <- read.csv("../output/maxent/models/decavgAIC.csv", header = TRUE)
mar <- read.csv("../output/maxent/models/maravgAIC.csv", header = TRUE)
apr <- read.csv("../output/maxent/models/apravgAIC.csv", header = TRUE)
may <- read.csv("../output/maxent/models/mayavgAIC.csv", header = TRUE)
jun <- read.csv("../output/maxent/models/junavgAIC.csv", header = TRUE)
jul <- read.csv("../output/maxent/models/julavgAIC.csv", header = TRUE)
aug <- read.csv("../output/maxent/models/augavgAIC.csv", header = TRUE)
sep <- read.csv("../output/maxent/models/sepavgAIC.csv", header = TRUE)
oct <- read.csv("../output/maxent/models/octavgAIC.csv", header = TRUE)
nov <- read.csv("../output/maxent/models/novavgAIC.csv", header = TRUE)

mar <- mar$cbi
mar <- head(mar, -1)
apr <- apr$cbi
apr <- head(apr, -1)
may <- may$cbi
may <- head(may, -1)
jun <- jun$cbi
jun <- head(jun, -1)
jul <- jul$cbi
jul <- head(jul, -1)
aug <- aug$cbi
aug <- head(aug, -1)
sep <- sep$cbi
sep <- head(sep, -1)
oct <- oct$cbi
oct <- head(oct, -1)
nov <- nov$cbi
nov <- head(nov, -1)
dec <- dec$cbi
dec <- head(dec, -1)

n <- max(length(mar), length(apr), length(may), length(jun), length(jul), length(aug), length(sep), length(oct), length(nov), length(dec))
length(mar) <- n                      
length(apr) <- n
length(may) <- n
length(jun) <- n
length(jul) <- n
length(aug) <- n
length(sep) <- n
length(oct) <- n
length(nov) <- n
length(dec) <- n

cbi <- cbind(mar, apr, may, jun, jul, aug, sep, oct, nov, dec)
colnames(c) <-c("Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
```

#boxplots of tss scores
```{r}
dec <- read.csv("../output/maxent/models/decavgAIC.csv", header = TRUE)
mar <- read.csv("../output/maxent/models/maravgAIC.csv", header = TRUE)
apr <- read.csv("../output/maxent/models/apravgAIC.csv", header = TRUE)
may <- read.csv("../output/maxent/models/mayavgAIC.csv", header = TRUE)
jun <- read.csv("../output/maxent/models/junavgAIC.csv", header = TRUE)
jul <- read.csv("../output/maxent/models/julavgAIC.csv", header = TRUE)
aug <- read.csv("../output/maxent/models/augavgAIC.csv", header = TRUE)
sep <- read.csv("../output/maxent/models/sepavgAIC.csv", header = TRUE)
oct <- read.csv("../output/maxent/models/octavgAIC.csv", header = TRUE)
nov <- read.csv("../output/maxent/models/novavgAIC.csv", header = TRUE)

mar <- mar$tss
mar <- head(mar, -1)
apr <- apr$tss
apr <- head(apr, -1)
may <- may$tss
may <- head(may, -1)
jun <- jun$tss
jun <- head(jun, -1)
jul <- jul$tss
jul <- head(jul, -1)
aug <- aug$tss
aug <- head(aug, -1)
sep <- sep$tss
sep <- head(sep, -1)
oct <- oct$tss
oct <- head(oct, -1)
nov <- nov$tss
nov <- head(nov, -1)
dec <- dec$tss
dec <- head(dec, -1)

n <- max(length(mar), length(apr), length(may), length(jun), length(jul), length(aug), length(sep), length(oct), length(nov), length(dec))
length(mar) <- n                      
length(apr) <- n
length(may) <- n
length(jun) <- n
length(jul) <- n
length(aug) <- n
length(sep) <- n
length(oct) <- n
length(nov) <- n
length(dec) <- n

tss <- cbind(mar, apr, may, jun, jul, aug, sep, oct, nov, dec)
colnames(c) <-c("Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
```


```{r}
par(mfrow=c(2,2))

boxplot(testauc, xlab = "Month", ylab = "Test AUC Score")
boxplot(trainauc, xlab = "Month", ylab = "Training AUC Score")
boxplot(cbi, xlab = "Month", ylab = "CBI Score")
boxplot(tss, xlab = "Month", ylab = "TSS Score")



```






something went wrong with July aug and sep when averaging the rasters.... redo (error due to layer 120 and coconfusion with the year 2012)

      

```{r avg asc layers cloglog}

tlst <- c("sep1998", "sep1999", "sep2000", "sep2001", "sep2002", "sep2003", "sep2004", "sep2005", "sep2006", "sep2007", "sep2008", "sep2009", "sep2010", "sep2011", "sep2012", "sep2013", "sep2014", "sep2015")



mthna <- "sep"

for(a in length(tlst)){
clogasc_list <- list.files(paste0("../output/maxent/predictions/", mthna), pattern = "^cloglog_.*.asc", full.names = TRUE)
timeslice <- tlst[1]
stdep <- list.files(paste0("../output/maxent/models/", timeslice),  pattern = "^stackdepthlist.*.csv", full.names = TRUE)
stdep <- read.csv(stdep)
depthlayers <- data.frame(cbind(unique(stdep$ascdepths)))
names(depthlayers)[names(depthlayers) == "cbind.unique.stdep.ascdepths.."] <- "depth"
depthlayers$depth <- as.character(depthlayers$depth)

colno <- 1


for (d in 1:nrow(depthlayers)){
  dep <- depthlayers$depth[d]
  for (a in 1:length(clogasc_list)){
    asc <- clogasc_list[a]
    ascd <- str_sub(asc, 50, -5)
    if (grepl(dep, ascd)){
      depthlayers[d , paste0("a", colno)] <- asc
       colno <- colno+1
    }
  }
}
write.csv(depthlayers, (paste0("../output/maxent/predictions/", mthna, "/cloglog_asclayerbydepth.csv")), row.names = TRUE)

}

for (x in 1:nrow(depthlayers)){
  asclay <- depthlayers[x, ]
  asclay <- asclay[!is.na(asclay)]
  asclay <- as.data.frame(rbind(asclay))
  asclay$V1 <- as.character(asclay$V1) #v1 corresponds to depth
  asclay$V2 <- as.character(asclay$V2) #v2 to end corresponds to year
  asclay$V3 <- as.character(asclay$V3)
  asclay$V4 <- as.character(asclay$V4)
  asclay$V5 <- as.character(asclay$V5)
  asclay$V6 <- as.character(asclay$V6)
  asclay$V7 <- as.character(asclay$V7)
  asclay$V8 <- as.character(asclay$V8)
  asclay$V9 <- as.character(asclay$V9)
  asclay$V10 <- as.character(asclay$V10)
  asclay$V11 <- as.character(asclay$V11)
  asclay$V12 <- as.character(asclay$V12)
  asclay$V13 <- as.character(asclay$V13)
  asclay$V14 <- as.character(asclay$V14)
  asclay$V15 <- as.character(asclay$V15)  
  asclay$V16 <- as.character(asclay$V16)  
  asclay$V17 <- as.character(asclay$V17) 
  asclay$V18 <- as.character(asclay$V18)  
  asclay$V19 <- as.character(asclay$V19)  


  
  asclaydep <- asclay$V1
  
  asc1998 <- raster(asclay$V2)
  asc1999 <- raster(asclay$V3)
  asc2000 <- raster(asclay$V4)
  asc2001 <- raster(asclay$V5)
  asc2002 <- raster(asclay$V6)
  asc2003 <- raster(asclay$V7)
  asc2004 <- raster(asclay$V8)
  asc2005 <- raster(asclay$V9)
  asc2006 <- raster(asclay$V10)
  asc2007 <- raster(asclay$V11)
  asc2008 <- raster(asclay$V12)
  asc2009 <- raster(asclay$V13)
  asc2010 <- raster(asclay$V14)
  asc2011 <- raster(asclay$V15)
  asc2012 <- raster(asclay$V16)
  asc2013 <- raster(asclay$V17)
  asc2014 <- raster(asclay$V18)
  asc2015 <- raster(asclay$V19)



  stkasc <- stack(asc1998, asc1999, asc2000, asc2001, asc2002, asc2003, asc2004, asc2005, asc2006, asc2007, asc2008, asc2009, asc2010, asc2011, asc2012, asc2013, asc2014, asc2015)

  avg <- mean(stkasc, na.rm = TRUE)
  
  writeRaster(avg, paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_", asclaydep, ".asc"), overwrite=TRUE)
  avgplot <- plot(avg, png(paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_", asclaydep, ".png"))) 
  dev.off()

}

```

     
#Threshold tables
```{r}
thlst1 <- list.files(paste0("../output/maxent/models"), pattern = ".*avgAIC.csv", full.names = TRUE)
thlst2 <- list.files(paste0("../output/maxent/models"), pattern = ".*avgmaxentresults.csv", full.names = TRUE) 

for (m in 1:length(thlst1)){
    mth <- thlst1[m]
    mth <- str_sub(mth, 25, -11) #extract first 3 digit
    t1 <- read.csv(thlst1[m], header = TRUE)
    t1 <- t1[-nrow(t1), -1 ]
    t2 <- read.csv(thlst2[m], header = TRUE)
    t2 <- t2[-nrow(t2), -1]
    a <- subset(t1, select = c("test_maxsumsenspec", "test_equal_sens_spec", "mpa_0.9_clog"))
    b <- subset(t2, select = c("Minimum.training.presence.Cloglog.threshold", "X10.percentile.training.presence.Cloglog.threshold"))
    c <- cbind(a, b)
    colnames(c) <- c("MaxSS", "ESS", "MPA", "MTP", "P10TP")
    d <- summary(c)
    write.csv(t(as.matrix(d)), file= paste0("../output/maxent/models/summary_test_", mth, ".csv")) 
}


thlst <- list()
for (m in 1:length(thlst1)){
    mth <- thlst1[m]
    mth <- str_sub(mth, 25, -11) #extract first 3 digit
    t1 <- read.csv(thlst1[m], header = TRUE)
    t1 <- t1[-nrow(t1), -1 ]
    t2 <- read.csv(thlst2[m], header = TRUE)
    t2 <- t2[-nrow(t2), -1]
    a <- subset(t1, select = c("test_maxsumsenspec", "test_equal_sens_spec", "mpa_0.9_clog"))
    b <- subset(t2, select = c("Minimum.training.presence.Cloglog.threshold", "X10.percentile.training.presence.Cloglog.threshold"))
    ca <- cbind(a, b)
    colnames(ca) <- c("MaxSS", "ESS", "MPA", "MTP", "P10")
    ca$month <- mth

    thlst[[m]] <- ca
  }

stdep <- do.call(rbind, thlst)
stdep <- stdep[!(stdep$month == "jan"), ] #removes jan because you're not doing jan


p10p <- ggplot(data=stdep, aes(x=month, y=P10, fill=month)) + geom_boxplot() + stat_summary(fun.y=mean, colour="darkred", geom="point", shape=18, size=3) + theme(legend.position = "none")
mtpp <- ggplot(data=stdep, aes(x=month, y=MTP, fill=month)) + geom_boxplot() + stat_summary(fun.y=mean, colour="darkred", geom="point", shape=18, size=3) + theme(legend.position = "none")
plot(l)
mpap <- ggplot(data=stdep, aes(x=month, y=MPA, fill=month)) + geom_boxplot() + stat_summary(fun.y=mean, colour="darkred", geom="point", shape=18, size=3) + theme(legend.position = "none")
essp <- ggplot(data=stdep, aes(x=month, y=ESS, fill=month)) + geom_boxplot() + stat_summary(fun.y=mean, colour="darkred", geom="point", shape=18, size=3) + theme(legend.position = "none")
maxss <- ggplot(data=stdep, aes(x=month, y=MaxSS, fill=month)) + geom_boxplot() + stat_summary(fun.y=mean, colour="darkred", geom="point", shape=18, size=3) + theme(legend.position = "none")

plot_grid(p10p, mtpp, mpap, essp, maxss, labels = "AUTO")



library(reshape2)
k <- melt(stdep, id.var = c('month'), variable.name = 'threshold')
n <- subset(k, month == "aug")
o <- subset(k, month == "mar")

library(cowplot)
p <-ggplot(data=n, aes(x=threshold, y=value, fill=threshold)) + geom_boxplot() + stat_summary(fun.y=mean, colour="darkred", geom="point", shape=18, size=3) + theme(legend.position = "none")
q <-ggplot(data=o, aes(x=threshold, y=value, fill=threshold)) + geom_boxplot() + stat_summary(fun.y=mean, colour="darkred", geom="point", shape=18, size=3) + theme(legend.position = "none")
plot_grid(p, q, labels = "AUTO")




tsum <- stdep %>% # Start by defining the original dataframe, AND THEN...
                group_by(month) %>% # Define the grouping variable, AND THEN...
                summarise( # Now you define your summary variables with a name and a function...
                          maxss.mean = mean(MaxSS), mtp.mean = mean(MTP), ess.mean = mean(ESS), mpa.mean = mean(MPA), mean.p10 = mean(P10))

tsum
```

stacked maps
https://urbandemographics.blogspot.com/2016/04/creating-tilted-and-stacked-maps-in-r.html


```{r}
# load libraries
  library(rgeos)
  library(UScensus2000tract)
  library(ggplot2)
  library(dplyr)
  library(RColorBrewer)

# load data
  data("oregon.tract")

# plot Census Tract map
  plot(oregon.tract)
  
oregon.tract$id=as.character(1:nrow(oregon.tract))



clogasc_list <- list.files(paste0("../output/maxent/all_data/predictions/july"), pattern = "^avg_.*.asc", full.names = TRUE) # first list the files containing the data
a <- stack(clogasc_list) #stack the files

```
ok scrap tilt just do standard





```{r}
aea <- raster("../output/env/aea.tif") #the correct CRS
maplst <- list.files("../output/maxent/predictions/may", pattern = "^avg_clog.*.asc", full.names = TRUE)
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
apr <- aea@crs
brk <- seq(0, 1, 0.1) #for legend
lgc <- sequential_hcl(10, palette = "YlOrRd") #colour scheme from colorspace package
redtrans <- rgb(218, 215, 216, 120, maxColorValue=255) #mcp
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis



  pras6 <- raster(maplst[37])
  pras180 <- raster(maplst[14])
  pras370 <- raster(maplst[28])
  pras697 <- raster(maplst[41])
  crs(pras6) <- apr
  crs(pras180) <- apr
  crs(pras370) <- apr
  crs(pras697) <- apr
  ascname6 <- names(pras6)
  ascname180 <- names(pras180)
  ascname370 <- names(pras370)
  ascname697 <- names(pras697)
  
  
par(mfrow=c(1,4))


  lp6 <- plot(pras6, breaks=brk,  col=rev(lgc), axes = FALSE, box = FALSE, legend = FALSE)
  lp6 <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp6 <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  
  lp180 <- plot(pras180, breaks=brk,  col=rev(lgc), axes = FALSE, box = FALSE, legend = FALSE)
  lp180 <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp180 <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  
  lp370 <- plot(pras370, breaks=brk,  col=rev(lgc), axes = FALSE, box = FALSE, legend = FALSE)
  lp370 <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp370 <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  
  lp697 <- plot(pras697, breaks=brk,  col=rev(lgc), axes = FALSE, box = FALSE, legend = TRUE)
  lp697 <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp697 <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  
  print(lp6)
  dev.copy(png, (paste0("../output/maxent/all_data/predictions/testplots/", ascname6, ".png")), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
#}
  
  
  print(lp5)
  dev.copy(png, (paste0("../output/maxent/all_data/predictions/", ascname5, ".png")), width = 1920,height = 1080)
  dev.off() # stops automatic saving of the plot to a png))
#}
  

  
```

as above but with rcolorbrewer
```{r}
lp6 <- plot(pras6, breaks=brk, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = TRUE)
  lp6 <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp6 <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  
  lp180 <- plot(pras180, breaks=brk, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = TRUE)
  lp180 <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp180 <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  
  lp370 <- plot(pras370, breaks=brk, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = TRUE)
  lp370 <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp370 <- plot(s, col = "#474646", border = "#474646", add = TRUE)
  
  lp697 <- plot(pras697, breaks=brk, col=rev(colorRampPalette(brewer.pal(10, "Spectral"))(10)), axes = FALSE, box = FALSE, legend = TRUE)
  lp697 <- plot(outsidemcp,  col = redtrans, border = redtrans, add = TRUE)
  lp697 <- plot(s, col = "#474646", border = "#474646", add = TRUE)
```


with rastervis

```{r}
library(raster)
library(rgdal)
library(rasterVis)
library(colorspace)

aea <- raster("../output/env/aea.tif") #the correct CRS
maplst <- list.files("../output/maxent/predictions/may", pattern = "^avg_clog.*.asc", full.names = TRUE)
maplst2 <- list.files("../output/maxent/predictions/sep", pattern = "^avg_clog.*.asc", full.names = TRUE)
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
apr <- aea@crs
brk <- seq(0, 1, 0.1) #for legend
lgc <- sequential_hcl(10, palette = "YlOrRd") #colour scheme from colorspace package
redtrans <- rgb(218, 215, 216, 120, maxColorValue=255) #mcp
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis

pras6 <- raster(maplst[37])
pras180 <- raster(maplst[14])
pras370 <- raster(maplst[28])
pras697 <- raster(maplst[41])
p2ras6 <- raster(maplst2[37])
p2ras180 <- raster(maplst2[14])
p2ras370 <- raster(maplst2[28])
p2ras697 <- raster(maplst2[41])
crs(pras6) <- apr
crs(pras180) <- apr
crs(pras370) <- apr
crs(pras697) <- apr
crs(p2ras6) <- apr
crs(p2ras180) <- apr
crs(p2ras370) <- apr
crs(p2ras697) <- apr
ascname6 <- names(pras6)
ascname180 <- names(pras180)
ascname370 <- names(pras370)
ascname697 <- names(pras697)
a2scname6 <- names(p2ras6)
a2scname180 <- names(p2ras180)
a2scname370 <- names(p2ras370)
a2scname697 <- names(p2ras697)

# pstack <- stack(pras6, pras180, pras370, pras697) #stack the layers
# 
# pras1 <- raster(maplst[1])
# pras2 <- raster(maplst[2])
# pras3 <- raster(maplst[3])
# pras4 <- raster(maplst[4])
# crs(pras1) <- apr
# crs(pras2) <- apr
# crs(pras3) <- apr
# crs(pras4) <- apr

pstack <- stack(pras6, pras180, pras370, pras697, p2ras6, p2ras180, p2ras370, p2ras697) #stack the layers

cls <- c("6m", "180m", "370m", "697m")
rws <- c("May", "Sep")
mapTheme <- rasterTheme(region = rev(brewer.pal(10,"RdYlGn")))
my.at <- seq(0, 1, by = 0.1)


p <- levelplot(pstack, ylab = NULL, xlab = NULL, scales=list(draw=FALSE), colorkey=list(space="bottom", at = my.at), par.settings = mapTheme, layout = c(4, 2), names.attr = c("6m", "180m", "370m", "697m", "", "", "", ""), margin = FALSE)
p + layer(sp.polygons(s, fill = "black")) + layer (sp.polygons(outsidemcp, fill = redtrans, col = NA))


#dev.copy(png, (paste0("../output/maxent/predictions/testplots/rasterVis.png")), width = 1920,height = 1080)
#dev.off() # stops automatic saving of the plot to a png))



```

```{r}
histogram(pstack)
densityplot(pstack)
bwplot(pstack)
```


try hovmoller plotting for depth time

```{r}
#think i need to create a 4d raster with depth and time...
library(ncdf4)

writeRaster(pstack, "../output/maxent/predictions/testplots/pstack.nc", overwrite = TRUE, format = "CDF", varname = "prob", varunit = "p", longname = "dummy netcdf for hovmollers", xname= "X", yname = "Y", zname = "date", zunit = "date")

```



```{r}
pras6 <- raster::setZ(pras6, as.Date("0000-1-1"), name = "time")
pras180 <- raster::setZ(pras180, as.Date("0000-1-1"), name = "time")
pras370 <- raster::setZ(pras370, as.Date("0000-1-1"), name = "time")
pras697 <- raster::setZ(pras697, as.Date("0000-1-1"), name = "time")
pras1 <- raster::setZ(pras1, as.Date("0000-2-1"), name = "time")
pras2 <- raster::setZ(pras2, as.Date("0000-2-1"), name = "time")
pras3 <- raster::setZ(pras3, as.Date("0000-2-1"), name = "time")
pras4 <- raster::setZ(pras4, as.Date("0000-2-1"), name = "time")
```




```{r}
library(zoo)

old <- setwd(tempdir())
download.file('https://raw.github.com/oscarperpinan/spacetime-vis/master/data/SISmm2008_CMSAF.zip',
'SISmm2008_CMSAF.zip', method='wget')
unzip('SISmm2008_CMSAF.zip')
listFich <- dir(pattern='\\.nc')
stackSIS <- stack(listFich)
stackSIS <- stackSIS*24 ##from irradiance (W/m2) to irradiation Wh/m2



pbrick <- brick(pras6, pras180, pras370, pras697, pras1, pras2, pras3, pras4) #stack the layers

```

ok new play - try creating an individual netcdf for a month...
```{r}
plst <- list.files("../output/maxent/predictions/testplots/testrasters", full.names = TRUE)
aea <- raster("../output/env/aea.tif") #the correct CRS
apr <- aea@crs

i = 1

thlst <- list()
anlst <- list()
for (i in 1:length(plst)){
  r <- raster(plst[i])
  aname <- names(r)
  aname <-  str_sub(aname, 13)
  r <- setZ(r, as.numeric(aname), name = "depth")
  crs(r) <- apr
  thlst[[i]] <- r
  anlst[i] <- aname
}

nstk <- stack(thlst)
nstk <- setZ(nstk, anlst, name = "depth")

writeRaster(r, "../output/maxent/predictions/testplots/lstk2.nc", overwrite = TRUE, format = "CDF", varname = "prob", varunit = "p", longname = "dummy netcdf for hovmollers", xname= "X", yname = "Y", zname = "depth", zunit = "m")



dirXY <- xyLayer(r, sqrt(x^2 + y^2))
library(zoo)


hovmoller(nstk,
          at = seq(0, 1, .1),
                    interpolate = FALSE,
          par.settings = BuRdTheme)

hovmoller(nstk, ylab ="depth", interpolate = FALSE)

```


try create empty netcdf



```{r}
data.time <- 3:12 #months

#get depths
dep <- read.csv("../output/maxent/models/apr1998/stackdepthlist_1998.csv", header = TRUE)
dep <- dep$ascdepths

lon <- seq( -999722.7, 1525277, by = 25000)
lat <- seq ( 3538427, -211573.1, by = -25000)

data.distance <- seq(-65,920, by=5)
## Add dimensions and variables which accompany the dimensions (avoided by create_dimvar = FALSE)
dimDepth <- ncdim_def(name='depth', units='m', longname='depth layer', vals=data.distance )
dimTime <- ncdim_def('time', units='month', longname='measurement month', calendar="standard", vals=data.time)


varLat <- ncvar_def(name='lat', units='meters_north', dim=list(lat), missval=NA, longname='lat_m', prec='double')
varLon <- ncvar_def(name='lon', units='meters_east', dim=list(lon), missval=NA, longname='lon_m', prec='double')

varAlt <- ncvar_def(name='depth', units='m', dim=list(dimDepth, dimTime), missval=-9999, longname='depth layer')

vars <- list(varLat, varLon, varAlt)

outputfile <- 'transect.nc'
con <- nc_create(outputfile, vars)

```


#argh
```{r}
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis

clogasc_list <- list.files(paste0("../output/maxent/predictions/dec"), pattern = "^avg_cloglog_.*.asc", full.names = TRUE) #just choose a random month to calculate cells
cumst <- data.frame(0, 0)
colnames(cumst) <- c("depth", "no_cells")
for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[6])
  ascname <- names(cumasc)
  cumst[cum, 1] <- str_sub(ascname, 13)
  cumasc2 <- raster::mask(cumasc, outsidemcp, inverse = TRUE)
  ccnt <- freq(cumasc2, useNA='no')
  ccnt <- sum(ccnt[ ,2])
  cumst[cum, 2] <- ccnt
}


clogasc_listm <- list.files(paste0("../output/maxent/predictions/mar"), pattern = "^avg_cloglog_.*.asc", full.names = TRUE) #just choose a random month to calculate cells
cumstm <- data.frame(0, 0)
colnames(cumstm) <- c("depth", "no_cells")
for (cum in 1:length(clogasc_listm)){
  cumascm <- raster(clogasc_listm[6])
  ascnamem <- names(cumascm)
  cumstm[cum, 1] <- str_sub(ascnamem, 13)
  cumasc2m <- raster::mask(cumascm, outsidemcp, inverse = TRUE)
  ccntm <- freq(cumasc2, useNA='no')
  ccntm <- sum(ccntm[ ,2])
  cumstm[cum, 2] <- ccntm
}





cumst$depth <- as.numeric(cumst$depth)
cumst1 <- cumst[order(cumst$no_cells), ]

write.csv(cumst1, "../output/maxent/paper_plots/prob_by_depth/cellsperlayermar.csv", row.names = FALSE)

```




```{r avg asc layers cloglog xx}
#p <- read.csv("../output/bio/presab_nafo_yr.csv", header= TRUE)
mthna <- "nov"
mthno <- "11"
prback <- subset(p, month == mthno)
modelmonth <- cbind(paste0(mthna, unique(prback$year)))
timeslice <- modelmonth[1]

clogasc_list <- list.files(paste0("../output/maxent/predictions/", mthna), pattern = "^cloglog_.*.asc", full.names = TRUE)
stlst <- list.files(paste0("../output/maxent/models/", timeslice), pattern = "stackdepth.*.csv", full.names = TRUE)
stdep <- read.csv(stlst[1])
stdep$ascdepths <- str_sub(stdep$stackname, 9)
depthlayers <- data.frame(cbind(unique(stdep$ascdepths)))
names(depthlayers)[names(depthlayers) == "cbind.unique.stdep.ascdepths.."] <- "depth"
depthlayers$depth <- as.character(depthlayers$depth)

colno <- 1


for (d in 1:nrow(depthlayers)){
  dep <- depthlayers$depth[d]
  for (a in 1:length(clogasc_list)){
    asc <- clogasc_list[a]
    ascd <- str_sub(asc, 50, -5)
    if (grepl(dep, ascd)){
      depthlayers[d , paste0("a", colno)] <- asc
       colno <- colno+1
    }
  }
}
write.csv(depthlayers, (paste0("../output/maxent/predictions/", mthna, "/cloglog_asclayerbydepth.csv")), row.names = TRUE)



for (x in 1:nrow(depthlayers)){
  asclay <- depthlayers[x, ]
  asclay <- asclay[!is.na(asclay)]
  asclay <- as.data.frame(rbind(asclay))
  asclay$V1 <- as.character(asclay$V1) #v1 corresponds to depth
  asclay$V2 <- as.character(asclay$V2) #v2 to end corresponds to year
  asclay$V3 <- as.character(asclay$V3)
  asclay$V4 <- as.character(asclay$V4)
  asclay$V5 <- as.character(asclay$V5)
  asclay$V6 <- as.character(asclay$V6)
  asclay$V7 <- as.character(asclay$V7)
  asclay$V8 <- as.character(asclay$V8)
  asclay$V9 <- as.character(asclay$V9)
  asclay$V10 <- as.character(asclay$V10)
  asclay$V11 <- as.character(asclay$V11)
  asclay$V12 <- as.character(asclay$V12)
  asclay$V13 <- as.character(asclay$V13)
  asclay$V14 <- as.character(asclay$V14)
  asclay$V15 <- as.character(asclay$V15)
  asclay$V16 <- as.character(asclay$V16)
  asclay$V17<- as.character(asclay$V17)
  # asclay$V18 <- as.character(asclay$V18)
  # asclay$V19<- as.character(asclay$V19)

  
  asclaydep <- asclay$V1
  
  asc1998 <- raster(asclay$V2)
  asc1999 <- raster(asclay$V3)
  asc2000 <- raster(asclay$V4)
  asc2001 <- raster(asclay$V5)
  asc2002 <- raster(asclay$V6)
  asc2003 <- raster(asclay$V7)
  asc2004 <- raster(asclay$V8)
  asc2005 <- raster(asclay$V9)
  asc2006 <- raster(asclay$V10)
  asc2007 <- raster(asclay$V11)
  asc2008 <- raster(asclay$V12)
  asc2009 <- raster(asclay$V13)
  asc2010 <- raster(asclay$V14)
  asc2011 <- raster(asclay$V15)
  asc2012 <- raster(asclay$V16)
  asc2013 <- raster(asclay$V17)
  # asc2014 <- raster(asclay$V18)
  # asc2015 <- raster(asclay$V19)


  stkasc <- stack(asc1998, asc1999, asc2000, asc2001, asc2002, asc2003, asc2004, asc2005, asc2006, asc2007, asc2008, asc2009, asc2010, asc2011, asc2012, asc2013) #, asc2014, asc2015)

  avg <- mean(stkasc, na.rm = TRUE)
  
  writeRaster(avg, paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_", asclaydep, ".asc"), overwrite=TRUE)
  avgplot <- plot(avg, png(paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_", asclaydep, ".png"))) 
  dev.off()
  
file.rename(paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_000120.asc"), paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_120.asc"))
file.rename(paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_000120.png"), paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_120.png"))
file.rename(paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_041.18.asc"), paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_41.18.asc"))
file.rename(paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_041.18.png"), paste0("../output/maxent/predictions/", mthna, "/avg_cloglog_41.18.png"))
}

```



#2d hotspot maps

first create layers that are 0.5 and above

```{r habitat classification on probability - >0.5}

binprob <- function(x){
  ifelse(x >= 0.5, 1,
  ifelse(x < 0.5, 0, NA)) 
}

mthord <- c("mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")

for (m in 1:length(mthord)){
  mthna <- mthord[m]
  clogasc_list <- list.files(paste0("../output/maxent/predictions/", mthna), pattern = "^avg_cloglog_.*asc", full.names = TRUE)
  for (cum in 1:length(clogasc_list)){
    cumasc <- raster(clogasc_list[cum])
    ascname <- names(cumasc)
    ascname <- gsub("avg_cloglog_", "", ascname)
    probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
    writeRaster(probbin, paste0("../output/maxent/predictions/mar/", mthna,  "_binary_0.5_", ascname, ".asc"), overwrite = TRUE)
     plot(probbin, png(paste0("../output/maxent/predictions/mar/", mthna, "_binary_0.5_", ascname, ".png")), overwrite = TRUE)
       dev.off() # stops automatic saving of the plot to a png
  }
}

```

then create an summary map....
```{r high probability map per year 2D representation}
mthord <- c("mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")

for (m in 1:length(mthord)){
  mthna <- mthord[m]
  binaryprob_list <- list.files(paste0("../output/maxent/predictions/mar/"), pattern = paste0(mthna, "*_binary_0.5_.*.asc$"), full.names = TRUE)
  binstack <- stack(binaryprob_list)
  stacksum <- sum(binstack, na.rm = TRUE)
  writeRaster(stacksum, paste0("../output/maxent/predictions/mar/", mthna, "_bin_0.5_2d.asc"), overwrite=TRUE)
  plot(stacksum, png(paste0("../output/maxent/predictions/mar/", mthna, "_bin_0.5_2d.png")))
  dev.off()
}

```

#trimming maps to mcp


```{r}
library(viridis)
library(rasterVis)

aea <- raster("../output/env/aea.tif") #the correct CRS
maplst <- list.files("../output/maxent/predictions/mar/", pattern = "_bin_0.5_2d.*.asc", full.names = TRUE)
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
apr <- aea@crs
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
mcp <- shapefile("../output/bio/minimum_convex_poly/mcp_capelin_100_poly.shp")

cumasc <- raster(maplst[1])
cumasc2 <- raster(maplst[2])
cumasc <- raster::mask(cumasc, mcp)
cumasc2 <- raster::mask(cumasc2, mcp)
ss <- raster::intersect(s, mcp) 


pstack <- stack(cumasc, cumasc2)

my.at <- seq(0, 1, by = 0.1)
mapTheme <- infernoTheme(region = rev(inferno(10)))

p <- levelplot(pstack, ylab = NULL, xlab = NULL, scales=list(draw=FALSE), colorkey=list(space="bottom", at = my.at), par.settings = mapTheme, layout = c(5, 2), names.attr = c("Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), margin = FALSE) + latticeExtra::layer(sp.polygons(ss, fill = "dark grey", col = "transparent"))
plot(p)



```



# add contour?
need to add seabed

```{r seabed files}
contwgs <- shapefile("../data/env/contours_50m.shp") #created in arcgis from glorys bottomdepth using 3d licence contour tool
plot(contwgs)
aea <- raster("../output/env/aea.tif") #the correct CRS
corcrs <- aea@crs
contaea <- raster::reproject(contwgs, aea) 


```

#coloured histograms

```{r}
mar <- raster("../output/maxent/predictions/mar/avg_cloglog_97.0413.asc")
#apr <- raster("../output/maxent/predictions/apr/avg_cloglog_97.0413.asc")

mardf <- as.data.frame(mar) #convert raster to dataframe
mardf <- na.omit(mardf) #remove all the land 
for (i in 1:nrow(mardf)){
  if (mardf$avg_cloglog_97.0413[i] <=0.1){
    mardf$bin[i] <- 1
  } else if (mardf$avg_cloglog_97.0413[i] >0.1 & mardf$avg_cloglog_97.0413[i] <= 0.2){
      mardf$bin[i] <- 2
  } else if (mardf$avg_cloglog_97.0413[i] >0.2 & mardf$avg_cloglog_97.0413[i] <= 0.3){
      mardf$bin[i] <- 3
  } else if (mardf$avg_cloglog_97.0413[i] >0.3 & mardf$avg_cloglog_97.0413[i] <= 0.4){
      mardf$bin[i] <- 4
  } else if (mardf$avg_cloglog_97.0413[i] >0.4 & mardf$avg_cloglog_97.0413[i] <= 0.5){
      mardf$bin[i] <- 5
  } else if (mardf$avg_cloglog_97.0413[i] >0.5 & mardf$avg_cloglog_97.0413[i] <= 0.6){
      mardf$bin[i] <- 6
  } else if (mardf$avg_cloglog_97.0413[i] >0.6 & mardf$avg_cloglog_97.0413[i] <= 0.7){
      mardf$bin[i] <- 7
  } else if (mardf$avg_cloglog_97.0413[i] >0.7 & mardf$avg_cloglog_97.0413[i] <= 0.8){
      mardf$bin[i] <- 8
  } else if (mardf$avg_cloglog_97.0413[i] >0.8 & mardf$avg_cloglog_97.0413[i] <= 0.9){
      mardf$bin[i] <- 9
  } else if (mardf$avg_cloglog_97.0413[i] >0.9){
      mardf$bin[i] <- 10
  }
}

mardf$bin <- as.factor(mardf$bin)

brk <- seq(0.1, 1, 0.1) #bins you want
brkl <- as.character(brk)


p <- ggplot(mardf, aes(x = avg_cloglog_97.0413, fill = bin))+ geom_histogram(breaks = brk) + theme_classic() + scale_fill_viridis_d(option = "inferno", direction = -1) + theme(legend.position = "none", plot.title = element_blank(), axis.title.x = element_blank(), axis.title.y = element_blank()) + scale_x_continuous(breaks=seq(0,1,0.1))
png(paste0("../output/maxent/paper_plots/histogram_", mthna, "_", dep, ".png"), height = 1024, width = 1024)
p
dev.off()

```


#selected maps pt2

get unique depths
```{r}
mar <- read.csv("../output//maxent/paper_plots/prob_by_depth/mar_u0.4s_dis_prob_cells.csv", header = TRUE)
mar <- mar[!(mar$Depth =="1151.99" | mar$Depth =="1265.86" | mar$Depth =="1387.38"), ]
mar$Probability <- gsub(">0.9", "0.9 - 1", mar$Probability)
mar$Depth <- as.factor(mar$Depth)
flevelsm <- levels(mar$Depth)
```



```{r}
library(raster)
library(rgdal)
library(rasterVis)
library(colorspace)

aea <- raster("../output/env/aea.tif") #the correct CRS
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
acrs <- aea@crs
mcp <- shapefile("../output/bio/minimum_convex_poly/mcp_capelin_100_poly.shp")
ss <- raster::intersect(s, mcp)  #trim land file to mcp

#selmth <- c("mar", "jun", "sep", "dec")
#seldep <- c("11.7737", "61.1128", "199.79", "628.026")


mar11 <- raster("../output/maxent/predictions/mar/avg_cloglog_11.7737.asc")
mar61 <- raster("../output/maxent/predictions/mar/avg_cloglog_61.1128.asc")
mar199 <- raster("../output/maxent/predictions/mar/avg_cloglog_199.79.asc")
mar628 <- raster("../output/maxent/predictions/mar/avg_cloglog_628.026.asc")
mar11@crs <- acrs
mar61@crs <- acrs
mar199@crs <- acrs
mar628@crs <- acrs
mar11 <- raster::mask(mar11, mcp)
mar61 <- raster::mask(mar61, mcp)
mar199 <- raster::mask(mar199, mcp)
mar628 <- raster::mask(mar628, mcp)


jun11 <- raster("../output/maxent/predictions/jun/avg_cloglog_11.7737.asc")
jun61 <- raster("../output/maxent/predictions/jun/avg_cloglog_61.1128.asc")
jun199 <- raster("../output/maxent/predictions/jun/avg_cloglog_199.79.asc")
jun628 <- raster("../output/maxent/predictions/jun/avg_cloglog_628.026.asc")
jun11@crs <- acrs
jun61@crs <- acrs
jun199@crs <- acrs
jun628@crs <- acrs
jun11 <- raster::mask(jun11, mcp)
jun61 <- raster::mask(jun61, mcp)
jun199 <- raster::mask(jun199, mcp)
jun628 <- raster::mask(jun628, mcp)

sep11 <- raster("../output/maxent/predictions/sep/avg_cloglog_11.7737.asc")
sep61 <- raster("../output/maxent/predictions/sep/avg_cloglog_61.1128.asc")
sep199 <- raster("../output/maxent/predictions/sep/avg_cloglog_199.79.asc")
sep628 <- raster("../output/maxent/predictions/sep/avg_cloglog_628.026.asc")
sep11@crs <- acrs
sep61@crs <- acrs
sep199@crs <- acrs
sep628@crs <- acrs
sep11 <- raster::mask(sep11, mcp)
sep61 <- raster::mask(sep61, mcp)
sep199 <- raster::mask(sep199, mcp)
sep628 <- raster::mask(sep628, mcp)

dec11 <- raster("../output/maxent/predictions/dec/avg_cloglog_11.7737.asc")
dec61 <- raster("../output/maxent/predictions/dec/avg_cloglog_61.1128.asc")
dec199 <- raster("../output/maxent/predictions/dec/avg_cloglog_199.79.asc")
dec628 <- raster("../output/maxent/predictions/dec/avg_cloglog_628.026.asc")
dec11@crs <- acrs
dec61@crs <- acrs
dec199@crs <- acrs
dec628@crs <- acrs
dec11 <- raster::mask(dec11, mcp)
dec61 <- raster::mask(dec61, mcp)
dec199 <- raster::mask(dec199, mcp)
dec628 <- raster::mask(dec628, mcp)

#2d plots
mar2d <- raster("../output/maxent/paper_plots/hotspot_mapping/mar_bin_0.5_2d_single.asc")
mar2d <- raster::mask(mar2d, mcp)
mar2d@crs <- acrs
jun2d <- raster("../output/maxent/paper_plots/hotspot_mapping/jun_bin_0.5_2d_single.asc")
jun2d <- raster::mask(jun2d, mcp)
jun2d@crs <- acrs
sep2d <- raster("../output/maxent/paper_plots/hotspot_mapping/sep_bin_0.5_2d_single.asc")
sep2d <- raster::mask(sep2d, mcp)
sep2d@crs <- acrs
dec2d <- raster("../output/maxent/paper_plots/hotspot_mapping/dec_bin_0.5_2d_single.asc")
dec2d <- raster::mask(dec2d, mcp)
dec2d@crs <- acrs

#mar2d, jun2d, sep2d, dec2d, 

pstack <- stack(mar11, jun11, sep11, dec11, mar61, jun61, sep61, dec61, mar199, jun199, sep199, dec199, mar628, jun628, sep628, dec628) #stack the layers - printed row-wise
 
rws <- c("11.7737 m", "61.1128 m", "199.70 m", "628.026 m", "", "", "", "", "", "", "", "", "", "", "", "")
cls <- c("March", "June", "September", "December", "", "", "", "", "", "", "", "", "", "", "", "")
myTheme <- rasterTheme(region = inferno(rev(10)))
my.at <- seq(0, 1, by = 0.1)

p <- levelplot(pstack, ylab = NULL, xlab = NULL, colorkey=list(space="bottom", at = my.at), par.settings = myTheme, layout = c(4, 4), margin = FALSE, scales=list(draw=FALSE), col.regions=rev(inferno(10)), at= my.at, names.attr = cls) + latticeExtra::layer(sp.polygons(ss, fill = "dark grey", col = "transparent"))+ latticeExtra::layer(sp.polygons(mcp, col = "dark grey"))
png("../output/maxent/paper_plots/bydepth.png", height = 1024, width = 1024)
p
dev.off()


```


# variable maps ALSO FOR P2
- temp
- chl 
- o2
- sal
- 4 different months
- relationship of variables to each other
- pick a depth (say the 11.7737 m)

months are mar, jun, sep, dec
pick 3 diff years say 1998, 2006, 2013

```{r}
aea <- raster("../output/env/aea.tif") #the correct CRS
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
acrs <- aea@crs
mcp <- shapefile("../output/bio/minimum_convex_poly/mcp_capelin_100_poly.shp")
ss <- raster::intersect(s, mcp)  #trim land file to mcp

yrlst <- c("1998", "2006", "2013")
mthlst <- c("03", "06", "09", "12")
varlst <- c("temp", "salinity", "o2")

for (y in 1:length(yrlst)){
  yr <- yrlst[y]
  fdr <- paste0("../data/env/ascii/ascii", yr, "/")
  for (m in 1:length(mthlst)){
    mt <- mthlst[m]
    for (v in 1:length(varlst)){
      var <- varlst[v]
      ras <- raster(paste0(fdr, yr, "_", mt, "_", var, ".nc_11.7737.asc"))
      lyrnm <- names(ras)
      crs(ras) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
      ras <- projectRaster(ras, aea)
      ras <- raster::mask(ras, mcp)
      
      p <- levelplot(ras, margin=FALSE, colorkey=list(space='bottom', axis.line=list(col='black')), par.settings=list(axis.line=list(col='transparent')), scales=list(draw=FALSE), col.regions=colorRampPalette(blue2red(20))) + layer(sp.polygons(ss, fill = "dark grey", col = "transparent"))
              
      png(paste0("../output/maxent/paper_plots/", lyrnm, ".png"), height = 1024, width = 1024)
      print(p)
      dev.off()
    }
  }
}



```

#variable interactions... KEEP FOR P2

```{r}
yrlst <- c("1998", "2006", "2013")
mthlst <- c("03", "06", "09", "12")
varlst <- c("temp", "salinity", "o2")
scbr <- stack()


for (y in 1:length(yrlst)){
  yr <- yrlst[y]
  fdr <- paste0("../data/env/ascii/ascii", yr, "/")
  for (m in 1:length(mthlst)){
    mt <- mthlst[m]
    for (v in 1:length(varlst)){
      var <- varlst[v]
      ras <- raster(paste0(fdr, yr, "_", mt, "_", var, ".nc_11.7737.asc"))
      lyrnm <- names(ras)
      crs(ras) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
      ras <- projectRaster(ras, aea)
      ras <- raster::mask(ras, mcp)
      scbr <- stack(scbr, ras)
    }
  }
}
a <- xyplot(X2013_12_temp.nc_11.7737~X2013_12_salinity.nc_11.7737, data = scbr, auto.key = list(space='right'))
b <- xyplot(X2013_06_temp.nc_11.7737~X2013_06_salinity.nc_11.7737, data = scbr, auto.key = list(space='right'))

a
b
```

```{r}
splom(scbr)
```


#2d plots - part 2

the cowplot experiment

```{r}
library(raster)
library(rgdal)
library(ggplot2)

aea <- raster("../output/env/aea.tif") #the correct CRS
s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
acrs <- aea@crs
mcp <- shapefile("../output/bio/minimum_convex_poly/mcp_capelin_100_poly.shp")
ss <- raster::intersect(s, mcp)  #trim to mcp


mar2d <- raster("../output/maxent/paper_plots/hotspot_mapping/mar_bin_0.5_2d_single.asc")
apr2d <- raster("../output/maxent/paper_plots/hotspot_mapping/apr_bin_0.5_2d_single.asc")
may2d <- raster("../output/maxent/paper_plots/hotspot_mapping/may_bin_0.5_2d_single.asc")
jun2d <- raster("../output/maxent/paper_plots/hotspot_mapping/jun_bin_0.5_2d_single.asc")
jul2d <- raster("../output/maxent/paper_plots/hotspot_mapping/jul_bin_0.5_2d_single.asc")
aug2d <- raster("../output/maxent/paper_plots/hotspot_mapping/aug_bin_0.5_2d_single.asc")
sep2d <- raster("../output/maxent/paper_plots/hotspot_mapping/sep_bin_0.5_2d_single.asc")
oct2d <- raster("../output/maxent/paper_plots/hotspot_mapping/oct_bin_0.5_2d_single.asc")
nov2d <- raster("../output/maxent/paper_plots/hotspot_mapping/nov_bin_0.5_2d_single.asc")
dec2d <- raster("../output/maxent/paper_plots/hotspot_mapping/dec_bin_0.5_2d_single.asc")

#trim to mcp
mar2d <- raster::mask(mar2d, mcp)
apr2d <- raster::mask(apr2d, mcp)
may2d <- raster::mask(may2d, mcp)
jun2d <- raster::mask(jun2d, mcp)
jul2d <- raster::mask(jul2d, mcp)
aug2d <- raster::mask(aug2d, mcp)
sep2d <- raster::mask(sep2d, mcp)
oct2d <- raster::mask(oct2d, mcp)
nov2d <- raster::mask(nov2d, mcp)
dec2d <- raster::mask(dec2d, mcp)

#add crs
mar2d@crs <- acrs
apr2d@crs <- acrs
may2d@crs <- acrs
jun2d@crs <- acrs
jul2d@crs <- acrs
aug2d@crs <- acrs
sep2d@crs <- acrs
oct2d@crs <- acrs
nov2d@crs <- acrs
dec2d@crs <- acrs

#ratify to categorical
mar2d <- ratify(mar2d)
rat <- levels(mar2d)[[1]]
rat$suitability <- c("< 0.5", "> 0.5")
levels(mar2d) <- rat
apr2d <- ratify(apr2d)
rat <- levels(apr2d)[[1]]
rat$suitability <- c("< 0.5", "> 0.5")
levels(apr2d) <- rat
may2d <- ratify(may2d)
rat <- levels(may2d)[[1]]
rat$suitability <- c("< 0.5", "> 0.5")
levels(may2d) <- rat
jun2d <- ratify(jun2d)
rat <- levels(jun2d)[[1]]
rat$suitability <- c("< 0.5", "> 0.5")
levels(jun2d) <- rat
jul2d <- ratify(jul2d)
rat <- levels(jul2d)[[1]]
rat$suitability <- c("< 0.5", "> 0.5")
levels(jul2d) <- rat
aug2d <- ratify(aug2d)
rat <- levels(aug2d)[[1]]
rat$suitability <- c("< 0.5", "> 0.5")
levels(aug2d) <- rat
sep2d <- ratify(sep2d)
rat <- levels(sep2d)[[1]]
rat$suitability <- c("< 0.5", "> 0.5")
levels(sep2d) <- rat
oct2d <- ratify(oct2d)
rat <- levels(oct2d)[[1]]
rat$suitability <- c("< 0.5", "> 0.5")
levels(oct2d) <- rat
nov2d <- ratify(nov2d)
rat <- levels(nov2d)[[1]]
rat$suitability <- c("< 0.5", "> 0.5")
levels(nov2d) <- rat
dec2d <- ratify(dec2d)
rat <- levels(dec2d)[[1]]
rat$suitability <- c("< 0.5", "> 0.5")
levels(dec2d) <- rat

```

now the histograms

```{r}
mar <- read.csv("../output/maxent/paper_plots/prob_by_depth/mar_dis_prob_cells.csv", header = TRUE)
mar <- mar[!(mar$Depth =="1151.99" | mar$Depth =="1265.86" | mar$Depth =="1387.38"), ]
mar$Probability <- gsub(">0.9", "0.9 - 1", mar$Probability)
mar$Depth <- as.factor(mar$Depth)
flevelsmar <- levels(mar$Depth)
flevelsmar <- rev(flevelsmar)

apr <- read.csv("../output/maxent/paper_plots/prob_by_depth/apr_dis_prob_cells.csv", header = TRUE)
apr <- apr[!(apr$Depth =="1151.99" | apr$Depth =="1265.86" | apr$Depth =="1387.38"), ]
apr$Probability <- gsub(">0.9", "0.9 - 1", apr$Probability)
apr$Depth <- as.factor(apr$Depth)
flevelsapr <- levels(apr$Depth)
flevelsapr <- rev(flevelsapr)

may <- read.csv("../output/maxent/paper_plots/prob_by_depth/may_dis_prob_cells.csv", header = TRUE)
may <- may[!(may$Depth =="1151.99" | may$Depth =="1265.86" | may$Depth =="1387.38"), ]
may$Probability <- gsub(">0.9", "0.9 - 1", may$Probability)
may$Depth <- as.factor(may$Depth)
flevelsmay <- levels(may$Depth)
flevelsmay <- rev(flevelsmay)

jun <- read.csv("../output/maxent/paper_plots/prob_by_depth/jun_dis_prob_cells.csv", header = TRUE)
jun <- jun[!(jun$Depth =="1151.99" | jun$Depth =="1265.86" | jun$Depth =="1387.38"), ]
jun$Probability <- gsub(">0.9", "0.9 - 1", jun$Probability)
jun$Depth <- as.factor(jun$Depth)
flevelsjun <- levels(jun$Depth)
flevelsjun <- rev(flevelsjun)

jul <- read.csv("../output/maxent/paper_plots/prob_by_depth/jul_dis_prob_cells.csv", header = TRUE)
jul <- jul[!(jul$Depth =="1151.99" | jul$Depth =="1265.86" | jul$Depth =="1387.38"), ]
jul$Probability <- gsub(">0.9", "0.9 - 1", jul$Probability)
jul$Depth <- as.factor(jul$Depth)
flevelsjul <- levels(jul$Depth)
flevelsjul <- rev(flevelsjul)

aug <- read.csv("../output/maxent/paper_plots/prob_by_depth/aug_dis_prob_cells.csv", header = TRUE)
aug <- aug[!(aug$Depth =="1151.99" | aug$Depth =="1265.86" | aug$Depth =="1387.38"), ]
aug$Probability <- gsub(">0.9", "0.9 - 1", aug$Probability)
aug$Depth <- as.factor(aug$Depth)
flevelsaug <- levels(aug$Depth)
flevelsaug <- rev(flevelsaug)

sep <- read.csv("../output/maxent/paper_plots/prob_by_depth/sep_dis_prob_cells.csv", header = TRUE)
sep <- sep[!(sep$Depth =="1151.99" | sep$Depth =="1265.86" | sep$Depth =="1387.38"), ]
sep$Probability <- gsub(">0.9", "0.9 - 1", sep$Probability)
sep$Depth <- as.factor(sep$Depth)
flevelssep <- levels(sep$Depth)
flevelssep <- rev(flevelssep)

oct <- read.csv("../output/maxent/paper_plots/prob_by_depth/oct_dis_prob_cells.csv", header = TRUE)
oct <- oct[!(oct$Depth =="1151.99" | oct$Depth =="1265.86" | oct$Depth =="1387.38"), ]
oct$Probability <- gsub(">0.9", "0.9 - 1", oct$Probability)
oct$Depth <- as.factor(oct$Depth)
flevelsoct <- levels(oct$Depth)
flevelsoct <- rev(flevelsoct)

nov <- read.csv("../output/maxent/paper_plots/prob_by_depth/nov_dis_prob_cells.csv", header = TRUE)
nov <- nov[!(nov$Depth =="1151.99" | nov$Depth =="1265.86" | nov$Depth =="1387.38"), ]
nov$Probability <- gsub(">0.9", "0.9 - 1", nov$Probability)
nov$Depth <- as.factor(nov$Depth)
flevelsnov <- levels(nov$Depth)
flevelsnov <- rev(flevelsnov)

dec <- read.csv("../output/maxent/paper_plots/prob_by_depth/dec_dis_prob_cells.csv", header = TRUE)
dec <- dec[!(dec$Depth =="1151.99" | dec$Depth =="1265.86" | dec$Depth =="1387.38"), ]
dec$Probability <- gsub(">0.9", "0.9 - 1", dec$Probability)
dec$Depth <- as.factor(dec$Depth)
flevelsdec <- levels(dec$Depth)
flevelsdec <- rev(flevelsdec)

pm <- ggplot(mar, aes(Depth, p_cells, fill = Probability)) + geom_col(width = 1) + coord_flip() + scale_fill_viridis(option="magma", discrete = TRUE, direction = -1) + scale_x_discrete(limits = flevelsmar, breaks=flevelsmar[seq(1,length(flevelsmar), by = 2)], ) + coord_flip() + labs(title = "March") + theme_half_open(12) + theme(plot.margin = margin(6, 0, 6, 0), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.position = "none", axis.text.x = element_blank()) 

pa <- ggplot(apr, aes(Depth, p_cells, fill = Probability)) + geom_col(width = 1) + coord_flip() + scale_fill_viridis(option="magma", discrete = TRUE, direction = -1) + scale_x_discrete(limits = flevelsapr, breaks=flevelsapr[seq(1,length(flevelsapr), by = 2)], ) + coord_flip() + labs(title = "April") + theme_half_open(12) + theme(plot.margin = margin(6, 0, 6, 0), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.position = "none", axis.text.x = element_blank(), axis.text.y = element_blank()) 

pma <- ggplot(may, aes(Depth, p_cells, fill = Probability)) + geom_col(width = 1) + coord_flip() + scale_fill_viridis(option="magma", discrete = TRUE, direction = -1) + scale_x_discrete(limits = flevelsmay, breaks=flevelsmay[seq(1,length(flevelsmay), by = 2)], ) + coord_flip() + labs(y = "% Ocean at Depth", title = "May") + theme_half_open(12) + theme(plot.margin = margin(6, 0, 6, 0), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.position = "none", axis.text.x = element_blank(), axis.text.y = element_blank()) 

pj <- ggplot(jun, aes(Depth, p_cells, fill = Probability)) + geom_col(width = 1) + coord_flip() +  scale_fill_viridis(option="magma", discrete = TRUE, direction = -1) + scale_x_discrete(limits = flevelsjun, breaks=flevelsjun[seq(1,length(flevelsjun), by = 2)]) + coord_flip() +labs(y = "% Ocean at Depth", title = "June") + theme_half_open(12) + theme(plot.margin = margin(6, 0, 6, 0), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.position = "none", axis.text.x = element_blank(), axis.text.y = element_blank())

pju <- ggplot(jul, aes(Depth, p_cells, fill = Probability)) + geom_col(width = 1) + coord_flip() + scale_fill_viridis(option="magma", discrete = TRUE, direction = -1) + scale_x_discrete(limits = flevelsjul, breaks=flevelsjul[seq(1,length(flevelsjul), by = 2)], ) + coord_flip() + labs(y = "% Ocean at Depth", title = "July") + theme_half_open(12) + theme(plot.margin = margin(6, 0, 6, 0), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.position = "none", axis.text.x = element_blank(), axis.text.y = element_blank()) 

pau <- ggplot(aug, aes(Depth, p_cells, fill = Probability)) + geom_col(width = 1) + coord_flip() + scale_fill_viridis(option="magma", discrete = TRUE, direction = -1) + scale_x_discrete(limits = flevelsaug, breaks=flevelsaug[seq(1,length(flevelsaug), by = 2)], ) + coord_flip() + labs(y = "% Ocean at Depth", title = "August") + theme_half_open(12) + theme(plot.margin = margin(6, 0, 6, 0), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.position = "none") 

ps <- ggplot(sep, aes(Depth, p_cells, fill = Probability)) + geom_col(width = 1) + coord_flip() +  scale_fill_viridis(option="magma", discrete = TRUE, direction = -1) + scale_x_discrete(limits = flevelssep, breaks=flevelssep[seq(1,length(flevelssep), by = 2)]) + coord_flip() +labs(y = "% Ocean at Depth", title = "September") + theme_half_open(12) + theme(plot.margin = margin(6, 0, 6, 0), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.position = "none", axis.text.y = element_blank())

po <- ggplot(oct, aes(Depth, p_cells, fill = Probability)) + geom_col(width = 1) + coord_flip() + scale_fill_viridis(option="magma", discrete = TRUE, direction = -1) + scale_x_discrete(limits = flevelsoct, breaks=flevelsoct[seq(1,length(flevelsoct), by = 2)], ) + coord_flip() + labs(y = "% Ocean at Depth", title = "October") + theme_half_open(12) + theme(plot.margin = margin(6, 0, 6, 0), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.position = "none", axis.text.y = element_blank()) 

pn <- ggplot(nov, aes(Depth, p_cells, fill = Probability)) + geom_col(width = 1) + coord_flip() + scale_fill_viridis(option="magma", discrete = TRUE, direction = -1) + scale_x_discrete(limits = flevelsnov, breaks=flevelsnov[seq(1,length(flevelsnov), by = 2)], ) + coord_flip() + labs(y = "% Ocean at Depth", title = "November") + theme_half_open(12) + theme(plot.margin = margin(6, 0, 6, 0), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.position = "none", axis.text.y = element_blank()) 

pd <- ggplot(dec, aes(Depth, p_cells, fill = Probability)) + geom_col(width = 1) + coord_flip() +  scale_fill_viridis(option = "magma", discrete = TRUE, direction = -1) + scale_x_discrete(limits = flevelsdec, breaks=flevelsdec[seq(1,length(flevelsdec), by = 2)]) + coord_flip() +labs(title = "December") + theme_half_open(12) + theme(plot.margin = margin(6, 0, 6, 0), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.position = "none", axis.text.y = element_blank())


pm
pa
pma
pj
pju
pau
ps
po
pn
pd
```

merge the maps and histograms into one giant plot

```{r}
maplst <- list(mar2d, pm, apr2d, pa, may2d, pma, jun2d, pj, jul2d, pju, aug2d, pa, sep2d, ps, oct2d, po, nov2d, pn, dec2d, pd)


marmap <- levelplot(mar2d, col.regions=c('white', 'red'),  colorkey = FALSE, ylab = NULL, xlab = NULL, scales=list(draw=FALSE), margin = FALSE) + latticeExtra::layer(sp.polygons(ss, fill = "dark grey", col = "transparent"))+ latticeExtra::layer(sp.polygons(mcp, col = "dark grey"))
aprmap <- levelplot(apr2d, col.regions=c('white', 'red'),  colorkey = FALSE, ylab = NULL, xlab = NULL, scales=list(draw=FALSE), margin = FALSE) + latticeExtra::layer(sp.polygons(ss, fill = "dark grey", col = "transparent"))+ latticeExtra::layer(sp.polygons(mcp, col = "dark grey"))
maymap <- levelplot(may2d, col.regions=c('white', 'red'),  colorkey = FALSE, ylab = NULL, xlab = NULL, scales=list(draw=FALSE), margin = FALSE) + latticeExtra::layer(sp.polygons(ss, fill = "dark grey", col = "transparent"))+ latticeExtra::layer(sp.polygons(mcp, col = "dark grey"))
junmap <- levelplot(jun2d, col.regions=c('white', 'red'),  colorkey = FALSE, ylab = NULL, xlab = NULL, scales=list(draw=FALSE), margin = FALSE) + latticeExtra::layer(sp.polygons(ss, fill = "dark grey", col = "transparent"))+ latticeExtra::layer(sp.polygons(mcp, col = "dark grey"))
julmap <- levelplot(jul2d, col.regions=c('white', 'red'),  colorkey = FALSE, ylab = NULL, xlab = NULL, scales=list(draw=FALSE), margin = FALSE) + latticeExtra::layer(sp.polygons(ss, fill = "dark grey", col = "transparent"))+ latticeExtra::layer(sp.polygons(mcp, col = "dark grey"))
augmap <- levelplot(aug2d, col.regions=c('white', 'red'),  colorkey = FALSE, ylab = NULL, xlab = NULL, scales=list(draw=FALSE), margin = FALSE) + latticeExtra::layer(sp.polygons(ss, fill = "dark grey", col = "transparent"))+ latticeExtra::layer(sp.polygons(mcp, col = "dark grey"))
sepmap <- levelplot(sep2d, col.regions=c('white', 'red'),  colorkey = FALSE, ylab = NULL, xlab = NULL, scales=list(draw=FALSE), margin = FALSE) + latticeExtra::layer(sp.polygons(ss, fill = "dark grey", col = "transparent"))+ latticeExtra::layer(sp.polygons(mcp, col = "dark grey"))
octmap <- levelplot(oct2d, col.regions=c('white', 'red'),  colorkey = FALSE, ylab = NULL, xlab = NULL, scales=list(draw=FALSE), margin = FALSE) + latticeExtra::layer(sp.polygons(ss, fill = "dark grey", col = "transparent"))+ latticeExtra::layer(sp.polygons(mcp, col = "dark grey"))
novmap <- levelplot(nov2d, col.regions=c('white', 'red'),  colorkey = FALSE, ylab = NULL, xlab = NULL, scales=list(draw=FALSE), margin = FALSE) + latticeExtra::layer(sp.polygons(ss, fill = "dark grey", col = "transparent"))+ latticeExtra::layer(sp.polygons(mcp, col = "dark grey"))
decmap <- levelplot(dec2d, col.regions=c('white', 'red'),  colorkey = FALSE, ylab = NULL, xlab = NULL, scales=list(draw=FALSE), margin = FALSE) + latticeExtra::layer(sp.polygons(ss, fill = "dark grey", col = "transparent"))+ latticeExtra::layer(sp.polygons(mcp, col = "dark grey"))


legend <- get_legend(pd +  guides(color = guide_legend(nrow = 1)) + theme(legend.position = "bottom"))

p <- plot_grid(pm, pa, pma, pj, pju, pau, ps, po, pn, pd, ncol = 5, legend)
png("../output/maxent/paper_plots/jointtest.png", height = 1024, width = 2048) #, bg = "transparent"
p
dev.off()
```

#table for tss scores etc

forget it... quickly done in excel

```{r}
library(qwraps2)

dec <- read.csv("../output/maxent/models/decavgAIC.csv", header = TRUE)

our_summary1 <- list("Training AUC" = list("min" = ~ min(.data$train_AUC),
            "max" = ~ max(.data$train_AUC),
            "mean (sd)" = ~ qwraps2::mean_sd(.data$train_AUC)),
       "Test AUC" =
       list("min" = ~ min(.data$test_AUC),
            "median" = ~ median(.data$test_AUC),
            "max" = ~ max(.data$test_AUC),
            "mean (sd)" = ~ qwraps2::mean_sd(.data$test_AUC))
       )


whole <-  summary_table(dec, our_summary1)
whole


dec <- read.csv("../output/maxent/models/decavgAIC.csv", header = TRUE)
summary(dec)
```

#no cells >0.5 per month

```{r}

binaryprob_list <- list.files("../output/maxent/paper_plots/hotspot_mapping/", pattern = ".*_bin_0.5_2d.asc", full.names = TRUE)
sum2d <- setNames(data.frame(matrix(ncol = 2, nrow = binl)), c("month", "count"))


for (r in 1:length(binaryprob_list)){
  ras <- raster(binaryprob_list[r])
  rnm <- names(ras)
  sum2d$month[r] <- gsub("_bin_0.5_2d", "", x = rnm)
  sum2d$count[r] <- cellStats(ras, sum, asSample = TRUE)
}

#order table from march to december
mthord <- c("mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")
sum2d <- sum2d[match(mthord, sum2d$month), ]

#get proportion
tcs <- read.csv("../output/maxent/paper_plots/prob_by_depth/cellsperlayer.csv", header = TRUE) #file showing how many cells per depth
tcs <- tcs[-c(1:3), ] #because the top three rows are deeper than the capelin obs...
totc <- sum(tcs$no_cells)

for (r in 1:nrow(sum2d)){
  sum2d$proportion[r] <- (sum2d$count[r]/totc)
}

write.csv(sum2d, "../output/maxent/paper_plots/cell_count_0.5.csv", row.names = FALSE)

```

# map with nafo zons and mcp 

```{r}
library(ggplot2)
library(raster)


outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis - aea proj
nafo <- shapefile("../data/bio/nafo_zones/nafo_zones_wgs84.shp") #in wgs proj
aea <- raster("../output/env/aea.tif") #the correct projections
nafoa <- spTransform(nafo, crs(aea)) # nafo to aea
labels <- layer(sp.text(coo))
land <- shapefile("../data/env/landp/landpro.shp") #made in arcgis - aea proj

nafoaf <- fortify(nafoa, regions = "ZONE")

ggplot(nafoa) + aes() + geom_polygon()

```


#env plots - variable over depth by month

```{r}
library(ggplot2)
library(reshape2)

presab <- read.csv("../output/bio/presab_nafo_yr.csv", header = TRUE)
background <- subset(presab, occurrence == "0")
background$month <- as.factor(background$month)
background <- subset(background, select = c(month, temp_depth, depth_layer, decimalLongitude, decimalLatitude))
dl <- unique(background$depth_layer)
dl <- sort(dl)
test <- subset(background, month == "3")

ggplot(test, aes(x = temp_depth, y = decimalLatitude)) + geom_point() # aes(color = month, group = month)
plot(background)

```

#amo boxplots?

```{r}
amoraw <- read.csv("../data/env/amon.us.data.csv", header = TRUE) 
colnames(amoraw) <- c("year", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12")
amo <- amoraw[amoraw$year >= 1996, ]
amo <- subset(amo, select = -c(year))
amo2 <- melt(amo, value.name = "value")
amo2$variable <- as.integer(amo2$variable)





boxplot(amo2$value ~ amo2$variable)

```




# binned prob maps with land etc for cmeet


```{r bin probabilities greater than}
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis
mthord <- c("jun") #"mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", 

for (m in 1:length(mthord)){
  mth <- mthord[m]
  clogasc_list <- list.files(paste0("../output/maxent/predictions/", mth), pattern = "^avg_cloglog.*.asc", full.names = TRUE)


binprob <- function(x){
  ifelse(x > 0.1, 0.1,
  ifelse(x <= 0, 0, NA))
}

for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_1_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_1_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}



binprob <- function(x){
  ifelse(x >= 0.2, 0.2,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_2_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_2_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}

binprob <- function(x){
  ifelse(x >= 0.3, 0.3,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
 writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_3_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_3_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}


binprob <- function(x){
  ifelse(x >= 0.4, 0.4,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_4_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_4_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}



binprob <- function(x){
  ifelse(x >= 0.5, 0.5,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_5_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_5_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}
 

binprob <- function(x){
  ifelse(x >= 0.6, 0.6,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_6_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_6_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
} 



binprob <- function(x){
  ifelse(x >= 0.7, 0.7,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_7_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_7_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}


binprob <- function(x){
  ifelse(x >= 0.8, 0.8,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_8_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_8_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}


binprob <- function(x){
  ifelse(x >= 0.9, 0.9,
  ifelse(x <= 0, 0, NA))
}



for (cum in 1:length(clogasc_list)){
  cumasc <- raster(clogasc_list[cum])
  ascname <- names(cumasc)
  cumasc <- mask(cumasc, outsidemcp, inverse = TRUE)
  probbin <- calc(cumasc, fun = binprob) #creates raster layer with cell values based on the binprob function
  writeRaster(probbin, paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_9_avgprob_", ascname, ".asc"), overwrite = TRUE)
  plot(probbin, png(paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mth, "_binned_9_avgprob_", ascname, ".png")), overwrite = TRUE)
  dev.off() # stops automatic saving of the plot to a png
}

}

```

```{r}
library(raster)
library(rasterVis)



s <- shapefile("../data/env/landp/landpro.shp") #made in arcgis
aea <- raster("../output/env/aea.tif") 
acrs <- aea@crs
mcp <- shapefile("../output/bio/minimum_convex_poly/mcp_capelin_100_poly.shp")
ss <- raster::intersect(s, mcp)  #trim to mcp

binlst <- list.files("../output/maxent/paper_plots/prob_by_depth", pattern = "^comm_jun_binned.*avgprob_avg_cloglog_97.0413.asc", full.names = TRUE)
#binlst <- binlst[-2]



mstack <- stack()

for(m in 1:length(binlst)){
  map <- raster(binlst[m])
  map <- raster::mask(map, mcp)
  map@crs <- acrs
  mn <- names(map)
  
  # map <- ratify(map)
  # rat <- levels(map)[[1]]
  # rat$suitability <- c("val")
  # levels(map) <- rat
  png(paste0("../output/maxent/paper_plots/prob_by_depth/comm_", mn, ".png")) #this prints a png of the plot
  p <- levelplot(map, ylab = NULL, xlab = NULL, scales=list(draw=FALSE), margin = FALSE, colorkey = FALSE) + latticeExtra::layer(sp.polygons(ss, fill = "dark grey", col = "transparent"))+ latticeExtra::layer(sp.polygons(mcp, col = "dark grey"))
  print(p)
  dev.off() #this turns off the print command
  mstack <- stack(mstack, map)
}


  
  
#levelplot(mstack, ylab = NULL, xlab = NULL, scales=list(draw=FALSE), layout = c(5, 2), names.attr = c("< 0.1", "0.1 - 0.2", "0.2 - 0.3", "0.3 - 0.4", "0.4 - 0.5", "0.5 - 0.6", "0.6 - 0.7", "07 - 0.8", "0.8 - 0.9"), margin = FALSE) + latticeExtra::layer(sp.polygons(ss, fill = "dark grey", col = "transparent"))+ latticeExtra::layer(sp.polygons(mcp, col = "dark grey"))
#plot(p)


levelplot(map, ylab = NULL, xlab = NULL, scales=list(draw=FALSE), margin = FALSE, colorkey = FALSE) + latticeExtra::layer(sp.polygons(ss, fill = "dark grey", col = "transparent"))+ latticeExtra::layer(sp.polygons(mcp, col = "dark grey"))

  


```

#calculate area encompassed by mcp
       
       
```{r}
cumst1 <- read.csv("../output/maxent/paper_plots/prob_by_depth/cellsperlayer.csv", header = TRUE) #existing file created
cumst1 <- cumst1[!cumst1$depth == "1387.38", ] #depth not needed
cumst1 <- cumst1[!cumst1$depth == "1265.86", ] #depth not needed
cumst1 <- cumst1[!cumst1$depth == "1151.99", ] #depth not needed

totalcell <- sum(cumst1$no_cells) #136467
totalcellkm <- totalcell*25 #3,461,675 km2 ?!
```

#boxplots of env variables - part 2

```{r}
library(ggplot2)
library(gridExtra)
presab <- read.csv("../output/bio/presab_nafo_yr.csv", header = TRUE)
background <- subset(presab, occurrence == "0")

background$month <- factor(background$month) # converts month to a categorical variable

```

```{r}
box_temp <- ggplot(data = background, aes(x = month, y = temp_depth)) + geom_boxplot() + xlab("Month") + ylab("Temperature (Kelvin)") + theme_classic()

box_chl <- ggplot(data = background, aes(x = month, y = chl_surface)) + geom_boxplot() + xlab("Month") + ylab("Chlorophyll Concentration (mmol.m-3)") + theme_classic()

box_o2 <- ggplot(data = background, aes(x = month, y = o2_depth)) + geom_boxplot() + xlab("Month") + ylab("Dissolved Oxygen (mmol.m-3)") + theme_classic()

box_sal <- ggplot(data = background, aes(x = month, y = salinity_depth)) + geom_boxplot() + xlab("Month") + ylab("Salinity Concentration (PSU)") + theme_classic()

box_naos <- ggplot(data = background, aes(x = month, y = nao_sample)) + geom_boxplot() + xlab("Month") + ylab("NAO (Sampling Month)") + theme_classic()

box_amos <- ggplot(data = background, aes(x = month, y = amo_sample)) + geom_boxplot() + xlab("Month") + ylab("AMO (Sampling Month)") + theme_classic()

box_naop <- ggplot(data = background, aes(x = month, y = nao_prev)) + geom_boxplot() + xlab("Month") + ylab("NAO (Previous Month)") + theme_classic()

box_naow <- ggplot(data = background, aes(x = month, y = nao_winter)) + geom_boxplot() + xlab("Month") + ylab("NAO (Winter)") + theme_classic()

box_amow <- ggplot(data = background, aes(x = month, y = amo_winter)) + geom_boxplot() + xlab("Month") + ylab("AMO (Winter)") + theme_classic()


box_all <- grid.arrange(box_chl, box_o2, box_sal, box_temp, ncol=2)
ggsave("../output/maxent/paper_plots/env_boxplots.png", plot = box_all, device = png(), dpi = 400)

box_osc <- grid.arrange(box_naos, box_amos, box_naow, box_amow, box_naop, ncol = 2)
ggsave("../output/maxent/paper_plots/env_boxplots_osc.png", plot = box_osc, device = png(), dpi = 400)

```


#make map with mcp eez and all landmass


```{r}
library(ggplot2)
library(raster)
library(rasterVis)

mcp <- shapefile("../output/bio/minimum_convex_poly/mcp_capelin_100_poly.shp")
aea <- raster("../output/env/aea.tif") #the correct projections
land <- shapefile("../data/env/landp/landpro.shp") #made in arcgis - aea proj
eez <- shapefile("../data/env/eez/maybethere.shp") # made in arc - aea proj

eezmap <- plot(mcp)
plot(eez, add = TRUE)
plot(land, add = TRUE)
```

#get median of env. data background points

```{r}
library(psych)

#presab <- read.csv("../output/bio/presab_nafo_yr.csv", header = TRUE)
#background <- subset(presab, occurrence == "0")

temp_depth <- describeBy(background$temp_depth, background$month, mat = TRUE, digits = 2)
temp_depth <- subset(temp_depth, select = c(group1, min, max, mean, median, range))
names(temp_depth)[names(temp_depth)=="group1"] <- "month"
write.csv(temp_depth, "../output/env/env_sumstats/temp_depth_background_summarystats_month.csv", row.names = FALSE)

salinity_depth <- describeBy(background$salinity_depth, background$month, mat = TRUE, digits = 2)
salinity_depth <- subset(salinity_depth, select = c(group1, min, max, mean, median, range))
names(salinity_depth)[names(salinity_depth)=="group1"] <- "month"
write.csv(salinity_depth, "../output/env/env_sumstats/salinity_depth_background_summarystats_month.csv", row.names = FALSE)

o2_depth <- describeBy(background$o2_depth, background$month, mat = TRUE, digits = 2)
o2_depth <- subset(o2_depth, select = c(group1, min, max, mean, median, range))
names(o2_depth)[names(o2_depth)=="group1"] <- "month"
write.csv(o2_depth, "../output/env/env_sumstats/o2_depth_background_summarystats_month.csv", row.names = FALSE)

chl_surface <- describeBy(background$chl_surface, background$month, mat = TRUE, digits = 2)
chl_surface <- subset(chl_surface, select = c(group1, min, max, mean, median, range))
names(chl_surface)[names(chl_surface)=="group1"] <- "month"
write.csv(chl_surface, "../output/env/env_sumstats/chl_surface_background_summarystats_month.csv", row.names = FALSE)

amo_sample <- describeBy(background$amo_sample, background$month, mat = TRUE, digits = 2)
amo_sample <- subset(amo_sample, select = c(group1, min, max, mean, median, range))
names(amo_sample)[names(amo_sample)=="group1"] <- "month"
write.csv(amo_sample, "../output/env/env_sumstats/amo_sample_background_summarystats_month.csv", row.names = FALSE)

amo_winter <- describeBy(background$amo_winter, background$month, mat = TRUE, digits = 2)
amo_winter <- subset(amo_winter, select = c(group1, min, max, mean, median, range))
names(amo_winter)[names(amo_winter)=="group1"] <- "month"
write.csv(amo_winter, "../output/env/env_sumstats/amo_winter_background_summarystats_month.csv", row.names = FALSE)

nao_sample <- describeBy(background$nao_sample, background$month, mat = TRUE, digits = 2)
nao_sample <- subset(nao_sample, select = c(group1, min, max, mean, median, range))
names(nao_sample)[names(nao_sample)=="group1"] <- "month"
write.csv(nao_sample, "../output/env/env_sumstats/nao_sample_background_summarystats_month.csv", row.names = FALSE)

nao_prev <- describeBy(background$nao_prev, background$month, mat = TRUE, digits = 2)
nao_prev <- subset(nao_prev, select = c(group1, min, max, mean, median, range))
names(nao_prev)[names(nao_prev)=="group1"] <- "month"
write.csv(nao_prev, "../output/env/env_sumstats/nao_prev_background_summarystats_month.csv", row.names = FALSE)

nao_winter <- describeBy(background$nao_winter, background$month, mat = TRUE, digits = 2)
nao_winter <- subset(nao_winter, select = c(group1, min, max, mean, median, range))
names(nao_winter)[names(nao_winter)=="group1"] <- "month"
write.csv(nao_winter, "../output/env/env_sumstats/nao_winter_background_summarystats_month.csv", row.names = FALSE)

```

```{r}
backaug <- subset(background, month == "8")
backj <- subset(background, month == "7")
backa <- subset(background, month = "4")
```



#file renaming for the merge and split .csv files

Need csv file of depth and depthlayerno (depth_bin.csv in data/env)

Str sub to split filename
	- Year month variable
	- Depth

clogasc_list <- list.files(paste0("../output/maxent/predictions/", mthna), pattern = "^cloglog_.*.asc", full.names = TRUE)


Then use a loop 

for I in length(csv)
Csv_dep == str_sub

For j in length(list)
	Dirdep ==
	If csv == dirdep
	Xx <- list[j]
	Yy <- Str_sub Year month variable
	Layerno <- 
	
	File.rename(xx, paste0(YY, "_", layerno, ".asc")
	
	
	    filedep <- str_sub(filen, start = 1, end = 11)



```{r}

depthlst <- read.csv("../data/env/depth_bin.csv", header = TRUE)
asclst <- list.files("../data/test/ASCII", full.names = FALSE)

for (d in 1:length(depthlst)){
  csvdep <- depthlst$depthlayerno[d]
  for (f in 1:length(asclst)){
    filen <- asclst[3]
    filedep <- str_sub(filen, start = 16, end = -5)
    if csvdep == filedep{
      
    }
    
  }
}
```


#editing the prediction layers for combined

need to check for year and month

test with march
  if (yr == "2003"){
    betaval <- 1
  } else if (yr == "1999" | yr == "2002" | yr == "2008" | yr == "2009") {
    betaval <- 1.25
  } else if (yr == "2005" | yr == "2006"){
    betaval <- 1.5
  } else if (yr == "2000"){
    betaval <- 1.75
  } else if (yr == "2001" | yr == "2007"){
    betaval <- 2.25
  } else if (yr == "2010"){
    betaval <- 3.5
  }
  
  
```{r pre-install & load packages, include=FALSE}
options(java.parameters = "-Xmx2g" )#needs to run before dismo loaded - boosts memory for java to 1g
packages <- c("dismo", "stringr", "rJava", "raster", "ecospat", "bossMaps", "lattice", "tidyr", "enmSdm", "ggplot2", "plyr", "reshape2")
source("../src/ipak.R")
ipak(packages)
```

load the presence-background dataset 
("../output/bio/presab_nafo_yr.csv")

```{r load pres-background dataset}
presback <- read.csv("../output/bio/presab_nafo_yr.csv", header = TRUE)
colnames(presback)
```

this dataset contains a lot of columns you don't need for the maxent models. Remove them here

```{r remove unnecessary columns}
presback <- subset(presback, select = -c(cell_id, id, decimalLatitude, decimalLongitude, datecollected, institutioncode, individualcount, depth, resname, originalscientificname, collectioncode, day, nafo_zone, gear, longitude_meters, latitude_meters, total_cell_obs_xy, total_cell_obs_xyt, bottom_depth, XXtotal_cell_obs_xyzt, temp_celsius_depth, temp_celsius_surface, longitude_meters.1, latitude_meters.1, bottom_depth_glorys, longitude_meters.2, latitude_meters.2, cell_id_3d, total_cell_obs_xyzt, cell_id_xyzt))
colnames(presback)
```

monthly model data selection and prep
For each monthly model, subset the data to the month you want, and the variables you want (Based on spearmans and VIF)

```{r}
marvar <- c("occurrence", "year", "temp_depth", "salinity_depth", "o2_depth", "chl_surface")
aprvar <- c("occurrence", "year", "temp_depth", "salinity_depth", "o2_depth", "chl_surface")
mayvar <- c("occurrence", "year", "temp_depth", "salinity_depth", "o2_depth", "chl_surface")
junvar <- c("occurrence", "year", "temp_depth", "salinity_depth", "o2_depth", "chl_surface")
julvar <- c("occurrence", "year", "temp_depth", "salinity_depth", "o2_depth", "chl_surface")
augvar <- c("occurrence", "year", "temp_depth", "salinity_depth", "o2_depth", "chl_surface")
sepvar <- c("occurrence", "year", "temp_depth", "salinity_depth", "o2_depth", "chl_surface")
octvar <- c("occurrence", "year", "temp_depth", "salinity_depth", "o2_depth", "chl_surface")
novvar <- c("occurrence", "year", "temp_depth", "salinity_depth", "o2_depth", "chl_surface")
decvar <- c("occurrence", "year", "temp_depth", "salinity_depth", "o2_depth", "chl_surface")

mthnavar_lst <- list(mar = marvar, apr = aprvar, may = mayvar, jun = junvar, jul = julvar, aug = augvar, sep = sepvar, oct = octvar, nov = novvar, dec = decvar)
```

select month
```{r month of interest -change}
mthna <- "mar"
mthno <- "3"
```



```{r subsest data by month}
prback <- subset(presback, month == mthno)
prback <- subset(prback, select = mthnavar_lst[[mthna]])
```

now each month contains NAs - lets remove these (maxent principle doesnt allow for missing data - http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.15.5607&rep=rep1&type=pdf)

note will need to reajust background points too as some years may no longer have presence data

```{r remove na vals}
prback <- na.omit(prback)
presyrs <-  subset(prback, occurrence == 1) #this is to get years with complete presence data 
presyrs <- unique(presyrs$year) #make a vector of unique years
prback <- prback[prback$year %in% presyrs, ] #keep only the data for which there is precence years

```



```{r final models plus predict}
modelmonth <- cbind(paste0(mthna, unique(prback$year)))
aicetc <- read.csv("../data/env/AICcFinalmod.csv", header = TRUE) #pre-created csv file
unlayer <- read.csv(paste0("../data/env/test-comb/asc_layerlist", mthna, ".csv"), header = TRUE) #if code doesnt work put back to unlayer_yr



for (year in 1:nrow(modelmonth)){
  timeslice <- modelmonth[year] #testing timeslice
  yr <- str_sub(timeslice, -4) #the year being used for testing
  train <- subset(prback, year != yr) #training data is all years but testing
  trainpa <- train$occurrence #creates a vector of presence/background ID (1/0)
  test <-  subset(prback, year == yr) #creates the testing dataset
  testp <- subset(test, occurrence == "1") #splits the testing dataset into presences
  testp <- subset(testp, select = -c(year, occurrence)) #don't need year and occurrence for modelling
  testb <- subset(test, occurrence == "0") #splits the testing dataset into background
  testb <- subset(testb, select = -c(year, occurrence)) #don't need year and occurrence for modelling
  #mess_pr <- subset(train, occurrence == 1)
  #mess_pr  <- subset(train, select = -c(year, occurrence)) #don't need year and occurrence for modelling
  train  <- subset(train, select = -c(year, occurrence)) #don't need year and occurrence for modelling

  
  if (yr == "2003"){
    betaval <- 1
  } else if (yr == "1999" | yr == "2002" | yr == "2008" | yr == "2009") {
    betaval <- 1.25
  } else if (yr == "2005" | yr == "2006"){
    betaval <- 1.5
  } else if (yr == "2000"){
    betaval <- 1.75
  } else if (yr == "2001" | yr == "2007"){
    betaval <- 2.25
  } else if (yr == "2010"){
    betaval <- 3.5
  }

  
  
    mod <- maxent(x = train, p = trainpa, path = paste0("../output/maxent/models/test-comb/", timeslice), args=c("writebackgroundpredictions=TRUE",  "maximumiterations=5000", "responsecurves=TRUE", "jackknife=TRUE", "threads=8", "addsamplestobackground=TRUE", paste0("betamultiplier=", betaval)))
    
    saveRDS(mod, file= paste0("../output/maxent/models/test-comb/", timeslice, "/", timeslice, ".rda"))


    #now based on glover-kapfer pdf with excel manual + https://esajournals.onlinelibrary.wiley.com/doi/full/10.1890/10-1171.1... + adaptation for        getting testAUC.. horrible code

    #count number of non-zero coefficients, excluding the final four rows
    coefile <- read.csv(paste0("../output/maxent/models/", timeslice, "/species.lambdas"), header = FALSE, stringsAsFactors=FALSE)
    coefile <- head(coefile, -4)
    coefile2 <- subset(coefile, V2 > 0 | V2 < 0)
    nocoeff <- nrow(coefile2)
    bick <- sum(as.numeric(coefile2[, 2]))
    bic <- (bick*log(sum(trainpa == 1)) - 2*11)
    
    #no presences used in model (less those used for testing)
    maxresults <- read.csv(paste0("../output/maxent/models/", timeslice, "/maxentResults.csv"), header = TRUE)
    notrainingpoints <- maxresults$X.Training.samples
    testauc <- maxresults$Test.AUC
    trainauc <- maxresults$Training.AUC
    
    #natural log
    samplepred <- read.csv(paste0("../output/maxent/models/", timeslice, "/species_samplePredictions.csv"), header = TRUE)
    samplepred$nat_log <- log(samplepred$Raw.prediction)
    sumsamplepred <- sum(samplepred$nat_log)
  
  
    #test auc scores and other lovely things you might want to include
    ev <- evaluate(p = testp, a= testb, model = mod)
    evauc <- ev@auc
    evcor <- ev@cor
    evpcor <- ev@pcor
    evnp <- ev@np
    evna <- ev@na
    evmaxtprtnr <- threshold(ev, 'spec_sens')
    evmaxkap <- threshold(ev, 'kappa')
    evno_omission <- threshold(ev, 'no_omission')
    evprevalence <- threshold(ev, 'prevalence')
    evequal_sens_spec <- threshold(ev, 'equal_sens_spec')
    evsensitivity <- threshold(ev, 'sensitivity')
    
    #continuous boyce index
    predPres <- read.csv(paste0("../output/maxent/models/", timeslice, "/species_samplePredictions.csv"), header = TRUE)
    predBg <- read.csv(paste0("../output/maxent/models/", timeslice, "/species_backgroundPredictions.csv"), header = TRUE)
    predPres <- predPres$Cloglog.prediction
    predBg <- predBg$Cloglog
    source("../src/contBoyce.R")
    cbi <- contBoyce(pres = predPres, bg = predBg)
    
  
      aicetc$train_AUC <- trainauc #training only AUC - not tested
      aicetc$no_trainng_points <- notrainingpoints #numberof points used for training
      aicetc$coefficients <- nocoeff #this is to calculate the AIC
      aicetc$sum.of.logs <- sumsamplepred #this is to calculate the AIC
      aicetc$test_AUC <- evauc #testing AUC
      aicetc$test_evcor <- evcor #testing correlation coefficient
      aicetc$test_evpcor <- evpcor # testing p-value for correlation coefficient
      aicetc$test_nopresence <- evnp 
      aicetc$test_nobackground <- evna
      aicetc$test_maxsumsenspec <- evmaxtprtnr
      aicetc$test_maxkap <- evmaxkap
      aicetc$test_no_omission <- evno_omission
      aicetc$test_prevalence <- evprevalence
      aicetc$test_equal_sens_spec <- evequal_sens_spec
      aicetc$test_sensitivity <- evsensitivity
      aicetc$tss <- max(ev@TPR + ev@TNR) - 1
      aicetc$test_bic <- bic #not sure this is correct...
      aicetc$beta <- betaval
      aicetc$cbi <- cbi
      
    aicetc$AIC <- ((2*aicetc$coefficients)-(2*aicetc$sum.of.logs))
    aicetc$AICc <- (-2*(aicetc$sum.of.logs)+((2*aicetc$coefficients)*(aicetc$no_trainng_points/(aicetc$no_trainng_points - aicetc$coefficients-1))))
    
    #calculate minimal predicted area using ecospat
    aicetc$mpa_0.9_cum <- ecospat.mpa(samplepred$Cumulative.prediction, perc = 0.9) #90%
    aicetc$mpa_0.9_clog <- ecospat.mpa(samplepred$Cloglog.prediction, perc = 0.9) #90%
    aicetc$year <- yr


    write.csv(aicetc, paste0("../output/maxent/models/test-comb/", timeslice, "/AICforMaxentReg.csv"), row.names = FALSE)
    
    mod <- readRDS(paste0("../output/maxent/models/test-comb/", timeslice, "/", timeslice, ".rda"))


    yr <- as.numeric(yr)
 unlayer_yr <- subset(unlayer, ascyears == yr)
    #unlayer_yr <- unlayer_yr[-c(1), ]
    unlayer_yr[] <- lapply(unlayer_yr, as.character) #from https://stackoverflow.com/questions/2851015/convert-data-frame-columns-from-factors-to-characters
    stackdeplst <- list()
    stackdep <- subset(unlayer_yr, select = c(stackname))
    stackdeplst[[year]] <- stackdep
    write.csv(stackdep, paste0("../output/maxent/models/test-comb/", timeslice, "/stackdepthlist_", yr, ".csv"), row.names = FALSE)
    aea <- raster("../output/env/aea.tif") 

    
  for (td in 1:nrow(unlayer_yr)){
      temp_depth <- raster(unlayer_yr$temp_depth[td])
      crs(temp_depth) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" 
      names(temp_depth) <- "temp_depth"
      #temp_depth <- projectRaster(temp_depth, aea)
      chl_surface <- raster(unlayer_yr$chl_depth[td])
      crs(chl_surface) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" 
      names(chl_surface) <- "chl_surface"
      #chl_depth <- projectRaster(chl_depth, aea)
      o2_depth <- raster(unlayer_yr$o2_depth[td])
      crs(o2_depth) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" 
      names(o2_depth) <- "o2_depth"
      #o2_depth <- projectRaster(o2_depth, aea)
      salinity_depth <- raster(unlayer_yr$salinity_depth[td])
      crs(salinity_depth) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" 
      names(salinity_depth) <- "salinity_depth"
      #salinity_depth <- projectRaster(salinity_depth, aea)
      # nao_sample <- raster(unlayer_yr$nao_sample[td])
      # crs(nao_sample) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" 
      # names(nao_sample) <- "nao_sample"
      # nao_sample <- projectRaster(nao_sample, aea)
      # nao_prev <- raster(unlayer_yr$nao_prev[td])
      # crs(nao_prev) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" 
      # names(nao_prev) <- "nao_prev"
      # nao_prev <- projectRaster(nao_prev, aea)
      # nao_winter <- raster(unlayer_yr$nao_winter[td])
      # crs(nao_winter) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
      # names(nao_winter) <- "nao_winter"
      # nao_winter <- projectRaster(nao_winter, aea)
      # amo_sample <- raster(unlayer_yr$amo_sample[td])
      # crs(amo_sample) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" 
      # names(amo_sample) <- "amo_sample"
      # amo_sample <- projectRaster(amo_sample, aea)
      # amo_winter <- raster(unlayer_yr$amo_winter[td])
      # crs(amo_winter) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
      # names(amo_winter) <- "amo_winter"
      # amo_winter <- projectRaster(amo_winter, aea)
      stackn <- unlayer_yr$stackname[td]
      stack <- stack(temp_depth, salinity_depth, o2_depth, chl_surface)


      #stackSave(test,unlayer_yr$stackname[td])
      pred <- predict(mod, stack, file = paste0("../output/maxent/predictions/test-comb/", mthna, "/", "cloglog_", stackn, ".asc"), overwrite=TRUE, args=c('outputformat=cloglog')) 
      # predraw <- predict(mod, stack, file = paste0("../output/maxent/predictions/test-comb/", mthna, "/", "raw_", stackn, ".asc"), overwrite=TRUE, args=c('outputformat=raw')) 
      prplot <- plot(pred, png(paste0("../output/maxent/predictions/test-comb/", mthna, "/", "cloglog_", stackn, ".png")))
      dev.off() # stops automatic saving of the plot to a png
}
```






need to convert ascii wgs to aea (no maybe not..)
```{r}
testr <- raster("../data/env/ascii-original/ascii2000/2000_01_chl.nc_3.85628.asc")
crs(testr) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" 
names(testr) <- "testr"
testr <- projectRaster(testr, aea)
writeRaster(testr, "../data/env/test-comb/test.asc", format = 'ascii')

test2 <- raster("../data/env/test-comb/test.asc")
plot(test2)
test2
```

set up a loop to go through all directories, take files in each directory, project, then put in a new folder

```{r}
#list directories with the ascii files that need converting in
asciidirs <- list.dirs("../data/env/ascii-original/", full.names = TRUE, recursive = TRUE)
asciidirs <- asciidirs[-1] #to remove the top directory
aea <- raster("../output/env/aea.tif")


for (dir in 1:length(asciidirs)){ #go through each directory
  ascilst <- list.files(asciidirs[dir], full.names = TRUE, pattern = "\\.asc$") #make a list of files in the directory
  dirn <- asciidirs[dir]
  dirn <- substring(dirn, 29)
  for (as in 1:length(ascilst)){ #for each file in the directory
    ras <- raster(ascilst[as])
    crs(ras) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" 
    rasp <- projectRaster(ras, aea)
    rnm <- names(ras)
    rnm <- substring(rnm, 2)
    writeRaster(rasp, paste0("../data/env/ascii-aea/", dirn, "/", rnm, ".asc"), format = 'ascii')
    }
}

```





# mcp shape needs to be in wgs...

```{r}
outsidemcp <- shapefile("../data/env/landp/mcpout.shp") #made in arcgis - in aea
wgsraster <- raster("../output/maxent/predictions/com-split/apr/cloglog_1998_04_0.50576.asc") #just chosen randomly to act as dummy file
crs(wgsraster) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 "
outsidemcp <- spTransform(outsidemcp, crs(wgsraster))

```


#need to reclassify cells outside the mcp to NA for predictions
```{r}
outsidemcp <- shapefile("../data/env/landp/outside-mcp-wgs84.shp") #made in arcgis - in aea

ascdirs <- list.dirs("../data/env/ascii-original", full.names = FALSE, recursive = FALSE) 

for (ad in 1:length(ascdirs)){
  timeslice <- ascdirs[ad]
  ascfiles <- list.files(paste0("../data/env/ascii-original/", timeslice), pattern = "\\.asc$", full.names = TRUE)
  for (file in 1:length(ascfiles)){
    ras<- raster(ascfiles[file])
    crs(ras) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 "
    ascname <- str_sub(ascfiles[file], start = 38)
    ras[outsidemcp] <- 500000
    ras[ras == 500000] <- NA
    writeRaster(ras, paste0("../data/env/asciitrim/", ascdirs[ad], "/", ascname), overwrite=TRUE)
  }
}



```



test <- raster("../output/maxent/predictions/com-split/apr/cloglog_1998_04_0.50576.asc") #just chosen randomly to act as dummy file
crs(test) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 "

test[outsidemcp] <- 500000
test[test == 500000] <- NA
plot(test)




#if need to predict from the model...

```{r}

#monthlist <- c("mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec") # a list of months to order by

modlist <- list.dirs("../output/maxent/models/test-comb", full.names = FALSE, recursive = FALSE) 
#modlist <- modlist[ grepl(mthna, modlist) ]

for (mth in 1:length(modlist)){
    mthna <- str_sub(modlist[mth], end = 3)
    yr <- str_sub(modlist[mth], start = 4)
    timeslice <- modlist[mth]
    mod <- readRDS(paste0("../output/maxent/models/test-comb/", timeslice, "/", timeslice, ".rda"))
    unlayer <- read.csv(paste0("../data/env/test-comb/asc_layerlist", mthna, ".csv"), header = TRUE) #if code doesnt work put back to unlayer_yr

    unlayer_yr <- subset(unlayer, ascyearslist == yr)
    #unlayer_yr <- unlayer_yr[-c(1), ]
    unlayer_yr[] <- lapply(unlayer_yr, as.character) #from https://stackoverflow.com/questions/2851015/convert-data-frame-columns-from-factors-to-characters
    stackdeplst <- list()
    stackdep <- subset(unlayer_yr, select = c(stackname))
    stackdeplst[[yr]] <- stackdep
    write.csv(stackdep, paste0("../output/maxent/models/test-comb/", timeslice, "/stackdepthlist_", yr, ".csv"), row.names = FALSE)
    
    for (td in 1:nrow(unlayer_yr)){
        temp_depth <- raster(unlayer_yr$temp_depth[td])
        crs(temp_depth) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" 
        names(temp_depth) <- "temp_depth"
        #temp_depth <- projectRaster(temp_depth, aea)
        chl_surface <- raster(unlayer_yr$chl_surface[td])
        crs(chl_surface) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" 
        names(chl_surface) <- "chl_surface"
        #chl_depth <- projectRaster(chl_depth, aea)
        o2_depth <- raster(unlayer_yr$o2_depth[td])
        crs(o2_depth) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" 
        names(o2_depth) <- "o2_depth"
        #o2_depth <- projectRaster(o2_depth, aea)
        salinity_depth <- raster(unlayer_yr$salinity_depth[td])
        crs(salinity_depth) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" 
        names(salinity_depth) <- "salinity_depth"
        #salinity_depth <- projectRaster(salinity_depth, aea)
        nao_sample <- raster(unlayer_yr$nao_sample[td])
        crs(nao_sample) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" 
        names(nao_sample) <- "nao_sample"
        #nao_sample <- projectRaster(nao_sample, aea)
        nao_prev <- raster(unlayer_yr$nao_prev[td])
        crs(nao_prev) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" 
        names(nao_prev) <- "nao_prev"
        #nao_prev <- projectRaster(nao_prev, aea)
        nao_winter <- raster(unlayer_yr$nao_winter[td])
        crs(nao_winter) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
        names(nao_winter) <- "nao_winter"
        #nao_winter <- projectRaster(nao_winter, aea)
        amo_sample <- raster(unlayer_yr$amo_sample[td])
        crs(amo_sample) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" 
        names(amo_sample) <- "amo_sample"
        #amo_sample <- projectRaster(amo_sample, aea)
        amo_winter <- raster(unlayer_yr$amo_winter[td])
        crs(amo_winter) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
        names(amo_winter) <- "amo_winter"
        #amo_winter <- projectRaster(amo_winter, aea)
        stackn <- unlayer_yr$stackname[td]
        stack <- stack(temp_depth, salinity_depth, o2_depth, chl_surface, nao_sample, nao_prev, nao_winter, amo_sample, amo_winter)
  
  
        #stackSave(test,unlayer_yr$stackname[td])
        pred <- predict(mod, stack, file = paste0("../output/maxent/predictions/test-comb/", mthna, "/", "cloglog_", stackn, ".asc"), overwrite=TRUE, args=c('outputformat=cloglog')) 
        # predraw <- predict(mod, stack, file = paste0("../output/maxent/predictions/test-comb/", mthna, "/", "raw_", stackn, ".asc"), overwrite=TRUE, args=c('outputformat=raw')) 
        prplot <- plot(pred, png(paste0("../output/maxent/predictions/test-comb/", mthna, "/", "cloglog_", stackn, ".png")))
        dev.off() # stops automatic saving of the plot to a png
    }
}
```

