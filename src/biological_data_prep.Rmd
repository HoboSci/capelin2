---
title: "biological data preperation"
author: "Samantha Andrews"
output: html_notebook
---

# Overview
Preperation of the capelin (*Mallotus villosus*) data obtained from [OBIS](www.iobis.org). This database shows the global occurance of capelin. 

A note to anyone who might happen to stumble across this... I am a beginner in R and have had no exposure to similar languages. I don't know what I'm doing. The code herein is unlikely to be elegant and there are probably more efficient ways of running the code.

Built with 'r getRversion()'.

# Package dependencies
You can load them using the following code which uses a function called [ipak](https://gist.github.com/stevenworthington/3178163). 
Note this function checks to see if the packages are installed first.
Th
```{r pre-install packages, message=FALSE}
packages <- c("packrat", "rworldmap", "dplyr","plyr", "rgdal", "sp", "raster", "tibble", "useful", "marmap")
source("../src/ipak.R")
ipak(packages)
suppressMessages(ipak)
```

# Raw Data Clean
Load the raw data, then check use head() to check it looks ok, then names() to see all the column names
```{r load raw data}
rawdata <- read.csv("../data/bio/capelin_obis_raw.csv")
head(rawdata) 
names(rawdata)
```

following [Darwin Core](http://rs.tdwg.org/dwc/terms/) rename the latitude and longitude columns to decimalLatitude and decimalLongitude respectively
```{r dawin core naming convention}
tidydata <- rawdata
names(tidydata)[names(tidydata)=="latitude"] <- "decimalLatitude"
names(tidydata)[names(tidydata)=="longitude"] <- "decimalLongitude"
head(tidydata)
```

The dataset is global and needs to be trimmed to contain just the area of interest. 
Plot all the occurance points
```{r map all occurrence points}
library(rworldmap)
map <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map, xlim = c(-180, -44), ylim =c(0,80), asp = 1) #the x and y lim are the long-lat bounds of the map
points(tidydata$decimalLongitude, tidydata$decimalLatitude) #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
```
now extract just the Atlantic Canada data.
The lon-lat study area (which captures the whole Atlantic Canadian EEZ up to the north of Resolution Island in the Hudson Strait/ Davis Strait) is -70.0,-43.0,70.0,38.0 
```{r map only atlantic canadian occurrences}
tidydata <- tidydata[tidydata$decimalLongitude > -70, ]
tidydata <- tidydata[tidydata$decimalLongitude < -43, ]
tidydata <- tidydata[tidydata$decimalLatitude > 38, ]
plot(map, xlim = c(-180, -42), ylim =c(0,80), asp = 1) 
points(tidydata$decimalLongitude, tidydata$decimalLatitude)
```
ok looks good...save what you have so far to a .csv
```{r save tidydata to csv}
write.csv(tidydata, file = "../data/bio/capelin_obis_tidy.csv", row.names = FALSE)
```

# Column removal
So there are many columns that you don't need.. you want to keep
id
decimalLatitude
decimalLongitude
datecollected
institutioncode
individualcount
resname
originalscientificname
collectioncode (this contains some info that might help with finding out gear used in the survey)
depth

```{r select colums needed}
tidydata <- subset(tidydata, select = c(id, decimalLatitude, decimalLongitude, datecollected, institutioncode, individualcount, depth, resname, originalscientificname, collectioncode))
head(tidydata)
```

# Month year column creation
make columns for the years and month based on the datecollected column
```{r new yymmdd columns}
tidydata$year <- format(as.Date(tidydata$datecollected), "%Y") #created a new column called year
tidydata$month <- format(as.Date(tidydata$datecollected), "%m") #created a new column called month
tidydata$day <- format(as.Date(tidydata$datecollected), "%d") #created a new column called day 
head(tidydata)
```

the year, month, day columns are characters Change to numeric
```{r new yymmdd columns 2}
tidydata$year <- as.numeric(tidydata$year)
tidydata$month <- as.numeric(tidydata$month)
tidydata$day <- as.numeric(tidydata$day)
head(tidydata)
```

# remove data without month/year info

count NAs in the dataset. Mainly you are interested in the datecollected column (ignore individual count - you know there is a lot missing)
```{r}
missingdata <- apply(tidydata, 2, function (x) sum(is.na(x)))
missingdata
```
hmm interesting - you have 771 columns from year month and day with missing data, but datacollected has 0. There may be a formatting issue.
To take a closer look, subset all rows where year == na

```{r}
missingdatarows <- tidydata[is.na(tidydata$year), ]
head(missingdatarows)
```
so the NAs in the year column relate to no data (without a na value attached). Remove all rows where year == na
```{r}
tidydata <- tidydata[!is.na(tidydata$year), ]
missingdata2 <- apply(tidydata, 2, function (x) sum(is.na(x)))
missingdata2
```


# Remove any duplicate entries
The dplyr package's distinct function removes any duplicate rows (based on all columns EXCEPT id as this is always going to be unique, and year month day as this is generated from datecollected)

```{r}
library("dplyr")
tidydata <- distinct(tidydata, decimalLatitude, decimalLongitude, datecollected, institutioncode, institutioncode, individualcount, resname, originalscientificname, .keep_all = T) #the .keep_all means that id isn't excluded from the output
head(tidydata)
```


# Institutions
Lets take a look at the institutioncode to make sure the names make sense...
```{r}
tidydata$institutioncode <- as.character(tidydata$institutioncode)
whosampled <- unique(tidydata$institutioncode) #makes a variable of institutions
whosampledordered <- sort(whosampled) #just puts the list in 
whosampledordered
```
Ok so a number of these names actually represent the same insitiution (e.g. [DFO Regions](http://www.dfo-mpo.gc.ca/regions/index-eng.htm). Some details [here](ftp://ftp.aoml.noaa.gov/od/pub/library/methods-branton.pdf) and the first is no institution (you might be able to figure it out though). 
The merges needed are as follows
"Bedford Institute of Oceanography (BIO)" & "BIO" & "DFO-SF" == DFOMTMS 
"DFO-IML" & "IML-MLI" & "IML_MLI" & "DFO-NG" == DFOQC 
"DFO-NFLD" & "North Atlantic Fisheries Centre" == "DFONL" 
"NMFS-NEFSC" & "NOAA, NMFS, Northeast Fisheries Science Center" == NEFSC
"The Atlantic reference Centre" & "The Atlantic Reference Centre (ARC)" == ARC 
"DFO-SG" & "DFO Gulf Fisheries Centre" == DFOGULF

and some you can just make shorter
"Northwest Atlantic Fisheries Organization (NAFO)" == NAFO
"DFO-ISDM" == DFOISDM
"Maine DMR" == MaineDMR
```{r consistent institutioncodes}
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "Bedford Institute of Oceanography (BIO)", "DFOMTMS")
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "BIO", "DFOMTMS")
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "DFO-SF", "DFOMTMS")
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "DFO-IML", "DFOQC")
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "IML-MLI", "DFOQC")
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "DFO-NG", "DFOQC")  
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "IML_MLI", "DFOQC")
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "DFO-NFLD", "DFONL")
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "North Atlantic Fisheries Centre", "DFONL")
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "NMFS-NEFSC", "NEFSC")
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "NOAA, NMFS, Northeast Fisheries Science Center", "NEFSC")
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "The Atlantic Reference Centre (ARC)", "ARC")
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "The Atlantic reference Centre", "ARC")
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "DFO-SG", "DFOGulf")
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "DFO Gulf Fisheries Centre", "DFOGulf")
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "Northwest Atlantic Fisheries Organization (NAFO)", "NAFO")
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "DFO-Central and Arctic, Freshwater Institute (FWI)", "DFOCENARC")
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "DFO-ISDM", "DFOISDM")
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "Maine DMR", "MaineDMR")

#recheck
tidydata$institutioncode <- as.character(tidydata$institutioncode)
whosampled <- unique(tidydata$institutioncode) #makes a variable of institutions
whosampledordered <- sort(whosampled) #just puts the list in 
whosampledordered
```

Now look at the missing institution. Use resname to see if it helps...
```{r check missing institutioncode}
missinginst <- subset(tidydata, institutioncode == "")
missinginst
```
ok now check for unique resname...
```{r ID missing institutioncode}
missinginst$resname <- as.character(missinginst$resname)
missinginstunique <- unique(missinginst$resname) #makes a variable of institutions
missinginstuniquedordered <- sort(missinginstunique) #just puts the list in 
missinginstuniquedordered <- as.character(missinginstuniquedordered)
missinginstuniquedordered
```

Ok soo looking at the [OBIS metadata](http://www.iobis.org/explore/#/dataset/4356), the institution is the Conservation of Arctic Flora and Fauna (CAFF)
```{r fix missing institutioncode}
tidydata$institutioncode <- replace(tidydata$institutioncode, tidydata$institutioncode == "", "CAFF")
whosampled <- unique(tidydata$institutioncode) #makes a variable of institutions
whosampledordered <- sort(whosampled) #just puts the list in 
whosampledordered
```

Now lets check the number of records and spatial-temporal distribution of the observations by institution code to make sure none are dodgy

first a table of how many observations each instituioncode has
```{r institution code analysis - count}
library(plyr) #to use the count function
obs_by_ins <- count(tidydata, "institutioncode")
obs_by_ins
write.csv(obs_by_ins, file = "../output/bio/no_observations_institutioncode.csv")
```
ok so IMR, NAFO, ICES, & USM have very few entries (1, 1, 1, and 3 respectively)

Lets take a look at the spatial breakdown of these institutions.First all points...

```{r}
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "All Occurrences", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(tidydata$decimalLongitude, tidydata$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../output/bio/all_occurrences.png") #this prints a png of the plot
dev.off() #this turns off the print command
```
Note there is one point up by iceland that you should get rid of (Icelandic population thought to be seperate from Labrador, but it is unclear if this is true or not).

Map the institutioncode == ARC only data...
```{r map obs by institutuion}
ARC_obs <- tidydata[tidydata$institutioncode == "ARC", ]
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(39, 70), asp = 1, main = "Arc Occurrences", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(ARC_obs$decimalLongitude, ARC_obs$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../output/bio/ARC_occurrences_all.png") #this prints a png of the plot
dev.off() #this turns off the print command

CAFF_obs <- tidydata[tidydata$institutioncode == "CAFF", ]
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(39, 70), asp = 1, main = "CAFF Occurrences",  col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(CAFF_obs$decimalLongitude, CAFF_obs$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../output/bio/CAFF_occurrences_all.png") #this prints a png of the plot
dev.off() #this turns off the print command

DFOCENARC_obs <- tidydata[tidydata$institutioncode == "DFOCENARC", ]
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(39, 70), asp = 1, main = "DFO Central & Arctic Occurrences",  col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(DFOCENARC_obs$decimalLongitude, DFOCENARC_obs$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../output/bio/DFOCENARC_occurrences_all.png") #this prints a png of the plot
dev.off() #this turns off the print command

DFOGulf_obs <- tidydata[tidydata$institutioncode == "DFOGulf", ]
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(39, 70), asp = 1, main = "DFO Gulf Occurrences",  col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(DFOGulf_obs$decimalLongitude, DFOGulf_obs$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../output/bio/DFOGulf_occurrences_all.png") #this prints a png of the plot
dev.off() #this turns off the print command

DFOISDM_obs <- tidydata[tidydata$institutioncode == "DFOISDM", ]
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(39, 70), asp = 1, main = "DFO ISDM Occurrences",  col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(DFOISDM_obs$decimalLongitude, DFOISDM_obs$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../output/bio/DFOISDM_occurrences_all.png") #this prints a png of the plot
dev.off() #this turns off the print command

DFOMTMS_obs <- tidydata[tidydata$institutioncode == "DFOMTMS", ]
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(39, 70), asp = 1, main = "DFO Maritimes Occurrences",  col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(DFOMTMS_obs$decimalLongitude, DFOMTMS_obs$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../output/bio/DFOMTMS_occurrences_all.png") #this prints a png of the plot
dev.off() #this turns off the print command

DFONL_obs <- tidydata[tidydata$institutioncode == "DFONL", ]
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(39, 70), asp = 1, main = "DFO Newfouundland & Labrador Occurrences",  col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(DFONL_obs$decimalLongitude, DFONL_obs$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../output/bio/DFONL_occurrences_all.png") #this prints a png of the plot
dev.off() #this turns off the print command

DFOQC_obs <- tidydata[tidydata$institutioncode == "DFOQC", ]
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(39, 70), asp = 1, main = "DFO Quebec Occurrences",  col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(DFOQC_obs$decimalLongitude, DFOQC_obs$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../output/bio/DFOQC_occurrences_all.png") #this prints a png of the plot
dev.off() #this turns off the print command

ICES_obs <- tidydata[tidydata$institutioncode == "ICES", ]
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(39, 70), asp = 1, main = "ICES Occurrences",  col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(ICES_obs$decimalLongitude, ICES_obs$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../output/bio/ICES_occurrences_all.png") #this prints a png of the plot
dev.off() #this turns off the print command

IMR_obs <- tidydata[tidydata$institutioncode == "IMR", ]
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(39, 70), asp = 1, main = "IMR Occurrences",  col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(IMR_obs$decimalLongitude, IMR_obs$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../output/bio/IMR_occurrences_all.png") #this prints a png of the plot
dev.off() #this turns off the print command

MaineDMR_obs <- tidydata[tidydata$institutioncode == "MaineDMR", ]
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(39, 70), asp = 1, main = "Maine DMR Occurrences",  col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(MaineDMR_obs$decimalLongitude, MaineDMR_obs$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../output/bio/MaineDMR_occurrences_all.png") #this prints a png of the plot
dev.off() #this turns off the print command

NAFO_obs <- tidydata[tidydata$institutioncode == "NAFO", ]
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(39, 70), asp = 1, main = "NAFO Occurrences",  col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(NAFO_obs$decimalLongitude, NAFO_obs$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../output/bio/NAFO_occurrences_all.png") #this prints a png of the plot
dev.off() #this turns off the print command

NEFSC_obs <- tidydata[tidydata$institutioncode == "NEFSC", ]
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(39, 70), asp = 1, main = "NEFSC Occurrences",  col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(NEFSC_obs$decimalLongitude, NEFSC_obs$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../output/bio/NEFSC_occurrences_all.png") #this prints a png of the plot
dev.off() #this turns off the print command

ROM_obs <- tidydata[tidydata$institutioncode == "ROM", ]
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(39, 70), asp = 1, main = "Royal Ontario Museum Occurrences",  col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(ROM_obs$decimalLongitude, ROM_obs$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../output/bio/ROM_occurrences_all.png") #this prints a png of the plot
dev.off() #this turns off the print command

USNM_obs <- tidydata[tidydata$institutioncode == "USNM", ]
map2 <- getMap(resolution = "low") #creates an object called map at low resoultion
plot(map2, xlim = c(-70, -43), ylim =c(39, 70), asp = 1, main = "National Museum of Natural History Occurrences",  col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(USNM_obs$decimalLongitude, USNM_obs$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../output/bio/USNM_occurrences_all.png") #this prints a png of the plot
dev.off() #this turns off the print command
```


Looking at the maps, the ROM, NAFO, IMR, ICES have data next to iceland.
Since NAFO, IMR, and ICES only have one data point each, you can remove these observations easily from the record...
```{r remove iceland data}
tidydata <- tidydata[!tidydata$institutioncode == "NAFO", ]
tidydata <- tidydata[!tidydata$institutioncode == "IMR", ]
tidydata <- tidydata[!tidydata$institutioncode == "ICES", ]
```

Now for  ROM there are more data points...
Use indentify function which lets you click on a point on the plot
```{r locate coordinates of iceland point}
x11() #this opens the plot i a window you can interact with
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "Royal Ontario Museum Occurrences",  col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(ROM_obs$decimalLongitude, ROM_obs$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude"))
identify(ROM_obs$decimalLongitude, ROM_obs$decimalLatitude, labels=ROM_obs$decimalLongitude) #decimalLongitude chosen as plot identifier as the values are unique
```
The point that needs to be removed is located at -44.96667 and -53,483333. Note this is not the full value so use some other locators to remove the row (you could just used id, but pick multiple others just to learn)

```{r remove iceland point}
tidydata <- tidydata[!(tidydata$resname == "Fish specimens" & tidydata$datecollected == "1965-08-13 12:00:00+01"), ]
tidydata <- tidydata[!(tidydata$resname == "Fish specimens" & tidydata$datecollected == "1967-10-25 12:00:00+01"), ]
tidydata <- tidydata[!(tidydata$resname == "Ichthyology Collection - Royal Ontario Museum" & tidydata$datecollected == "1967-10-25 12:00:00+01"), ]
```

now replot all data just to check...

```{r map occurrences less iceland}
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "All Occurrences without Iceland", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(tidydata$decimalLongitude, tidydata$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
dev.copy(png, "../output/bio/all_occurrences_less_iceland.png") #this prints a png of the plot
dev.off() #this turns off the print command
```
great! write what you have so far to a csv
```{r}
write.csv(tidydata, file = "../data/bio/capelin_obis_tidy.csv", row.names = FALSE)
```

# Remove dates you don't have environmental data for
The BIOMER dataset starts in 1998-01 (GLORYS 1993), so cut all occurrences prior to 1998-01

```{r remove occurrences prior to 98/01}
tidydata <- tidydata[tidydata$year >= 1998, ]
```

and write to a csv...
```{r}
write.csv(tidydata, file = "../data/bio/capelin_obis_tidy.csv", row.names = FALSE)
```

# Adding new (non-environmental) data to the file
There are some more columns you want to add...
- Occurrence - presence/background (1/0)
- NAFO region
- Gear type
- Unique Cell ID (based on the environmental data)

so not to mess with tidydata, create a new variable and write a new .csv
```{r create new variable/csv for adding data}
adddata <- tidydata
write.csv(adddata, file = "../data/bio/capelin_additional_tidy.csv", row.names = FALSE)
```

first create a new column for Occurence, and populate with "1" (because these are all presences)
```{r}
adddata$occurrence <- "1"
head(adddata)
```

# Add NAFO Region occurrence is from
NAFO Zones shapefile obtained from [NAFO](https://www.nafo.int/Data/GIS)

```{r NAFO shapefile extraction}
library(rgdal)
library(sp)
coordinates(adddata) <- c("decimalLongitude", "decimalLatitude") 
nafo_zones <- readOGR(dsn=path.expand("../data/bio/nafo_zones"), layer = "nafo_zones_wgs84") #this loads the shapefile
proj4string(adddata) <- proj4string(nafo_zones) #tells R that the occurrence data is the same projection as the shapefile
adddata$nafo_zone <- over(adddata, nafo_zones)$ZONE #ZONE is where the zone data is held in teh shapefiles' attributes
head(adddata) #just to check it worked
```

Great. Lets see if any are missing a NAFO Zone. But first, write to a csv and reload as the data is now some wierd 'spatial points dataframe'...
```{r}
write.csv(adddata, "../data/bio/capelin_additional_tidy.csv", row.names=FALSE)
adddata <- read.csv("../data/bio/capelin_additional_tidy.csv")
nafo_na <- subset(adddata, is.na(adddata$nafo_zone))
nafo_na
```

Uh oh there is a lot. A bet a bunch of them are in the Hudson Strait (which is outside the NAFO Zone).Map the nafo_na points...
```{r}
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "Occurences missing a NAFO Zone", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(nafo_na$decimalLongitude, nafo_na$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
```
ok yes - Hudson Strait has many, but there are some near the coast that are probably just missed out due to minor differences in the point location/shapefile boundaries.
Start with the Hudson Strait ones as this is easy - anything above 56N, nafo_zone == "HudsonStrait"

```{r}
adddata$nafo_zone <- as.character(adddata$nafo_zone)
adddata[is.na(adddata)] <- "xx"
adddata$nafo_zone[adddata$nafo_zone == "xx" & adddata$decimalLatitude > 56] <- "HudsonStrait"
```
and map to check
```{r}
nafo_na <- subset(adddata, nafo_zone == "xx")
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "Occurences missing a NAFO Zone", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(nafo_na$decimalLongitude, nafo_na$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
```
so now i need to account for the others (either as occuring on land or just in an area that is missing a NAFO Zone tag) which is more tricky... i might just do this bit in ArcGIS quickly.
```{r}
write.csv(adddata, file = "../data/bio/capelin_additional_tidy.csv", row.names = FALSE) #just write all the data you have
```

So in ArcGIS I saw that some points are extremely close to the coast, but all lie in 4T.
```{r}
adddata$nafo_zone[adddata$nafo_zone == "xx"] <- "4T" #make all xx values 4T
nafo_na <- subset(adddata, nafo_zone == "xx")
plot(map2, xlim = c(-70, -43), ylim =c(38, 70), asp = 1, main = "Occurences missing a NAFO Zone", col = "cornsilk") #the x and y lim are the long-lat bounds of the map
points(nafo_na$decimalLongitude, nafo_na$decimalLatitude, col = "red") #this adds points to the mapet", xlab = "Longitude", ylab = "Latitude")
```
all sorted!

```{r}
write.csv(adddata, file = "../data/bio/capelin_additional_tidy.csv", row.names = FALSE)
```

#Gear type
To get this information, I need to look at the collectioncode details and the OBIS metadata for each resname and then add.
```{r}
adddata$gear <- "x" #create a new column called gear and populate with x
#now give a list of the resnames...
whichres <- unique(adddata$resname) #makes a variable of institutions
whichresordered <- sort(whichres) #just puts the list in 
whichresordered
```
[Arctic Species Trend Index (ASTI) : Marine](http://www.iobis.org/explore/#/dataset/4356). No gear details available
```{r}
asti <- subset(adddata, resname == "Arctic Species Trend Index (ASTI) : Marine")
asti$collectioncode <- as.character(asti$collectioncode)
asti_col <- unique(asti$collectioncode) #makes a variable of institutions
asti_colordered <- sort(asti_col) #just puts the list in 
asti_colordered
```
there is no information in the collection code. The Metadata on OBIS also gives no details. gear = NA
```{r}
adddata$gear[adddata$resname == "Arctic Species Trend Index (ASTI) : Marine"] <- "NA"
```

[Atlantic Reference Centre Museum of Canadian Atlantic Organisms - Invertebrates and Fishes Data](http://www.iobis.org/explore/#/dataset/29).
```{r}
arcm <- subset(adddata, resname == "Atlantic Reference Centre Museum of Canadian Atlantic Organisms - Invertebrates and Fishes Data")
arcm$collectioncode <- as.character(arcm$collectioncode)
arcm_col <- unique(arcm$collectioncode) #makes a variable of institutions
arcm_colordered <- sort(arcm_col) #just puts the list in 
arcm_colordered
```
No gear details in collectioncode. The Metadata on OBIS also gives no details. gear = NA 
```{r}
adddata$gear[adddata$resname == "Atlantic Reference Centre Museum of Canadian Atlantic Organisms - Invertebrates and Fishes Data"] <- "NA"
```

[Atlantic Zone Monitoring Program Maritimes Region (AZMP) plankton datasets. In: Fisheries and Oceans Canada - BioChem archive](http://iobis.org/explore/#/dataset/2328). 
```{r}
azmpmar <- subset(adddata, resname == "Atlantic Zone Monitoring Program Maritimes Region (AZMP) plankton datasets. In: Fisheries and Oceans Canada - BioChem archive")
azmpmar$collectioncode <- as.character(azmpmar$collectioncode)
azmpmar_col <- unique(azmpmar$collectioncode) #makes a variable of institutions
azmpmar_colordered <- sort(azmpmar_col) #just puts the list in 
azmpmar_colordered
```
No gear details in collectioncode. The metadata on OBIS indicates vertical plankton tow 
```{r}
adddata$gear[adddata$resname == "Atlantic Zone Monitoring Program Maritimes Region (AZMP) plankton datasets. In: Fisheries and Oceans Canada - BioChem archive"] <- "vertical_plankton_tow"
```

[BioChem zooplankton samples from the Gully, 2006-2007](http://iobis.org/explore/#/dataset/2327). 
```{r}
biogul <- subset(adddata, resname == "BioChem zooplankton samples from the Gully, 2006-2007")
biogul$collectioncode <- as.character(biogul$collectioncode)
biogul_col <- unique(biogul$collectioncode) #makes a variable of institutions
biogul_colordered <- sort(biogul_col) #just puts the list in 
biogul_colordered
```
Along with the OBIS metadata, indicates gear = vertical plankton tow
```{r}
adddata$gear[adddata$resname == "BioChem zooplankton samples from the Gully, 2006-2007"] <- "vertical_plankton_tow"
```

[BioChem: DFO Atlantic Zone Monitoring Program plankton datasets - Newfoundland and Labrador Region (OBIS Canada)](http://iobis.org/explore/#/dataset/2666). 
```{r}
azmpnl <- subset(adddata, resname == "BioChem: DFO Atlantic Zone Monitoring Program plankton datasets - Newfoundland and Labrador Region (OBIS Canada")
azmpnl$collectioncode <- as.character(azmpnl$collectioncode)
azmpnl_col <- unique(azmpnl$collectioncode) #makes a variable of institutions
azmpnl_colordered <- sort(azmpnl_col) #just puts the list in 
azmpnl_colordered
```
No details in collectioncode. Obis metadata indicates gear = vertical plankton tow
```{r}
adddata$gear[adddata$resname == "BioChem: DFO Atlantic Zone Monitoring Program plankton datasets - Newfoundland and Labrador Region (OBIS Canada)"] <- "vertical_plankton_tow"
```

[BioChem: Sameoto zooplankton collection](http://iobis.org/explore/#/dataset/2670).Vertical plankton tow
```{r}
biosam <- subset(adddata, resname == "BioChem: Sameoto zooplankton collection")
biosam$collectioncode <- as.character(biosam$collectioncode)
biosam_col <- unique(biosam$collectioncode) #makes a variable of institutions
biosam_colordered <- sort(biosam_col) #just puts the list in 
biosam_colordered
```
Insufficient details in collectioncode. Obis metadata indicates gear = vertical plankton tow
```{r}
adddata$gear[adddata$resname == "BioChem: Sameoto zooplankton collection"] <- "vertical_plankton_tow"
```

[DFO Central and Arctic Multi-species Stock Assessment Surveys](http://iobis.org/explore/#/dataset/2293). A
```{r}
dfocas <- subset(adddata, resname == "DFO Central and Arctic Multi-species Stock Assessment Surveys")
dfocas$collectioncode <- as.character(dfocas$collectioncode)
dfocas_col <- unique(dfocas$collectioncode) #makes a variable of institutions
dfocas_colordered <- sort(dfocas_col) #just puts the list in 
dfocas_colordered
```
ok these are all types of bottom trawl.
```{r}
adddata$gear[adddata$resname == "DFO Central and Arctic Multi-species Stock Assessment Surveys" & adddata$collectioncode == "DFOSurvey_Modified Alfredo-03"] <- "bottom_trawl_alfredo_03"
adddata$gear[adddata$resname == "DFO Central and Arctic Multi-species Stock Assessment Surveys" & adddata$collectioncode == "DFOSurvey_Modified Cosmos 2600"] <- "bottom_trawl_cosmos_2600"
adddata$gear[adddata$resname == "DFO Central and Arctic Multi-species Stock Assessment Surveys" & adddata$collectioncode == "DFOSurvey_Modified Modified (21\") Campelen"] <- "bottom_trawl_campelen_21"
adddata$gear[adddata$resname == "DFO Central and Arctic Multi-species Stock Assessment Surveys" & adddata$collectioncode == "DFOSurvey_Modified Standard (14\") Campelen"] <- "bottom_trawl_campelen_14"
```

[DFO Gulf Region Groundfish Research Vessel Surveys](bottom trawl).  
```{r}
dfogulfas <- subset(adddata, resname == "DFO Gulf Region Groundfish Research Vessel Surveys")
dfogulfas$collectioncode <- as.character(dfogulfas$collectioncode)
dfogulfas_col <- unique(dfogulfas$collectioncode) #makes a variable of institutions
dfogulfas_colordered <- sort(dfogulfas_col) #just puts the list in 
dfogulfas_colordered
```
no gear details in collection code. OBIS metadata indicates Three survey vessels and two types of bottom-trawls were used prior to 2003: the E. E. Prince from 1971-1985 using a Yankee 36 trawl, the Lady Hammond from 1985-1991 and the Alfred Needler from 1992-2002, both using a Western IIA trawl. Due to a fire on the Needler, the 2003 survey was conducted by its sister-ship, the Templeman using the Western IIA trawl. This survey started late and was incomplete. The survey was conducted by both the Needler and the Teleost in 2004 and 2005 and by the Teleost since then, using the Western IIA trawl. 
Note you have not captured ship information above so leave it out here. Your data is 1998 onwards to the gear for all = bottom_trawl_western_IIA
```{r}
adddata$gear[adddata$resname == "DFO Gulf Region Groundfish Research Vessel Surveys"] <- "bottom_trawl_western_IIA"
```

[DFO Maritimes Research Vessel Trawl Surveys Fish Observations](http://iobis.org/explore/#/dataset/237).
```{r}
dfomas <- subset(adddata, resname == "DFO Maritimes Research Vessel Trawl Surveys Fish Observations")
dfomas$collectioncode <- as.character(dfomas$collectioncode)
dfomas_col <- unique(dfomas$collectioncode) #makes a variable of institutions
dfomas_colordered <- sort(dfomas_col) #just puts the list in 
dfomas_colordered
```
insuffient information. OBIS metadata just indicates "a variety of trawl gear". gear = "bottom_trawl"
```{r}
adddata$gear[adddata$resname == "DFO Maritimes Research Vessel Trawl Surveys Fish Observations"] <- "bottom_trawl"
```

[DFO Newfoundland and Labrador Region Ecosystem Trawl Surveys](http://iobis.org/explore/#/dataset/2814)
```{r}
dfonas <- subset(adddata, resname == "DFO Newfoundland and Labrador Region Ecosystem Trawl Surveys")
dfonas$collectioncode <- as.character(dfonas$collectioncode)
dfonas_col <- unique(dfonas$collectioncode) #makes a variable of institutions
dfonas_colordered <- sort(dfonas_col) #just puts the list in 
dfonas_colordered
```
More useful, OBIS metadata indicates "Starting in the fall of 1995 surveys have been conducted using a Campelen 1800 trawl fitted with rock-hopper foot gear." gear = bottom_trawl_campelen_1800
```{r}
adddata$gear[adddata$resname == "DFO Newfoundland and Labrador Region Ecosystem Trawl Surveys"] <- "bottom_trawl_campelen_1800"
```

[DFO Quebec Region Multispecies bottom trawl surveys](http://iobis.org/explore/#/dataset/2542)
```{r}
dfoqas <- subset(adddata, resname == "DFO Quebec Region Multispecies bottom trawl surveys")
dfoqas$collectioncode <- as.character(dfoqas$collectioncode)
dfoqas_col <- unique(dfoqas$collectioncode) #makes a variable of institutions
dfoqas_colordered <- sort(dfoqas_col) #just puts the list in 
dfoqas_colordered
```
no gear details in collectioncode. OBIS metadata indicates Campelen 1800. gear = bottom_trawl_campelen_1800
```{r}
adddata$gear[adddata$resname == "DFO Quebec Region Multispecies bottom trawl surveys"] <- "bottom_trawl_campelen_1800"
```

[Fish specimens](http://iobis.org/explore/#/dataset/2417)
```{r}
fishsp <- subset(adddata, resname == "Fish specimens")
fishsp$collectioncode <- as.character(fishsp$collectioncode)
fishsp_col <- unique(fishsp$collectioncode) #makes a variable of institutions
fishsp_colordered <- sort(fishsp_col) #just puts the list in 
fishsp_colordered
```
no gear detail in collectioncode. OBIS metadata indicates these are museum records. gear = NA
```{r}
adddata$gear[adddata$resname == "Fish specimens"] <- "NA"
```

[Ichthyology Collection - Royal Ontario Museum](http://iobis.org/explore/#/dataset/3511)
```{r}
iccol <- subset(adddata, resname == "Ichthyology Collection - Royal Ontario Museum")
iccol$collectioncode <- as.character(iccol$collectioncode)
iccol_col <- unique(iccol$collectioncode) #makes a variable of institutions
iccol_colordered <- sort(iccol_col) #just puts the list in 
iccol_colordered
```
no gear details in collectioncode. OBIS metadata indicates museum records. gear = NA
```{r}
adddata$gear[adddata$resname == "Ichthyology Collection - Royal Ontario Museum"] <- "NA"
```

[Maine Department of Marine Resources Inshore Trawl Survey 2000â€“2009](http://iobis.org/explore/#/dataset/1693)
```{r}
mdmr <- subset(adddata, resname == "Maine Department of Marine Resources Inshore Trawl Survey 2000â€“2009")
mdmr$collectioncode <- as.character(mdmr$collectioncode)
mdmr_col <- unique(mdmr$collectioncode) #makes a variable of institutions
mdmr_colordered <- sort(mdmr_col) #just puts the list in 
mdmr_colordered
```
Insufficient infomation in collectioncode. OBIS metadata indicates "a modified version of the shrimp net used in Maine waters. It was designed by the vessel owner and net designer Jeff Flagg to fish for a variety of near-bottom dwelling species without targeting any specific component" gear-type = "bottom_trawl"
```{r}
adddata$gear[adddata$resname == "Maine Department of Marine Resources Inshore Trawl Survey 2000â€“2009"] <- "bottom_trawl"
```

[Northeast Fisheries Science Center Bottom Trawl Survey Data](http://iobis.org/explore/#/dataset/1435)
```{r}
nefsu <- subset(adddata, resname == "Northeast Fisheries Science Center Bottom Trawl Survey Data")
nefsu$collectioncode <- as.character(nefsu$collectioncode)
nefsu_col <- unique(nefsu$collectioncode) #makes a variable of institutions
nefsu_colordered <- sort(nefsu_col) #just puts the list in 
nefsu_colordered
```
insufficient detail in collection code. OBIS metadata indicates "bottom trawl gear". gear = "bottom_trawl"
```{r}
adddata$gear[adddata$resname == "Northeast Fisheries Science Center Bottom Trawl Survey Data"] <- "bottom_trawl"
```

[Northern Gulf of St. Lawrence Fishes](http://iobis.org/explore/#/dataset/2671)
```{r}
ngsl <- subset(adddata, resname == "Northern Gulf of St. Lawrence Fishes")
ngsl$collectioncode <- as.character(ngsl$collectioncode)
ngsl_col <- unique(ngsl$collectioncode) #makes a variable of institutions
ngsl_colordered <- sort(ngsl_col) #just puts the list in 
ngsl_colordered
```
no gear details in collectioncode. OBIS metadata indicates "Sampling methods used ranged from fish traps and seine nets on the coasts to offshore trawling". gear = NA
```{r}
adddata$gear[adddata$resname == "Northern Gulf of St. Lawrence Fishes"] <- "NA"
```

ok check to see if all of gear is done (ie if there are any x left)
```{r}
gearcheck <- subset(adddata, gear == "x")
gearcheck
```
yay - all done.

# see who sampled in which year and month

year
```{r}
inst_by_yr <- with(adddata, table(year, institutioncode))
write.csv(inst_by_yr, file = "../output/bio/institutioncode_by_yr.csv")
```

month
```{r}
inst_by_mt <- with(adddata, table(month, institutioncode))
write.csv(inst_by_mt, file = "../output/bio/institutioncode_by_mth.csv")
```

# create a unique cell ID

A unique cell ID layer has been created in the environmental_data_preperation.Rmd. Now you want to extract the value of that layer to the .csv you are creating...

Load the env. data - you can just use the glorys layer or the biomer layer as they are identical
```{r}
library(raster)
cell_layer <- raster("../output/env/glo_unique_cell.tif") #this is loading the cell layer that was created and saved as a tif
plot(cell_layer)
```
and just grab the attributes of the cell_layer
```{r}
cell_layer
```


The occurrence data needs to be converted into spatialpoints dataframe
```{r}
library(sp)
xy <- adddata[ ,c(3,2)] #3 = decimalLongitude, 2 = decimalLatitude
adddata_aea <- SpatialPointsDataFrame(coords = xy, data = adddata, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
adddata_aea
```




```{r}
adddata_aea <- spTransform(adddata_aea, CRS = "+proj=aea +lat_1=50 +lat_2=70 +lat_0=40 +lon_0=-60 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs") #note -60 used to be -91. Changed to 'straighten up'
adddata_aea
```

and plot and Write the transformed species data to a new csv (this will also have the coordinates in meters - note meters are under decimalLongitude1 and decimalLatitude1)...
```{r}
plot(adddata_aea, axes=TRUE, cex.axis=.95)
write.csv(adddata_aea, file = "../output/bio/data_aea.csv", row.names = FALSE)
```

Ok now plot the env. and point data...
```{r}
plot(cell_layer)
points(adddata_aea$decimalLongitude, adddata_aea$decimalLatitude)
```

ok now the next step is to extract the unique cell value and add to each of the points
then write a .csv
then convert back to a normal dataframe
```{r}
adddata_aea$cell_id <- extract(x=cell_layer, y = adddata_aea)
write.csv(adddata_aea, file = "../output/bio/data_aea_cell.csv", row.names = FALSE)
data_aea <- as.data.frame(adddata_aea)
head(data_aea)
```
looking at the header data, there seems to be some new columns created on the way...
```{r}
colnames(data_aea)
```
I don't want "optional" - get rid of it!
```{r}
data_aea <- subset(data_aea, select = -c(optional))
colnames(data_aea)
write.csv(adddata_aea, file = "../output/bio/data_aea_cell.csv", row.names = FALSE)
```

# Add AMO Data
The data has been prepared as per the environmental_data_preperation.Rmd

```{r}
amo <- read.csv("../output/env/amo.csv", header=TRUE)
head(amo)
```

So you want..
- AMO value at sampling month/year
- AMO value at previous sampling month/year
- AMO phase at previous winter (because the winter values are thought to be a major driver of ocean conditions in the following spring, summer, and autumn)

change month col names to numeric

```{r}
names(amo)[2:13] = c("1", "2","3", "4", "5", "6", "7", "8", "9", "10", "11", "12")
head(amo)
```


Start with the month data first...subset cols 1:13 (where the year and month data are held)
```{r}
amo_yrmt <- amo[ ,1:13]
amo_yrmt
```

```{r}
amo_yrmt <- reshape(amo_yrmt, 
  varying = c("1", "2","3", "4", "5", "6", "7", "8", "9", "10", "11", "12"),
  v.names = "value",
  direction = "long")

amo_yrmt <- amo_yrmt[order(amo_yrmt$year),]
amo_yrmt
```
rename time to month.. and value to amo_sample
```{r}
colnames(amo_yrmt)[2] <- "month"
colnames(amo_yrmt)[3] <- "amo_sample"
amo_yrmt
```

now match the year and the month in the two dataframes, and populate the species dataset (data_aea) with amo_sample
```{r}
data_aea <- merge(x = data_aea, y = amo_yrmt[ , c("year", "month", "amo_sample")], by = c("year", "month"), all.x = TRUE)
data_aea
```

ok next - AMO value at previous sampling month/year

shift the amo_sample column down by 1...
```{r}
library(useful)
amo_yrmt <- shift.column(data = amo_yrmt, columns = "amo_sample", up = FALSE)
amo_yrmt
```

Note the shifted values are in a new column called amo_sample.Shifted. rename to amo_prev
```{r}
colnames(amo_yrmt)[colnames(amo_yrmt)=="amo_sample.Shifted"] <- "amo_prev"
amo_yrmt
write.csv(amo_yrmt, "../output/env/amo_prev.csv", row.names = FALSE) #for some reason i need to write to a csv and reload for the next step to work properly
```

now grab the data...
```{r}
amo_prev <- read.csv("../output/env/amo_prev.csv")
data_aea <- merge(x = data_aea, y = amo_prev[ , c("year", "month", "amo_prev")], by = c("year", "month"), all.x = TRUE)
data_aea
```

and now - AMO phase at previous winter (because the winter values are thought to be a major driver of ocean conditions in the following spring, summer, and autumn)

same process as before - shift row then match

But first!

You need to extract the seasonal values from the amo dataset
```{r}
amo_winter <- subset(amo, select = c("year", "WinterAvg"))
amo_winter
```

now shift the winter average data 
```{r}
amo_winter <- shift.column(data = amo_winter, columns = "WinterAvg", up = FALSE)
amo_winter
write.csv(amo_winter, "../output/env/amo_winter.csv", row.names = FALSE) #for some reason need to save to csv then reload in the next step...
```
remember your shifted column is called WinterAvg.Shifted

now extract the WinterAvg.Shifted values to the species dataset
```{r}
amo_winter <- read.csv("../output/env/amo_winter.csv")
data_aea <- merge(x = data_aea, y = amo_winter[ , c("year", "WinterAvg.Shifted")], by = c("year"), all.x = TRUE)
colnames(data_aea)[colnames(data_aea)=="WinterAvg.Shifted"] <- "amo_winter" #change the colname
data_aea
```
ok and write a csv
```{r}
write.csv(data_aea,"../output/bio/data_aea_cell_amo.csv", row.names = FALSE)
```

#NAO values

The data has been prepared as per the environmental_data_preperation.Rmd

```{r}
nao <- read.csv("../output/env/nao.csv", header=TRUE)
head(nao)
```

So you want..
- NAO value at sampling month/year
- NAO value at previous sampling month/year
- NAO phase at previous winter (because the winter values are thought to be a major driver of ocean conditions in the following spring, summer, and autumn)

change month col names to just numeric
```{r}
names(nao)[2:13] = c("1", "2","3", "4", "5", "6", "7", "8", "9", "10", "11", "12")
head(nao)
```

Start with the month data first...subset cols 1:13 (where the year and month data are held)

```{r}
nao_yrmt <- nao[ ,1:13]
nao_yrmt
```

```{r}
nao_yrmt <- reshape(nao_yrmt, 
  varying = c("1", "2","3", "4", "5", "6", "7", "8", "9", "10", "11", "12"),
  v.names = "value",
  direction = "long")

nao_yrmt <- nao_yrmt[order(nao_yrmt$year),] #changed amo to nao
nao_yrmt
```

rename time to month.. and value to nao_sample

```{r}
colnames(nao_yrmt)[2] <- "month"
colnames(nao_yrmt)[3] <- "nao_sample"
nao_yrmt
```

now match the year and the month in the two dataframes, and populate the species dataset (data_aea) with nao_sample

```{r}
data_aea <- merge(x = data_aea, y = nao_yrmt[ , c("year", "month", "nao_sample")], by = c("year", "month"), all.x = TRUE)
data_aea
```

ok next - NAO value at previous sampling month/year

shift the nao_sample column down by 1...

```{r}
library(useful)
nao_yrmt <- shift.column(data = nao_yrmt, columns = "nao_sample", up = FALSE)
nao_yrmt
```

Note the shifted values are in a new column called amo_sample.Shifted. rename to amo_prev

```{r}
colnames(nao_yrmt)[colnames(nao_yrmt)=="nao_sample.Shifted"] <- "nao_prev"
nao_yrmt
write.csv(nao_yrmt, "../output/env/nao_prev.csv", row.names = FALSE) #for some reason i need to write to a csv and reload for the next step to work properly
```

now grab the data...

```{r}
nao_prev <- read.csv("../output/env/nao_prev.csv")
data_aea <- merge(x = data_aea, y = nao_prev[ , c("year", "month", "nao_prev")], by = c("year", "month"), all.x = TRUE)
data_aea
```

and now - NAO phase at previous winter (because the winter values are thought to be a major driver of ocean conditions in the following spring, summer, and autumn)

same process as before - shift row then match

But first!

You need to extract the seasonal values from the NAO dataset

```{r}
nao_winter <- subset(nao, select = c("year", "WinterAvg"))
nao_winter
```

now shift the winter average data

```{r}
nao_winter <- shift.column(data = nao_winter, columns = "WinterAvg", up = FALSE)
nao_winter
write.csv(nao_winter, "../output/env/nao_winter.csv", row.names = FALSE) #for some reason need to save to csv then reload in the next step...

```

remember your shifted column is called WinterAvg.Shifted

now extract the WinterAvg.Shifted values to the species dataset

```{r}
nao_winter <- read.csv("../output/env/nao_winter.csv")
data_aea <- merge(x = data_aea, y = nao_winter[ , c("year", "WinterAvg.Shifted")], by = c("year"), all.x = TRUE)
colnames(data_aea)[colnames(data_aea)=="WinterAvg.Shifted"] <- "nao_winter" #change the colname
data_aea
```

ok and write a csv

```{r}
write.csv(data_aea,"../output/bio/data_aea_cell_amo_nao.csv", row.names = FALSE)
```

# depth bins
the depth layers in the netCDF are literal slices. I want to attribute the observations with depth data to the nearest depth layer. I have created a .csv which lists all the depth layers, and then created depth bins with min and max values.

load the depth bin csv
```{r}
depthbin <- read.csv("../data/env/depth_bin.csv", header = TRUE) 
head(depthbin)

```

so what you want to do is look at the observation, see if it has a depth value (data_aea$depth) and if so, find the value that lies between depthbin$bin_min and depthbin$bin_max, then extract depthbin$layer_name and add to data_aea$depth_layer, and then extract depthbin$layer_no and add to data_aea$depthlayer_no

the depth data in data_aea is a factor. This needs to be numeric
```{r}
data_aea$depth <- as.integer(as.character(data_aea$depth))
str(data_aea)
```

make sure that the data_aea$depth without values == NA (currently they are marked xx)
```{r}
data_aea$depth[data_aea$depth == "xx"] <- NA #make all xx values NA
```

Now run some fancy if loop (courtesy of [TinglTanglBob] (https://stackoverflow.com/questions/52626995/problem-with-loop-to-add-values-from-one-dataframe-and-to-another-based-on-condi/52627728#52627728))
```{r}
check_depth <- function(d_temp)
{
  #print(d_temp)
  if(is.na(d_temp)) return(NA) # if d_temp is na just return NA 
  layer_name_temp <- depthbin$layer_name[which(depthbin$bin_min <= d_temp & depthbin$bin_max >= d_temp)]
  if(length(layer_name_temp) > 1) layer_name_temp <- layer_name_temp[1] # in case there are more hits, the first one is taken
  return(layer_name_temp)
}

data_aea$depth_layer <- sapply(data_aea$depth, check_depth)
```

ok now dow the same thing to get your layer_no
```{r}
check_depth2 <- function(d_temp)
{
  #print(d_temp)
  if(is.na(d_temp)) return(NA) # if d_temp is na just return NA 
  layer_no_temp <- depthbin$layer_no[which(depthbin$bin_min <= d_temp & depthbin$bin_max >= d_temp)]
  if(length(layer_no_temp) > 1) layer_no_temp <- layer_no_temp[1] # in case there are more hits, the first one is taken
  return(layer_no_temp)
}

data_aea$depthlayerno <- sapply(data_aea$depth, check_depth2)
```

and save

```{r}
write.csv(data_aea,"../output/bio/data_aea_cell_amo_nao_bins.csv", row.names = FALSE)
```


# observations by cell (in total, and also by time step)

as the title says... how many observations happeend in each cell:
- in total
- in each yyyymm

```{r observation by cell - total}
library(plyr) #to use the count function
obs_by_cell <- count(data_aea, "cell_id")
obs_by_cell
write.csv(obs_by_cell, file = "../output/bio/no_observations_cell.csv")
```


```{r}
obs_cell_yymm <- count(data_aea, c("cell_id", "year", "month"))
obs_cell_yymm
write.csv(obs_cell_yymm, file = "../output/bio/no_observations_cell_yymm.csv")
```
Now attach these values to data_aea....

total obs for the whole time period
```{r}
data_aea <- merge(data_aea, obs_by_cell, by="cell_id")
head(data_aea)
```
rename freq column to something meaningful

```{r}
names(data_aea)[names(data_aea)=="freq"] <- "total_cell_obs"
head(data_aea)
```


time-sliced
```{r}
data_aea <- merge(data_aea, obs_cell_yymm, by.x=c("cell_id", "year", "month"), by.y=c("cell_id", "year", "month"))
names(data_aea)[names(data_aea)=="freq"] <- "yymm_cell_obs"
head(data_aea)
```

write to .csv
```{r}
write.csv(data_aea,"../output/bio/data_aea_cell_amo_nao_bins_env_depth_cellobno.csv", row.names = FALSE)
```


# warm/cold year

The warm/cold year index will be taken from a [DFO CSAS report](http://www.dfo-mpo.gc.ca/csas-sccs/Publications/SAR-AS/2018/2018_039-eng.pdf) - Fig 8



